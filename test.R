rm(list = ls())

install.packages('tidyverse')
install.packages('patchwork')
install.packages("harmony")
install.packages("Seurat")
install.packages("devtools")

if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("topGO")
library(org.Hs.eg.db)

install.packages("curl")
install.packages("gert")
install.packages("gh")

install.packages("usethis")
install.packages("httr")
install.packages("rcmdcheck")
install.packages("rversions")
usethis
httr
rcmdcheck
rversions


library(ggplot2)
library(cowplot)
library(Matrix)
library(dplyr)
library(readr)
library(Seurat)
library(harmony)
library(tidyverse)
library(patchwork)
library(patchwork)
library(lemon)
library(MAST)
ulimit::memory_limit(100000)

setwd("/data03/HCB/HCB_temp/test/")
#########################################################################################################################数据处理
##聚类
{
  bm1 <- Read10X("/data03/HCB/aging/test/BoneMarrow/BM1/")
  bm2 <- Read10X("/data03/HCB/aging/test/BoneMarrow/BM2/")
  colnames(bm1) <- paste(colnames(bm1),"BM1",sep = "_")
  colnames(bm2) <- paste(colnames(bm2),"BM2",sep = "_")
  experiment.data <- cbind(bm1,bm2)
  #创建一个文件夹用于写分析结果
  sam.name <- "result"
  if(!dir.exists(sam.name)){
    dir.create(sam.name)
  }
  #### 3. 创建Seurat分析对象 ####
  scRNA <- CreateSeuratObject(
    experiment.data,
    project = "scRNA tutorial", 
    min.cells = 10,
    min.features = 200,
    names.field = 2,
    names.delim = "_")
  #计算线粒体基因比例
  scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
  #计算核糖体基因比例
  scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
  #计算红细胞基因比例
  HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
  HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
  scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
  
  table(scRNA$orig.ident)
  #########################################################################################################################质量控制
  ### 绘制质控小提琴图
  # 设置可能用到的主题
  theme.set2 = theme(axis.title.x=element_blank())
  # 设置绘图元素
  plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
  group = "orig.ident"
  # 质控前小提琴图
  plots = list()
  for(i in seq_along(plot.featrures)){
    plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                         features = plot.featrures[i]) + theme.set2 + NoLegend()}
  violin <- wrap_plots(plots = plots, nrow=2)    
  dir.create("QC")
  ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
  ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
  minGene=500
  maxUMI=20000
  pctMT=10
  pctHB=3
  ### 数据质控并绘制小提琴图
  scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & percent.mt < pctMT & percent.HB < pctHB)
  plots = list()
  for(i in seq_along(plot.featrures)){
    plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                         features = plot.featrures[i]) + theme.set2 + NoLegend()}
  violin <- wrap_plots(plots = plots, nrow=2)     
  ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
  
  ########################################################################################################################### 降维聚类
  #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
  scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
  #计算表达量变化显著的基因FindVariableFeatures
  scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
  scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
  scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
  ### 整合方法单个样本间进行整合（推荐，效果更好）
  scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident", plot_convergence = F,max.iter.harmony = 30) 
  saveRDS(scRNA, "scRNA.rds")
  
  #############################################聚类
  scRNA <- readRDS("scRNA.rds")
  dim.use <- 1:50
  scRNA <- scRNA %>%
    RunUMAP(reduction = "harmony", dims = dim.use) %>%
    FindNeighbors(reduction = "harmony", dims = dim.use) %>%
    FindClusters(resolution = 0.5) %>%
    identity()
  
  #按照聚类分组展示细胞异同
  pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"ump.pdf"),width = 20,height = 20)
  DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
  dev.off()
  write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"ump.txt"))
  #按照数据来源分组展示细胞异同
  pdf(paste0("./result/CellCluster-UMPPlot_SamGroup_",max(dim.use),"ump.pdf"),width = 20,height = 20)
  DimPlot(object = scRNA,reduction = "umap",group.by="orig.ident", pt.size=1,label = T,label.size = 10)
  dev.off()
  
  ####################查看marker基因相关性
  gene <- c("CSF1R", "CD74", "NRGN", "VCAN","FLT1","AMBP", "SPI1", "MRC1", "TMEM119", "CX3CR1", "CLDN5","VTN","GLUL","SOX9",
            "AQP4","GJA1","NDRG2","GFAP","ALDH1A1","ALDH1L1", "VIM", "PTGDS", "PDGFRA", "PCDH15", "OLIG2", "OLIG1", "PLP1", 
            "MAG", "MOG", "MOBP", "MBP", "SATB2", "SLC17A7", "SLC17A6", "GAD1", "GAD2", "SLC32A1", "SNAP25", "STMN2", "RBFOX3")
  
  gene_use <- gene[which(gene%in%rownames(scRNA))]
  gene_useless <- setdiff(gene,gene_use)
  cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
  pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 28,height = 12)
  DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
  dev.off()
  #################聚类命名
  scRNA <- RenameIdents(scRNA, `0` = "excitatory neurons", `1` = "excitatory neurons", `2` = "excitatory neurons", 
                        `3` = "excitatory neurons", `4` = "inhibitory neurons", `5` = "excitatory neurons", 
                        `6` = "inhibitory neurons", `7` = "excitatory neurons", `8` = "inhibitory neurons", 
                        `9` = "astrocytes", `10` = "excitatory neurons", `11` = "inhibitory neurons", 
                        `12` = "oligodendrocytes", `13` = "excitatory neurons", `14` = "astrocytes", 
                        `15` = "OPCs", `16` = "excitatory neurons", `17` = "endothelial cells", 
                        `18` = "inhibitory neurons", `19` = "astrocytes")
  saveRDS(scRNA, "scRNA.rds")
  
  #scRNA <- readRDS("scRNA.rds")
}

##差异表达
{
  scRNA <- readRDS("scRNA4.rds")
  cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
  unique(scRNA@meta.data[,"group"])
  if(!dir.exists(paste("./result/DEG/"))){
    dir.create(paste("./result/DEG/"))
  }
  #################mid-old
  if(!dir.exists(paste("./result/DEG/mid-old/"))){
    dir.create(paste("./result/DEG/mid-old/"))
  }
  for (i in 1:length(cluster)) {
    scRNA_temp <-subset(scRNA, idents = cluster[i])
    DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
    DEG = na.omit(DEG)#去除NA
    #画图
    logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
    DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                  ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
    write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
    this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                        '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                        '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
    png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
    p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
      geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
      xlab("log2 fold change") + ylab("-log10(P.value)") +
      ggtitle(this_tile) +
      scale_colour_manual(values = c('blue','black','red'))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
            axis.text.x = element_text(size = 40,  color = "black"),
            axis.text.y = element_text(size = 40,  color = "black"),
            legend.title= element_text(size=40),
            legend.text = element_text(size=40),
            plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
    print(p)
    dev.off()
  }
  #################youth-mid
  if(!dir.exists(paste("./result/DEG/youth-mid/"))){
    dir.create(paste("./result/DEG/youth-mid/"))
  }
  for (i in 1:length(cluster)) {
    scRNA_temp <-subset(scRNA, idents = cluster[i])
    DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
    DEG = na.omit(DEG)#去除NA
    #画图
    logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
    DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                  ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
    write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
    
    this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                        '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                        '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
    png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
    p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
      geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
      xlab("log2 fold change") + ylab("-log10(P.value)") +
      ggtitle(this_tile) +
      scale_colour_manual(values = c('blue','black','red'))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
            axis.text.x = element_text(size = 40,  color = "black"),
            axis.text.y = element_text(size = 40,  color = "black"),
            legend.title= element_text(size=40),
            legend.text = element_text(size=40),
            plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
    print(p)
    dev.off()
  }
  #################youth-old
  if(!dir.exists(paste("./result/DEG/youth-old/"))){
    dir.create(paste("./result/DEG/youth-old/"))
  }
  for (i in 1:length(cluster)) {
    scRNA_temp <-subset(scRNA, idents = cluster[i])
    DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
    DEG = na.omit(DEG)#去除NA
    #画图
    logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
    DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                  ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
    write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
    
    this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                        '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                        '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
    png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
    p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
      geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
      xlab("log2 fold change") + ylab("-log10(P.value)") +
      ggtitle(this_tile) +
      scale_colour_manual(values = c('blue','black','red'))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
            axis.text.x = element_text(size = 40,  color = "black"),
            axis.text.y = element_text(size = 40,  color = "black"),
            legend.title= element_text(size=40),
            legend.text = element_text(size=40),
            plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
    print(p)
    dev.off()
  }
  
}

##富集分析
{
  library(ggplot2)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
  if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
    dir.create(paste(filea,"DEG/GO/",sep = ""))
  }
  ##############mid-old
  if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
    dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
      if(length(Up_ID )>5){
        transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
      
      Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
      if(length(Down_ID)>5){
        transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
          p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                               axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
    }
  }
  
  ##############youth-mid
  if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
    dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-mid/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
      if(length(Up_ID)>5){
        transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                              axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
      
      Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
      if(length(Down_ID)>5){
        transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
          p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                               axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
        
      }
    }
  }
  
  ##############youth-old
  if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
    dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
      if(length(Up_ID)>5){
        transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                               axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
      
      Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
      if(length(Down_ID)>5){
        transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
        eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
        eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
          png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
          p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                               axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
    }
  }
  
}

##变异系数
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  library(ggpubr)
  library(Rcpp)
  sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/"
  
  if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
    dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
  }
  scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
  cluster <- unique(scRNA$ident)
  #############mid-old
  if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
    dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
  }
  {
    rowleng <- 2000
    gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
    rownames(gene_CV) <- VariableFeatures(scRNA)
    colnames(gene_CV) <- cluster
    for (i in 1:length(cluster)) {
      mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
      old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
      mid_counts = mid@assays$RNA@data
      old_counts = old@assays$RNA@data
      cat(cluster[i],": Start!","\n")
      for (j in 1:rowleng) {
        if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
        if((j %% 200) == 1){cat((j-1)/200+1)}
        if((j %% 40) == 0 & j<=1960){cat("-")}
        if(j == 2000){cat("|","\n")}
        gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
      }
    }
    write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
  }
  {
    fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
    colnames(fig) <- c("exp","cluster")
    for (i in 1:length(cluster)) {
      fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
      fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
    }
    fig <- na.omit(fig)
    png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
    p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                add.params = list(fill="white",size=0.5))+
      theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
      theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
            axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
    print(p)
    dev.off()
  }
  #############youth-mid
  if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
    dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
  }
  {
    rowleng <- 2000
    gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
    rownames(gene_CV) <- VariableFeatures(scRNA)
    colnames(gene_CV) <- cluster
    for (i in 1:length(cluster)) {
      mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
      youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
      mid_counts = mid@assays$RNA@data
      youth_counts = youth@assays$RNA@data
      cat(cluster[i],": Start!","\n")
      for (j in 1:rowleng) {
        if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
        if((j %% 200) == 1){cat((j-1)/200+1)}
        if((j %% 40) == 0 & j<=1960){cat("-")}
        if(j == 2000){cat("|","\n")}
        gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
      }
    }
    write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
  }
  {
    fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
    colnames(fig) <- c("exp","cluster")
    for (i in 1:length(cluster)) {
      fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
      fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
    }
    fig <- na.omit(fig)
    png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 2500,height = 1500)
    p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                add.params = list(fill="white",size=0.5))+
      theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
      theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
            axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
    print(p)
    dev.off()
  }
  #############youth-old
  if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))){
    dir.create(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))
  }
  {
    rowleng <- 2000
    gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
    rownames(gene_CV) <- VariableFeatures(scRNA)
    colnames(gene_CV) <- cluster
    for (i in 1:length(cluster)) {
      youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
      old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
      youth_counts = youth@assays$RNA@data
      old_counts = old@assays$RNA@data
      cat(cluster[i],": Start!","\n")
      for (j in 1:rowleng) {
        if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
        if((j %% 200) == 1){cat((j-1)/200+1)}
        if((j %% 40) == 0 & j<=1960){cat("-")}
        if(j == 2000){cat("|","\n")}
        gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(old_counts[j,]),youth_counts[j,],old_counts[j,]))
      }
    }
    write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.csv",sep = ""))
  }
  {
    fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
    colnames(fig) <- c("exp","cluster")
    for (i in 1:length(cluster)) {
      fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
      fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
    }
    fig <- na.omit(fig)
    png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 2500,height = 1500)
    p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                add.params = list(fill="white",size=0.5))+
      theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
      theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
            axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
    print(p)
    dev.off()
  }
  
}

##all 聚类
{
  {
    scRNA <- readRDS("/data03/HCB/aging/bladder/analysis/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/bladder.csv",row.names = F)
    rm(list=ls())
    
    scRNA <- readRDS("/data03/HCB/aging/blood/analsis/scRNA1.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/blood.csv",row.names = F)
    rm(list=ls())
    
    scRNA <- readRDS("/data03/HCB/aging/bone-marrow/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/bone-marrow.csv",row.names = F)
    rm(list=ls())
    
    
    scRNA <- readRDS("/data03/HCB/aging/brain/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/brain.csv",row.names = F)
    rm(list=ls())
    
    
    scRNA <- readRDS("/data03/HCB/aging/kidney/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/kidney.csv",row.names = F)
    rm(list=ls())
    
    
    scRNA <- readRDS("/data03/HCB/aging/liver/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/liver.csv",row.names = F)
    rm(list=ls())
    
    scRNA <- readRDS("/data03/HCB/aging/lung/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/lung.csv",row.names = F)
    rm(list=ls())  
    
    scRNA <- readRDS("/data03/HCB/aging/Pancreas/analysis/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/pancreas.csv",row.names = F)
    rm(list=ls())  
    
    
    scRNA <- readRDS("/data03/HCB/aging/prostate/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/prostate.csv",row.names = F)
    rm(list=ls())  
    
    
    scRNA <- readRDS("/data03/HCB/aging/retina/result/scRNA5.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/retina.csv",row.names = F)
    rm(list=ls())
    
    scRNA <- readRDS("/data03/HCB/aging/skeletal-muscle/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/skeletal-muscle.csv",row.names = F)
    rm(list=ls()) 
    
    
    scRNA <- readRDS("/data03/HCB/aging/skin/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/skin.csv",row.names = F)
    rm(list=ls()) 
    
    
    scRNA <- readRDS("/data03/HCB/aging/stomach/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/stomach.csv",row.names = F)
    rm(list=ls()) 
    
    scRNA <- readRDS("/data03/HCB/aging/testis/analysis/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data03/HCB/aging/ALL/testis.csv",row.names = F)
    rm(list=ls()) 
    
    scRNA <- readRDS("/data/HCB/aging/heart/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data/HCB/aging/heart.csv",row.names = F)
    rm(list=ls()) 
    
    scRNA <- readRDS("/data/HCB/aging/ileum/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data/HCB/aging/ileum.csv",row.names = F)
    rm(list=ls()) 
    
    scRNA <- readRDS("/data/HCB/aging/oesophagus/scRNA4.rds")
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    write.csv(UmapTsne,"/data/HCB/aging/oesophagus.csv",row.names = F)
    rm(list=ls()) 
    
    filenames <- list.files()
    for (i in 1:length(filenames)) {
      if(i==1){
        result <- read.csv(filenames[i],header = T)
        result[,7] <- rep(strsplit(x=filenames[i],split='[.]')[[1]][1],length(rownames(result)))
        colnames(result)[7] <- "Tissue"
      }
      if(i>1){
        temp <- read.csv(filenames[i],header = T)
        temp[,7] <- rep(strsplit(x=filenames[i],split='[.]')[[1]][1],length(rownames(temp)))
        colnames(temp)[7] <- "Tissue"
        result <- rbind(result,temp)
      }
    }
    write.csv(result,"result1.csv")
  }
  ##############################Cluster图
  {
    value_temp <-c("#CC6699","#CC33CC", "#6699CC","#FFCC00",  "#33CCCC","#FF3366","#FF33FF", "#9933CC", "#663300", "#99FF99",
                   "#993366","#CC99FF", "#666699", "#FF6600","#009966","#CC0066","#9900CC")
    
    for (i in 1:17) {
      temp <- result[which(result[,"Tissue"]==strsplit(x=filenames[i],split='[.]')[[1]][1]),]
      pdf(paste0("./UMAP/",strsplit(x=filenames[i],split='[.]')[[1]][1],"_UMAP.pdf",sep=""),width = 20,height = 20)
      umap <- ggplot()+ geom_point(data=temp, aes(y = UMAP_2, x = UMAP_1),color = value_temp[i],size = 0.2, alpha = 1)+
        labs(x=NULL,y=NULL)+theme(panel.grid.major = element_blank(),axis.ticks.x = element_blank(),axis.ticks.y = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_blank(), panel.background = element_rect(fill="white"),
              axis.text.y = element_blank(),legend.position="none")
      print(umap)
      dev.off()
    }
    
  }
  ##############################Group图
  {
    value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066","supold"="darkred")
    png(paste0("./CellGroup.png"),width = 5400,height = 2700)
    umap <- ggplot()+ geom_point(data=result, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=result, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne,position='bottom')
    dev.off()
    
    value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF","supold"="#FFFFFF")
    png(paste0("./CellGroup1.png"),width = 5400,height = 2700)
    umap <- ggplot()+ geom_point(data=result, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=result, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    
    value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF","supold"="#FFFFFF")
    png(paste0("./CellGroup2.png"),width = 5400,height = 2700)
    umap <- ggplot()+ geom_point(data=result, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=result, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    
    value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066","supold"="#FFFFFF")
    png(paste0("./CellGroup3.png"),width = 5400,height = 2700)
    umap <- ggplot()+ geom_point(data=result, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=result, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    
    value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#FFFFFF","supold"="darkred")
    png(paste0("./CellGroup4.png"),width = 5400,height = 2700)
    umap <- ggplot()+ geom_point(data=result, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=result, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
      scale_color_manual(values=value_temp1)+
      guides(colour = guide_legend(title="Group",override.aes = list(size=8),ncol = 9,byrow = TRUE,reverse = T))+
      theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
  }
  
}

##转录因子
##scenic
{
  {
    ###########################环境！！！！！！！！！！！！！！！！
    cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
      export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
      export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
      R
      ###R
      library(plyr)
      library(permute)
      library(SCopeLoomR)
      library(SCENIC)
      library(ggplot2)
      library(cowplot)
      library(Matrix)
      library(dplyr)
      library(readr)
      library(Seurat)
      library(harmony)
      library(tidyverse)
      library(patchwork)
      library(patchwork)
      library(lemon)
      library(MAST)
      
      filea <- "/data03/HCB/aging/Pancreas/analysis/"
      
      if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
        dir.create(paste(filea,"result/Scenic/",sep = ""))
      }
      scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
      #############mid_old
      if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
        dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
      }
      {
        filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
            temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
          }else{
            DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
            temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            temp1 <- c(temp1,temp2)
          }
        }
        DEG <- unique(temp1)
        exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
        
        Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
        colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
        Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
        Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
        Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
        rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
        data <- as.matrix(exp@assays$RNA@data)
        scenicOptions <- initializeScenic(
          org="hgnc", # 物种名 or hgnc, or dmel
          dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
          dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
          datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
          nCores=1
        )
        genesKept <- geneFiltering(
          exprMat=data, 
          scenicOptions=scenicOptions,
          minCountsPerGene = 1,
          minSamples = 20
        )
        data <- data[genesKept,]
        colnames(data) <- rownames(Cell_info)
        source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
        source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
        avg20.rep <- AvgN(data, Cell_info, seed=1)
        saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
        saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
        loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
        loom <- add_cellAnnotation(loom, Cell_info)
        close_loom(loom)
      }
      #############youth_mid
      if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
        dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
      }
      {
        filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
            temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
          }else{
            DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
            temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            temp1 <- c(temp1,temp2)
          }
        }
        DEG <- unique(temp1)
        exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
        
        Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
        colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
        Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
        Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
        Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
        rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
        data <- as.matrix(exp@assays$RNA@data)
        scenicOptions <- initializeScenic(
          org="hgnc", # 物种名 or hgnc, or dmel
          dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
          dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
          datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
          nCores=1
        )
        genesKept <- geneFiltering(
          exprMat=data, 
          scenicOptions=scenicOptions,
          minCountsPerGene = 1,
          minSamples = 20
        )
        data <- data[genesKept,]
        source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
        source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
        avg20.rep <- AvgN(data, Cell_info, seed=1)
        saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
        saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
        loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
        loom <- add_cellAnnotation(loom, Cell_info)
        close_loom(loom)
        
      }
      #############youth_old
      if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
        dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
      }
      {
        filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
            temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
          }else{
            DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
            temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            temp1 <- c(temp1,temp2)
          }
        }
        DEG <- unique(temp1)
        exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
        
        Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
        colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
        Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
        Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
        Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
        rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
        data <- as.matrix(exp@assays$RNA@data)
        scenicOptions <- initializeScenic(
          org="hgnc", # 物种名 or hgnc, or dmel
          dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
          dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
          datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
          nCores=1
        )
        genesKept <- geneFiltering(
          exprMat=data, 
          scenicOptions=scenicOptions,
          minCountsPerGene = 1,
          minSamples = 20
        )
        data <- data[genesKept,]
        source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
        source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
        avg20.rep <- AvgN(data, Cell_info, seed=1)
        saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
        saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
        loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
        loom <- add_cellAnnotation(loom, Cell_info)
        close_loom(loom)
      }
  }
  
  {
    cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/mid_old/
    mkdir output
    bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
    cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/mid_old/
      bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
    
    R
    {
      options(stringsAsFactors = FALSE)
      library(data.table)
      library(pbapply)
      library(philentropy)
      library(ggrepel)
      library(latex2exp)
      library(ggplot2)
      library(plyr)
      library(ggsci)
      cell.info <- readRDS("Cell_info.rds")
      rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
      rownames(rasMat) <- rasMat$V1
      colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
      rasMat <- rasMat[, -1]
      saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
      cell.types <- names(table(cell.info$Cell_Type))
      ctMat <- lapply(cell.types, function(i) {
        as.numeric(cell.info$Cell_Type == i)
      })
      ctMat <- do.call(cbind, ctMat)
      colnames(ctMat) <- cell.types
      rownames(ctMat) <- rownames(cell.info)
      rssMat <- pblapply(colnames(rasMat), function(i) {
        sapply(colnames(ctMat), function(j) {
          1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
        })
      })
      rssMat <- do.call(rbind, rssMat)
      rownames(rssMat) <- colnames(rasMat)
      colnames(rssMat) <- colnames(ctMat)
      write.table(rssMat,"./output/rssMat.txt")
      q()
    }
    
  }
  {
    cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_mid/
      mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
    cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_mid/
      bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
    R
    {
      options(stringsAsFactors = FALSE)
      library(data.table)
      library(pbapply)
      library(philentropy)
      library(ggrepel)
      library(latex2exp)
      library(ggplot2)
      library(plyr)
      library(ggsci)
      cell.info <- readRDS("Cell_info.rds")
      rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
      rownames(rasMat) <- rasMat$V1
      colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
      rasMat <- rasMat[, -1]
      saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
      cell.types <- names(table(cell.info$Cell_Type))
      ctMat <- lapply(cell.types, function(i) {
        as.numeric(cell.info$Cell_Type == i)
      })
      ctMat <- do.call(cbind, ctMat)
      colnames(ctMat) <- cell.types
      rownames(ctMat) <- rownames(cell.info)
      rssMat <- pblapply(colnames(rasMat), function(i) {
        sapply(colnames(ctMat), function(j) {
          1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
        })
      })
      rssMat <- do.call(rbind, rssMat)
      rownames(rssMat) <- colnames(rasMat)
      colnames(rssMat) <- colnames(ctMat)
      write.table(rssMat,"./output/rssMat.txt")
      q()
    }
  }
  {
    cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_old/
      mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
    cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_old/
      bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
    
    R
    {
      options(stringsAsFactors = FALSE)
      library(data.table)
      library(pbapply)
      library(philentropy)
      library(ggrepel)
      library(latex2exp)
      library(ggplot2)
      library(plyr)
      library(ggsci)
      cell.info <- readRDS("Cell_info.rds")
      rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
      rownames(rasMat) <- rasMat$V1
      colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
      rasMat <- rasMat[, -1]
      saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
      cell.types <- names(table(cell.info$Cell_Type))
      ctMat <- lapply(cell.types, function(i) {
        as.numeric(cell.info$Cell_Type == i)
      })
      ctMat <- do.call(cbind, ctMat)
      colnames(ctMat) <- cell.types
      rownames(ctMat) <- rownames(cell.info)
      rssMat <- pblapply(colnames(rasMat), function(i) {
        sapply(colnames(ctMat), function(j) {
          1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
        })
      })
      rssMat <- do.call(rbind, rssMat)
      rownames(rssMat) <- colnames(rasMat)
      colnames(rssMat) <- colnames(ctMat)
      write.table(rssMat,"./output/rssMat.txt")
      q()
    }
  }
}
##hTFtarget
{
  tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
  tf <- tf[,-3]
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
  if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
    dir.create(paste(filea,"hTFTarget/",sep = ""))
  }
  ##############mid-old
  if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
    dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
    }
  }
  
  ##############youth-mid
  if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
    dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-mid/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
    }
  }
  
  ##############youth-old
  if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
    dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
    }
  }
  
  
}
##TRRUST2
{
  tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
  if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
    dir.create(paste(filea,"TRRUST2/",sep = ""))
  }
  ##############mid-old
  if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
    dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
    }
  }
  
  ##############youth-mid
  if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
    dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-mid/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
    }
  }
  
  ##############youth-old
  if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
    dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
  }
  {
    setwd(paste(filea,"DEG/youth-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    for (i in 1:length(rownames(temp))) {
      ID <- read.table(temp[i,1])
      Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
      a <- tf[which(tf[,1]%in%Up_ID),]
      write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
    }
  }
  
}

####scenic富集分析
{
  library(ggplot2)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/"
  if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
    dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
  }
  #############mid_old
  if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
    dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
  }
  {
    tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
    for (i in 1:dim(tfs)[1]) {
      gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
      if(length(gene)>5){
        eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
          png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
            theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
    }
  }
  #############youth_old
  if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
    dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
  }
  {
    tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
    for (i in 1:dim(tfs)[1]) {
      gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
      if(length(gene)>5){
        eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
          png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
            theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
    }
  }
  #############youth_mid
  if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
    dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
  }
  {
    tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
    for (i in 1:dim(tfs)[1]) {
      gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
      if(length(gene)>5){
        eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
        if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
          write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
          png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
          p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
            theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
          print(p)
          dev.off()
        }
      }
    }
  }
  
}

#####衰老数据库
{
  CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
  CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
  HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
  temp <- union(CSGene[,2],CellAge[,2])
  temp <- union(temp,HCSGD[,1])
  AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
  colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
  AgeData[,1] <- temp
  for (i in 1:length(temp)) {
    if(AgeData[i,1]%in%CSGene[,2]){
      AgeData[i,2] = "Yes"
    }
    if(AgeData[i,1]%in%CellAge[,2]){
      AgeData[i,3] = "Yes"
    }
    if(AgeData[i,1]%in%HCSGD[,1]){
      AgeData[i,4] = "Yes"
    }
  }
  write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
  
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/"
  scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
  
  {
    ########mid-old
    {
      setwd(paste(filea,"result/DEG/mid-old",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:dim(temp)[1]) {
        if(i==1){
          deg <- read.table(temp[i,1])
          gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
        }
        deg <- read.table(temp[i,1])
        gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        gene_temp <- unique(gene_temp)
      }
    }
    ########youth-old
    {
      setwd(paste(filea,"result/DEG/youth-old",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:dim(temp)[1]) {
        deg <- read.table(temp[i,1])
        gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
      }
      gene_temp <- unique(gene_temp)
    }
    ########youth-mid
    {
      setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:dim(temp)[1]) {
        deg <- read.table(temp[i,1])
        gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
      }
      gene_temp <- unique(gene_temp)
    }
  }
  gene_temp <- intersect(gene_temp,AgeData[,1])
  result <- scRNA@meta.data[,c("group","ident")] 
  result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
  result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  

  if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
    dir.create(paste(filea,"result/database_web/",sep = ""))
  }
  write.csv(result,paste(filea,"result/database_web/pancreas.csv",sep = ""))
  
}

########markerc差异表达
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  
  filea <- "/data03/HCB/aging/Pancreas/analysis/"
  scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
  
  if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
    dir.create(paste(filea,"result/makerDEG/",sep=""))
  }
  
  celltype <- unique(scRNA@meta.data[,"ident"])
  gene <- read.csv("/data03/HCB/aging/marker/pancreas.csv")
  gene <- gene[,c(1,3)]
  colnames(gene) <- c("Cell Type","Marker Gene")
  gene[,1] %in%celltype
  celltype%in%gene[,1]

  a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
  gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
  colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
  for (i in 1:dim(gene)[1]) {
    temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
    if(dim(temp)[1]==1){
      gene[i,3:7] <- temp[1:5]
    }
  }
  length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
  
  gene <- gene[which(is.na(gene[,4])==FALSE),]
  write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
}

 
##########aging database overlap
{
  library("jsonlite")
  gene <- jsonlite::fromJSON("E:/衰老/test/aging database/export.json")
  temp <- gene[,1:3]
  write.csv(temp,"E:/衰老/test/aging database/opengenes.csv",row.names=F)
  
  temp <- read.csv("E:/衰老/test/aging database/datas1.csv")
  gene<- unique(temp[,9])
  temp <- read.csv("E:/衰老/test/aging database/Digital.csv")
  gene <- c(gene,temp[,1])
  temp <- read.csv("E:/衰老/test/aging database/genage_human.csv")
  gene <- c(gene,temp[,2])
  temp <- read.csv("E:/衰老/test/aging database/opengenes.csv")
  gene <- c(gene,temp[,3])
  temp <- read.csv("E:/衰老/test/aging database/tableExport.csv")
  gene <- c(gene,temp[,1])
  temp <- read.csv("E:/衰老/test/aging database/amigo.csv")
  gene <- c(gene,temp[,3])
  gene <- unique(gene)
  
  #write.csv(gene,"E:/衰老/test/aging database/gene_overlap.csv")
  res <- as.data.frame(array(NA,dim=c(17,6)))
  colnames(res) <- c("tissue","UP_n","DOWN_n","UP","DOWN","count")
  
  arr <- list.files("E:/衰老数据库结果_1/")
  for (s in 15:17) {
    filea <-  paste("E:/衰老数据库结果_1/",arr[s],"/差异分析1/",sep="")
    res[s,1] <- arr[s]
    filenames1 <- list.files(filea)
    Up <- "XXXXXXX"
    Down <- "XXXXXXX"
    for (temp1 in filenames1) {
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (temp2 in temp[,1]) {
        temp3 <- read.table(paste(filea,temp1,"/",temp2,sep=""))
        Up <- c(Up,row.names(temp3)[which(temp3[,"change"]=="UP")])
        Down <- c(Down,row.names(temp3)[which(temp3[,"change"]=="DOWN")])
      }
    }
    res[s,2] <- length(Up)-1
    res[s,3] <- length(Down)-1
    res[s,4] <- length(intersect(Up,gene))
    res[s,5] <- length(intersect(Down,gene))
    res[s,6] <- res[s,4]+res[s,5]
  }

  write.csv(res,"E:/衰老/arr.csv")
}


###########统计细胞数量
{
  fileb <- "/data03/HCB/aging/Pancreas/analysis/"
  
  scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
  
  celltype <- unique(scRNA@meta.data[,"ident"])
  gene <- read.csv("/data03/HCB/aging/marker/pancreas.csv")
  gene <- gene[,c(1,3)]
  
  colnames(gene) <- c("Cell Type","Marker Gene")
  gene[,1] %in%celltype
  celltype%in%gene[,1]
  
  res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
  rownames(res) <- c(celltype,"COUNT")
  colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
  g <- unique(scRNA@meta.data[,"group"])
  for (i in 1:length(celltype)) {
    res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
    res[i,2] <- length(which(gene[,1]==celltype[i]))
    for(t in g){
      res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
    }
  }
  res <- res[,c("cell_number","marker_number",g)]
  for(i in colnames(res)){
    res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
  }
  
  write.csv(res,"/data03/HCB/aging/cell_number/pancreas.csv")
}



#######统计可查询的基因列表
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  #marker  单独统计
  {
    filenames <- list.files("E:/衰老/marker/marker")
    for(i in 2:length(filenames)){
      temp <- read.csv(paste("E:/衰老/marker/marker/",filenames[i],sep=""))
      gene <- c(gene,temp[,"Gene"])
    }
    gene <- unique(gene)
  }

  #DEG
  {
    arr <- list.files("E:/衰老数据库结果_1/")
    for (s in 1:17) {
      filea <-  paste("E:/衰老数据库结果_1/",arr[s],"/差异分析1/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (temp2 in temp[,1]) {
          temp3 <- read.table(paste(filea,temp1,"/",temp2,sep=""))
          gene <- c(gene,row.names(temp3)[which(temp3[,"change"]%in% c("UP","DOWN"))])
        }
      }
    } 
    gene <- unique(gene)
  }
  #scenic tf
  {
    arr <- list.files("E:/衰老数据库结果_1/")
    for (s in 1:17) {
      filea <-  paste("E:/衰老数据库结果_1/",arr[s],"/Scenic/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        temp <- read.table(paste(filea,temp1,"/s3_avg20_rep.regulons.txt",sep=""))
        for (i in 1:dim(temp)[1]) {
          gene <- c(gene,strsplit(x=temp[i,1],split='[(]')[[1]][1])
          gene <- c(gene,strsplit(x=temp[i,3],split='[,]')[[1]])
        }
      }
    } 
    gene <- unique(gene)
  }
  #CV  
  {
    arr <- list.files("E:/衰老数据库结果_1/")
    for (s in 1:17) {
      filea <-  paste("E:/衰老数据库结果_1/",arr[s],"/变异系数/GeneCV/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="csv"),]
        for (temp2 in temp[,1]) {
          temp3 <- read.csv(paste(filea,temp1,"/",temp2,sep=""))
          gene <- c(gene,temp3[,1])
        }
      }
    } 
    gene <- unique(gene)
  }
  
  write.csv(gene,"E:/衰老数据库结果_1/websearchgenelist.csv")
   

  
}



##########################################重跑
{
  "/data03/HCB/aging/aging-gene/gene_overlap.csv"
  ##富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    gene_overlap <- read.csv("/data03/HCB/aging/aging-gene/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    
    arr <- list.files("/data03/HCB/aging/衰老数据库结果_2/")
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      filea <-  paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/差异分析1/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        
        for (i in 1:length(rownames(temp))) {
          cat(temp[i,3],"   ")
          ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""))
          Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
          Up_ID <- intersect(Up_ID,gene_overlap)
          if(length(Up_ID)>5){
            transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
            eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
            eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
            if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
              a <- as.data.frame(eGo_ALL@result)
              a <- cbind(a,array("2022/4/26",dim=c(dim(a)[1],2)))
              colnames(a)[c(dim(a)[2]-1,dim(a)[2])] <- c("time1","time2")
              write.csv(a,file= paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/富集分析1/GO/",temp1,"/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
              png(file= paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/富集分析1/GO/",temp1,"/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 1000,height = 800)
              p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
                theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),
                      axis.title.x =element_text(size=15))
              print(p)
              dev.off()
            }
          }
          
          Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
          Down_ID <- intersect(Down_ID,gene_overlap)
          if(length(Down_ID)>5){
            transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
            eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
            eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
            if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
              a <- as.data.frame(eGo_ALL@result)
              a <- cbind(a,array("2022/4/26",dim=c(dim(a)[1],2)))
              colnames(a)[c(dim(a)[2]-1,dim(a)[2])] <- c("time1","time2")
              write.csv(a, 
                        file= paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/富集分析1/GO/",temp1,"/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
              png(file= paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/富集分析1/GO/",temp1,"/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 1000,height = 800)
              p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
                theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),
                      axis.title.x =element_text(size=15))
              print(p)
              dev.off()
            }
          }
        }
        cat("\n")
      }
    } 
    
  } 
    
  ##细胞间通讯
  {
    gene_overlap <- read.csv("E:/衰老/test/aging database/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    
    arr <- list.files("E:/衰老/细胞间通讯")
    for (i in arr) {
      temp1 <- list.files(paste("E:/衰老/细胞间通讯/",i,sep=""))
      temp <- read.csv(paste("E:/衰老/细胞间通讯/",i,"/",temp1,sep=""))
      temp <- temp[which(temp[,"gene_a"]!="" & temp[,"gene_b"]!="" & (temp[,"gene_a"]%in%gene_overlap | temp[,"gene_b"]%in%gene_overlap)),]
      write.csv(temp,paste("E:/衰老/细胞间通讯/",i,"/",temp1,sep=""),row.names=F)
    }
    
    
    
  }

  ##三个衰老数据库的表达结果
  {
    gene_overlap <- read.csv("/data03/HCB/aging/aging-gene/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    gene_overlap <- c('group','ident','UMAP_1','UMAP_2',gene_overlap)
    
    arr <- list.files("/data03/HCB/aging/database_web/")
    for (i in arr) {
      temp <- read.csv(i,header = T,row.names=1)
      temp <- temp[,which(colnames(temp)%in%gene_overlap)]
      write.csv(temp,i)
    }
    
  }
  
  #gene_summary
  {
    gene_summary <- read.csv("E:/衰老数据库结果_2/gene_summary.csv")

    AgeData <- read.csv("E:/衰老数据库结果_2/AgeData.csv")
    
    gene_summary <- cbind(gene_summary,array("",dim=c(8972,2)))
    colnames(gene_summary)[6:7] <- c("PUBMED_link","IsInAgingDatabase")
    for(i in 1:8972){
      if(gene_summary[i,1]%in%AgeData[,1]){
        gene_summary[i,7] == "True"
      }else{
        gene_summary[i,7] == "False"
      }
      
    }
    
    length(intersect(gene_summary[i,1],AgeData[,1])) 
    
    gene_summary <- distinct(gene_summary,patient_ID,.keep_all = T)
    gene_summary <- gene_summary[,]

    
  }
  
  gene_list <- list("a")
  gene_list[[1]]
  gene_list[[2]] <- c("b1","b2","b3","b4")
  gene_list[[3]] <- c("c1","c2")
  names(gene_list)[1] <- "膀胱"
  names(gene_list)[2] <- "心脏"
  names(gene_list)[3] <- "肺" 
  names(gene_list)
  gene_list[["膀胱"]]
  
  ####组织基因处理
  {
    gene_overlap <- read.csv("/data03/HCB/aging/aging-gene/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    
    arr <- list.files("/data03/HCB/aging/衰老数据库结果_2/")
    
    
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      res = 1
      filea <-  paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/差异分析1/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        
        for (i in 1:length(rownames(temp))) {
          cat(temp[i,3],"   ")
          
          if(res==1){
            ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""))
            ID <- ID[which(rownames(ID)%in%gene_overlap &  ID[,'change']%in% c("UP","DOWN")),]
            ID <- cbind(rownames(ID),ID)
            colnames(ID)[1] <- "gene"
            rownames(ID) <- 1:dim(ID)[1]
            ID <- cbind(ID,rep(temp[i,3],dim(ID)[1]))
            colnames(ID)[dim(ID)[2]] <- "cell_type"
            ans = ID
            res = res + 1
          }else{
            ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""))
            ID <- ID[which(rownames(ID)%in%gene_overlap &  ID[,'change']%in% c("UP","DOWN")),]
            ID <- cbind(rownames(ID),ID)
            colnames(ID)[1] <- "gene"
            rownames(ID) <- 1:dim(ID)[1]
            ID <- cbind(ID,rep(temp[i,3],dim(ID)[1]))
            colnames(ID)[dim(ID)[2]] <- "cell_type"
            ans = rbind(ans,ID)
          }
        }
        cat("\n")
      }
      if(!dir.exists(paste("/data03/HCB/aging/specific_gene/",arr[s],"/",sep=""))){
        dir.create(paste("/data03/HCB/aging/specific_gene/",arr[s],"/",sep=""))
      }
      write.csv(ans,paste("/data03/HCB/aging/specific_gene/",arr[s],"/specific_gene.csv",sep=""))
    } 
    
    arr <- list.files("/data03/HCB/aging/specific_gene/")
    gene_list <- list("a")
    for (i in 1:length(arr)) {
      temp <- read.csv(paste("/data03/HCB/aging/specific_gene/",arr[i],"/specific_gene.csv",sep=""),row.names=1)
      temp <- temp[,1]
      gene_list[[i]] <- c(temp)
    }
    names(gene_list) <- arr
    for (t in 1:length(arr)) {
      temp <- read.csv(paste("/data03/HCB/aging/specific_gene/",arr[t],"/specific_gene.csv",sep=""),row.names=1)
      temp <- cbind(temp,array("true",dim=c(dim(temp)[1],2)))
      colnames(temp)[9:10] <- c("isTissueUnique","isCellTypeUnique")
      
      for (i in 1:dim(temp)[1]) {
        rogene <- temp[i,1]
        for (j in 1:length(arr)) {
          if(j!=t){
            gene <- gene_list[[j]]
            if(rogene %in%gene){
              temp[i,9] <- "false"
              break
            }
          }
        }
      }
      write.csv(temp,paste("/data03/HCB/aging/specific_gene/",arr[t],"/specific_gene.csv",sep=""))
      
    }
    
    
    for (t in 1:length(arr)) {
      temp <- read.csv(paste("/data03/HCB/aging/specific_gene/",arr[t],"/specific_gene.csv",sep=""),row.names=1)
      
      type <- unique(temp[,8])
      
      for (i in 1:length(type)) {
        a <- type[i]
        b <- temp[which(temp[,8]!=a),1]
        for (j in 1:dim(temp)[1]) {
          if(temp[j,8]==a & temp[j,1]%in%b){
            temp[j,10] <- "false"
          }
        }
      }
      write.csv(temp,paste("/data03/HCB/aging/specific_gene/",arr[t],"/specific_gene_r.csv",sep=""))
      
    }
    
    for (t in 1:length(arr)) {
      temp <- read.csv(paste("/data03/HCB/aging/specific_gene/",arr[t],"/specific_gene.csv",sep=""),row.names=1)
      cat (arr[t],"  ",dim(temp)[1],"  ",length(unique(temp[,1])),"\n")
      
    }
    
  }
  
  ###########变异系数
  {
    gene_overlap <- read.csv("E:/衰老/test/aging database/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    
    arr <- list.files("E:/衰老数据库结果_2")
    arr <- arr[7:23]

    for (s in 2:17) {
      cat(s,"  ",arr[s],"\n")
      filea <-  paste("E:/衰老数据库结果_2/",arr[s],"/变异系数/GeneCV/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[.]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="csv"),]
        
        for (i in 1:length(rownames(temp))) {
          cat(temp[i,3],"   ")
          ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""),row.names=1)
          ID <- ID[which(rownames(ID)%in%gene_overlap),]
          ll=dim(ID)[1]
          
          fig <- as.data.frame(array(NA,dim = c(ll*dim(ID)[2],2)))
          colnames(fig) <- c("exp","cluster")
          for (ii in 1:dim(ID)[2]) {
            fig[((ii-1)*ll+1):(ii*ll),1] <- ID[,ii]
            fig[((ii-1)*ll+1):(ii*ll),2] <- rep(colnames(ID)[ii],ll)
          }
          fig <- na.omit(fig)
          
          png(file=  paste(filea,temp1,"/",temp[i,3],".png",sep=""),width = 2500,height = 1500)
          p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                      add.params = list(fill="white",size=0.5))+
            theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
            theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
                  axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
          print(p)
          dev.off()
          write.csv(ID, paste(filea,temp1,"/",temp[i,3],".csv",sep=""))
        }
        cat("\n")
      }
    } 
    
  }
  
  ##细胞间通讯统计
  {
    arr <- list.files("E:/衰老/细胞间通讯")
    
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      filea <-  paste("E:/衰老/细胞间通讯/",arr[s],sep="")
      filenames <- list.files(filea)
      temp <- read.csv(paste("E:/衰老/细胞间通讯/",arr[s],"/",filenames,sep=""))
      
      temp1 <- distinct(temp,cell.type_a,cell.type_b,.keep_all = TRUE)
      temp1 <- temp1[,c("cell.type_a","cell.type_b")] 
      temp2 <- temp1[1,]
      for(i in 2:dim(temp1)[1]){
        q = 1
        for(j in 1:dim(temp2)[1]){
          if((temp1[i,1]==temp2[j,1] & temp1[i,2]==temp2[j,2]) | (temp1[i,1]==temp2[j,2] & temp1[i,2]==temp2[j,1])){
            q=0
            break
          }
        }
        if(q==1){
          temp2 <- rbind(temp2,temp1[i,])
        }
        
      }
      
      temp3 <- unique(temp[,"group"])
      
      res <- array(NA,dim=c(2+dim(temp2)[1],3*length(temp3)))
      
      for(i in 1:length(temp3)){
        res[1,((i-1)*3+1):((i-1)*3+3)] <- temp3[i]
        res[2,((i-1)*3+1):((i-1)*3+3)] <- c("SOURCE","TARGET","count")
        for(j in 1:dim(temp2)[1]){
          res[j+2,((i-1)*3+1)] <- temp2[j,1]
          res[j+2,((i-1)*3+2)] <- temp2[j,2]
          a <- temp[which(temp[,"group"]==temp3[i] & ((temp[,"cell.type_a"]==temp2[j,1] & temp[,"cell.type_b"]==temp2[j,2])|(
            temp[,"cell.type_a"]==temp2[j,2] & temp[,"cell.type_b"]==temp2[j,1]))),]
          res[j+2,((i-1)*3+3)] <- dim(a)[1]
        }
      }
      write.csv(res,paste("E:/衰老数据库结果_2/细胞间通讯/",filenames,sep=""))
      
    } 
  }
  
  
  #specif gene  统计
  {
    res <- array(NA,dim=c(17,3))
    colnames(res) <- c("true","all","%")
    arr <- list.files("E:/衰老数据库结果_2/specific_gene")
    for (s in 1:17) {
      filea <-  paste("E:/衰老数据库结果_2/specific_gene/",arr[s],"/specific_gene_r.csv",sep="")
      temp <- read.csv(filea)
      res[s,2] <- dim(temp)[1]
      temp <- temp[which(temp[,"isTissueUnique"]=="true"),]
      res[s,1] <- dim(temp)[1]
    } 
    rownames(res) <- arr
    res[,3] <- res[,1]/res[,2]
    write.csv(res,"E:/衰老数据库结果_2/specific_gene/统计.csv")
  }
  
  gene_summary <- read.csv("E:/衰老数据库结果_2/gene_summary.csv")
  colnames(gene_summary)
  gene_summary <- distinct(gene_summary,gene_name,ENTREZGENE_ACC,description,.keep_all = TRUE)
  write.csv(gene_summary,"E:/衰老数据库结果_2/gene_summary.csv")
  
  ##deg  overlap
  {
    gene_overlap <- read.csv("/data03/HCB/aging/aging-gene/gene_overlap.csv")
    gene_overlap <- gene_overlap[,2]
    
    arr <- list.files("/data03/HCB/aging/衰老数据库结果_2/")
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      
      if(!dir.exists(paste("/data03/HCB/aging/DEG_overlap/",arr[s],sep=""))){
        dir.create(paste("/data03/HCB/aging/DEG_overlap/",arr[s],sep=""))
      }
      
      filea <-  paste("/data03/HCB/aging/衰老数据库结果_2/",arr[s],"/差异分析1/",sep="")
      filenames1 <- list.files(filea)
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        if(!dir.exists(paste("/data03/HCB/aging/DEG_overlap/",arr[s],"/",temp1,sep=""))){
          dir.create(paste("/data03/HCB/aging/DEG_overlap/",arr[s],"/",temp1,sep=""))
        }
        
        filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
        temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
        temp[,1] <- filenames2
        for (i in 1:length(filenames2)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
          temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        
        for (i in 1:length(rownames(temp))) {
          cat(temp[i,3],"   ")
          ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""))
          ID <- ID[which(rownames(ID)%in%gene_overlap & ID[,'change']%in% c("UP","DOWN")),]
          write.csv(ID,paste("/data03/HCB/aging/DEG_overlap/",arr[s],"/",temp1,"/",temp[i,3],"_DEG_overlap.csv",sep=""))
        }
        cat("\n")
      }
    } 
    
  }
  
  ########疾病overlap
  {
    temp <- read_tsv("/data03/HCB/aging/疾病/all_gene_disease_pmid_associations.tsv/all_gene_disease_pmid_associations.tsv")
    write.csv(temp,"/data03/HCB/aging/疾病/all_gene_disease_pmid_associations.tsv/all_gene_disease_pmid_associations.csv",row.names=F)
    disease <- read.csv("/data03/HCB/aging/疾病/all_gene_disease_pmid_associations.tsv/all_gene_disease_pmid_associations.csv")
    
    arr <- list.files("/data03/HCB/aging/DEG_overlap/")
    
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      
      if(!dir.exists(paste("/data03/HCB/aging/disease_overlap/",arr[s],sep=""))){
        dir.create(paste("/data03/HCB/aging/disease_overlap/",arr[s],sep=""))
      }
      
      filea <-  paste("/data03/HCB/aging/DEG_overlap/",arr[s],sep="")
      filenames1 <- list.files(filea)
      
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        if(!dir.exists(paste("/data03/HCB/aging/disease_overlap/",arr[s],"/",temp1,sep=""))){
          dir.create(paste("/data03/HCB/aging/disease_overlap/",arr[s],"/",temp1,sep=""))
        }
        
        filenames2 <- list.files(paste(filea,"/",temp1,"/",sep=""))
        
        for (i in 1:length(filenames2)) {
          a <- read.csv(paste(filea,"/",temp1,"/",filenames2[i],sep=""),row.names=1)
          ID <- disease[which(disease[,2]%in%rownames(a)),]

          write.csv(ID,paste("/data03/HCB/aging/disease_overlap/",arr[s],"/",temp1,"/",filenames2[i],sep=""))
        }
        cat("\n")
      }
    } 
      
  }
  
  ##药物
  {
    uniport <- read.csv("E:/衰老/test/drugbank/uniprot links.csv")
    gene <- read.csv("E:/衰老/test/drugbank/gProfiler_hsapiens_2022-5-19 09-04-14.csv")
    gene <- distinct(gene,initial_alias,.keep_all = TRUE)
    uniport <- cbind(uniport,rep(NA,dim(uniport)[1]))
    colnames(uniport)[6] <- "gene"
    for(i in 1:dim(uniport)[1]){
      uniport[i,6] <- gene[which(gene[,1]==uniport[i,4]),3]
    }
    
    structure <- read.csv("E:/衰老/test/drugbank/structure links.csv")
    
    uniport <- cbind(uniport,rep(NA,dim(uniport)[1]))
    colnames(uniport)[7] <- "Drug status"
    uniport <- uniport[which(uniport[,1]%in%structure[,1]),]
    for(i in 1:dim(uniport)[1]){
      uniport[i,7] <- structure[which(structure[,1]==uniport[i,1]),4]
    }
    res <- uniport[,c(6,4,1,2,5,3,7)]
    

    
    colnames(res) <- c("Gene","UniProtACC","DrugBankID","Drug name","Drug activity","Drug type","Drug status")
  
    arr <- list.files("E:/衰老数据库结果_4/DEG_overlap/")
    
    for (s in 1:17) {
      cat(s,"  ",arr[s],"\n")
      
      if(!dir.exists(paste("E:/衰老数据库结果_4/drug_overlap/",arr[s],sep=""))){
        dir.create(paste("E:/衰老数据库结果_4/drug_overlap/",arr[s],sep=""))
      }
      
      filea <-  paste("E:/衰老数据库结果_4/DEG_overlap/",arr[s],sep="")
      filenames1 <- list.files(filea)
      
      for (temp1 in filenames1) {
        cat(temp1,"\n")
        if(!dir.exists(paste("E:/衰老数据库结果_4/drug_overlap/",arr[s],"/",temp1,sep=""))){
          dir.create(paste("E:/衰老数据库结果_4/drug_overlap/",arr[s],"/",temp1,sep=""))
        }
        
        filenames2 <- list.files(paste(filea,"/",temp1,"/",sep=""))
        
        for (i in 1:length(filenames2)) {
          a <- read.csv(paste(filea,"/",temp1,"/",filenames2[i],sep=""),row.names=1)
          
          ID <- res[which(res[,1]%in%rownames(a)),]
          
          write.csv(ID,paste("E:/衰老数据库结果_4/drug_overlap/",arr[s],"/",temp1,"/",filenames2[i],sep=""),row.names=F)
        }
        cat("\n")
      }
    } 
    
  }

  
  
  
  
}


#################################数据整合
Tissue <- array(NA,dim=c(17,3))
Tissue[1,] <- c("前列腺","prostate","Prostate")
Tissue[2,] <- c("心脏","heart","Heart")
Tissue[3,] <- c("皮肤","skin","Skin")
Tissue[4,] <- c("睾丸","testis","Testis")
Tissue[5,] <- c("视网膜","retina","Retina")
Tissue[6,] <- c("肝脏","liver","Liver")
Tissue[7,] <- c("肠道组织","intestine","Intestine")
Tissue[8,] <- c("肺","lung","Lung")
Tissue[9,] <- c("肾","kidneys","Kidneys")
Tissue[10,] <- c("胃","stomach","Stomach")
Tissue[11,] <- c("胰腺","pancreas","Pancreas")
Tissue[12,] <- c("脑","brain","Brain")
Tissue[13,] <- c("膀胱","bladder","Bladder")
Tissue[14,] <- c("血液","blood","Blood")
Tissue[15,] <- c("食道","oesophagus","Oesophagus")
Tissue[16,] <- c("骨骼肌","skeletal-muscle","Skeletal-muscle")
Tissue[17,] <- c("骨髓","bone-marrow","Bone-marrow")
Group <- array(NA,dim=c(6,3))
Group[1,] <- c("mid-old","mid_old","mid vs old")
Group[2,] <- c("mid-supold","mid_supold","mid vs supold")
Group[3,] <- c("old-supold","old_supold","old vs supold")
Group[4,] <- c("youth-old","youth_old","youth vs old")
Group[5,] <- c("youth-mid","youth_mid","youth vs mid")
Group[6,] <- c("youth-supold","youth_supold","youth vs supold")




Tissue1 <- c("Bladder","Intestine","Lung","Liver","Testis","Skeletal-muscle","Bone-marrow","Brain","Skin",
             "Prostate","Kidneys","Oesophagus","Retina","Stomach","Heart","Blood","Pancreas" )

Tissue2 <- c("Bladder","Intestine","Lung","Liver","Skeletal-muscle","Bone-marrow","Brain","Skin",
             "Prostate","Kidneys","Oesophagus","Retina","Stomach","Heart","Blood","Pancreas", "Testis",)


  

####cell marker
{
  arr <- list.files("E:/数据整合/cell marker/marker")
  for (s in 1:17) {

    temp <- read.csv(paste("E:/数据整合/cell marker/marker/",arr[s],sep=""))
    temp <- temp[,1:3]
    for(i in 1:dim(temp)[1]){
      temp[i,2] <- paste(temp[i,1],"cell",sep=" ")
      temp[i,1] <- Tissue[i]
    }
    temp[,1] <- Tissue[s]
    
    if(s==1){
      res = temp
    }else{
      res = rbind(res,temp)
    }
  } 
  
  write.csv(res,"E:/数据整合/cell marker/marker.csv",row.names=F)
}

####cell number
{
  arr <- list.files("E:/数据整合/cell number/cell_number")
  res <- array("",dim=c(2,8))
  colnames(res) <- c("Tissue","cell_type","cell_number","marker_number","youth","mid","old","supold")

  for (s in 1:17) {
    temp <- read.csv(paste("E:/数据整合/cell number/cell_number/",arr[s],sep=""))
    temp <- temp[-dim(temp)[1],]
    temp1 <- array("",dim=c(dim(temp)[1],8))
    colnames(temp1) <- c("Tissue","cell_type","cell_number","marker_number","youth","mid","old","supold")
    temp1[,1] <- Tissue[s]
    for(i in 1:dim(temp)[1]){
      temp1[i,2] <- paste(temp[i,1],"cell",sep=" ")
    }
    temp1[,3] <- temp[,2]
    temp1[,4] <- temp[,3]
    temp2 <- colnames(temp)[4:dim(temp)[2]]
    for(i in 1:length(temp2)){
      temp1[,temp2[i]] <- temp[,temp2[i]]
    }
    res = rbind(res,temp1)
  } 
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/cell number/cell_number.csv",row.names=F)
}

####database web
{
  arr <- list.files("E:/衰老数据库结果_4/database_web")
  for (s in 1:17) {
    temp <- read.csv(paste("E:/衰老数据库结果_4/database_web/",arr[s],sep=""))
    for(i in 1:dim(temp)[1]){
      temp[i,3] <- paste(temp[i,3],"cell",sep=" ")
    }
    colnames(temp)[1] <- "barcode"
    write.csv(temp,paste("E:/数据整合/database web/",Tissue[s],".csv",sep=""),row.names=F)
  } 
  
  {
    arr <- list.files("/data03/HCB/data/database web/")
    
    ans <- array("",dim=c(2,6))
    colnames(ans) <- c("Tissue","barcode",	"group",	"cell_type", "description","result")
    
    for (s in 1:17) {
      temp <- read.csv(paste("/data03/HCB/data/database web/",arr[s],sep=""))
      res <- temp[,1:3]
   
      b <- colnames(temp)[4]
      for(i in 5:dim(temp)[2]){
        b <- paste(b,";",colnames(temp)[i],sep="")
      }
      a <- c("**","**","**","data_name",b)
      
      res <- cbind(res,rep("data",dim(res)[1]))
      res <- cbind(res,rep(NA,dim(res)[1]))
      res <- rbind(a,res)
       
      for(i in 1:dim(temp)[1]){
        b <- temp[i,4]
        for(j in 5:dim(temp)[2]){
          b <- paste(b,";",temp[i,j],sep="")
        }
        res[i+1,5] <- b
      }
      
      res <- cbind(rep(strsplit(x=arr[s],split='[.]')[[1]][1],dim(res)[1]),res)
      colnames(res) <- c("Tissue","barcode",	"group",	"cell_type", "description","result")
      
      ans = rbind(ans,res)
    } 
    ans <- ans[-1:-2,]
    
    write.csv(ans,"/data03/HCB/data/database_web.csv",row.names=F)
    write.csv(temp,"/data03/HCB/data/database_web.csv",row.names=F)
  }
  
  
}

####deg overlap
{
  arr <- list.files("E:/数据整合/deg overlap/DEG_overlap")
  res <- array("",dim=c(2,10))
  colnames(res) <- c("Tissue","group","cell_type","gene","p_val","avg_log2FC","pct.1","pct.2","p_val_adj","change")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/数据整合/deg overlap/DEG_overlap/",arr[s],"/",sep="")
    filenames1 <- list.files(filea)
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        ID <- cbind(rep( paste(temp[i,3]," cell",sep=""),dim(ID)[1]),ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue2[s],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group","cell_type","gene","p_val","avg_log2FC","pct.1","pct.2","p_val_adj","change")
        res <- rbind(res,ID)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/deg overlap/deg_overlap.csv",row.names=F)
}

####disease overlap
{
  arr <- list.files("/data03/HCB/aging/disease_overlap/")
  res <- array("",dim=c(2,18))
  colnames(res) <- c("Tissue","group","cell_type","geneId",	"geneSymbol",	"DSI",	"DPI",	
                     "diseaseId",	"diseaseName",	"diseaseType",	"diseaseClass",	"diseaseSemanticType",	
                     "score",	"EI",	"YearInitial",	"YearFinal",	"pmid",	"source")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("/data03/HCB/aging/disease_overlap/",arr[s],"/",sep="")
    filenames1 <- list.files(filea)
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        ID <- ID[,2:16]
        ID <- cbind(rep( paste(temp[i,3]," cell",sep=""),dim(ID)[1]),ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[which(Tissue[,1]==arr[s]),3],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group","cell_type","geneId",	"geneSymbol",	"DSI",	"DPI",	
                          "diseaseId",	"diseaseName",	"diseaseType",	"diseaseClass",	"diseaseSemanticType",	
                          "score",	"EI",	"YearInitial",	"YearFinal",	"pmid",	"source")
        res <- rbind(res,ID)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"/data03/HCB/aging/disease_overlap.csv",row.names=F)
}

####drug overlap
{
  arr <- list.files("E:/数据整合/drug overlap/drug_overlap/")
  res <- array("",dim=c(2,10))
  colnames(res) <- c("Tissue","group","cell_type",  "Gene",	"UniProtACC",
                     "DrugBankID",	"Drug name",	"Drug activity",	"Drug type",	"Drug status")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/数据整合/drug overlap/drug_overlap/",arr[s],"/",sep="")
    filenames1 <- list.files(filea)
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        ID <- cbind(rep( paste(temp[i,3]," cell",sep=""),dim(ID)[1]),ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[which(Tissue[,1]==arr[s]),3],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group","cell_type",  "Gene",	"UniProtACC",
                          "DrugBankID",	"Drug name",	"Drug activity",	"Drug type",	"Drug status")
        res <- rbind(res,ID)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/drug overlap/drug_overlap.csv",row.names=F)
}

####specific_gene
{
  arr <- list.files("E:/数据整合/specific gene/specific_gene/")
  res <- array("",dim=c(2,11))
  colnames(res) <- c("Tissue","cell_type",  "Gene","p_val",	"avg_log2FC",	"pct.1",	"pct.2",
                     "p_val_adj",	"change",	"isTissueUnique",	"isCellTypeUnique")
  cc = 0
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")

    ID <- read.csv(paste("E:/数据整合/specific gene/specific_gene/",arr[s],"/specific_gene_r.csv",sep=""),row.names=1)
    ID <- ID[,c(8,1,2,3,4,5,6,7,9,10)]
    for(i in 1:dim(ID)[1]){
      ID[i,1] <- paste(ID[i,1]," cell",sep="")
    }
    ID <- cbind(rep( Tissue[which(Tissue[,1]==arr[s]),3],dim(ID)[1]),ID)
    colnames(ID) <- c("Tissue","cell_type",  "Gene","p_val",	"avg_log2FC",	"pct.1",	"pct.2",
                      "p_val_adj",	"change",	"isTissueUnique",	"isCellTypeUnique")
    cc = cc+dim(ID)[1]
    res <- rbind(res,ID)
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/specific gene/specific_gene.csv",row.names=F)
}

####聚类
{
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/聚类/",sep="")
    filenames1 <- list.files(filea)
    
    if(!dir.exists(paste("E:/数据整合/cluster fig/",Tissue[s,3],sep=""))){
      dir.create(paste("E:/数据整合/cluster fig/",Tissue[s,3],sep=""))
    }
    
    for (temp1 in filenames1) {
      file.copy(from = paste("E:/衰老数据库结果_4/",Tissue[s,1],"/聚类/",temp1,sep=""),
                to = paste("E:/数据整合/cluster fig/",Tissue[s,3],"/",temp1,sep=""))
      cat("\n")
    }
  }  
  
}

####富集
{
  res <- array("",dim=c(2,16))
  colnames(res) <- c("Tissue","group","cell_type","UpOrDown","ONTOLOGY",	
                     "ID",	"Description",	"GeneRatio"	,"BgRatio",	"pvalue",	
                     "p.adjust",	"qvalue",	"geneID",	"Count", "time1",	"time2")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/富集分析1/GO/",sep="")
    
    filenames1 <- list.files(filea)
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),4)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
        a <- strsplit(x=temp[i,1],split='[_]')[[1]]
        a <- a[length(a)]
        temp[i,4] <- strsplit(x=a,split='[.]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        
        ID <- cbind(rep( temp[i,4],dim(ID)[1]),ID)
        ID <- cbind(rep( paste(temp[i,3]," cell",sep=""),dim(ID)[1]),ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[s,3],dim(ID)[1]),ID)
        if (! "time1"%in%colnames(ID)){
          ID <- cbind(ID,rep("2022/4/26",dim(ID)[1]))
          ID <- cbind(ID,rep("2022/4/26",dim(ID)[1]))
        }
        colnames(ID) <- c("Tissue","group","cell_type","UpOrDown","ONTOLOGY",	
                          "ID",	"Description",	"GeneRatio"	,"BgRatio",	"pvalue",	
                          "p.adjust",	"qvalue",	"geneID",	"Count", "time1",	"time2")
        res <- rbind(res,ID)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合_1/enrichment overlap(无需改动)/enrichment_overlap.csv",row.names=F)
}

####变异系数
{
  res <- array("",dim=c(2,5))
  colnames(res) <- c("Tissue","group","cell_type","Gene","Result")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/变异系数/GeneCV/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),2)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        cc <- array(NA,dim=c(dim(ID)[1]*(dim(ID)[2]-1),3))
        for (j in 2:dim(ID)[2]) {
          cc[((j-2)*dim(ID)[1]+1):((j-1)*dim(ID)[1]),1] <- paste(gsub("[.]"," ",colnames(ID)[j])," cell",sep="")   
          cc[((j-2)*dim(ID)[1]+1):((j-1)*dim(ID)[1]),2] <- ID[,1]
          cc[((j-2)*dim(ID)[1]+1):((j-1)*dim(ID)[1]),3] <- ID[,j]
        }
        cc <- na.omit(cc)
        cc <- cbind(rep( Group[which(Group[,2]==temp1),3],dim(cc)[1]),cc)
        cc <- cbind(rep( Tissue[s,3],dim(cc)[1]),cc)
        colnames(cc) <- c("Tissue","group","cell_type","Gene","Result")
        res <- rbind(res,cc)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/gene CV/gene_CV.csv",row.names=F)
}


####scenic
{
  res <- array("",dim=c(2,6))
  colnames(res) <- c("Tissue","group","TF","Targets_number","image_URL","Targets")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/Scenic/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      ID <- read.table(paste(filea,temp1,"/s3_avg20_rep.regulons.txt",sep=""))
      for(j in 1:dim(ID)[1]){
        ID[j,3] <- gsub(",",";",ID[j,3])
      }
      
      ID <- cbind(ID[,1],ID)
      for(j in 1:dim(ID)[1]){
        ID[j,1] <- strsplit(x=ID[j,1],split='[(]')[[1]][1]
        ID[j,2] <- strsplit(x=ID[j,2],split='[(]')[[1]][2] 
        ID[j,2] <- strsplit(x=ID[j,2],split='g')[[1]][1]
      }
      
      ID <- cbind(rep( Group[which(Group[,2]==temp1),3],dim(ID)[1]),ID)
      ID <- cbind(rep( Tissue[s,3],dim(ID)[1]),ID)
      colnames(ID) <- c("Tissue","group","TF","Targets_number","image_URL","Targets")
      res <- rbind(res,ID)
    }
    cat("\n")
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/Scenic/TF.csv",row.names=F)
  
  rrr <- res
  
  res <- array("",dim=c(2,8))
  colnames(res) <- c("Tissue","group","cell_type","TF","rss_value","Targets_number","image_URL","Targets")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/Scenic/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      ID <- read.table(paste(filea,temp1,"/rssMat.txt",sep=""))
      cc <- array(NA,dim=c(dim(ID)[1]*(dim(ID)[2]),3))
      for (j in 1:dim(ID)[2]) {
        cc[((j-1)*dim(ID)[1]+1):((j)*dim(ID)[1]),1] <- paste(gsub("[.]"," ",colnames(ID)[j])," cell",sep="")   
        cc[((j-1)*dim(ID)[1]+1):((j)*dim(ID)[1]),2] <- rownames(ID)
        cc[((j-1)*dim(ID)[1]+1):((j)*dim(ID)[1]),3] <- ID[,j]
      }
      cc <- cbind(rep( Group[which(Group[,2]==temp1),3],dim(cc)[1]),cc)
      cc <- cbind(rep( Tissue[s,3],dim(cc)[1]),cc)
      colnames(cc) <- c("Tissue","group","cell_type","TF","rss_value")
      
      cc <- cbind(cc,array(NA,dim=c(dim(cc)[1],3)))
      
      for (j in 1:dim(cc)[1]) {
        cc[j,6] <- rrr[which(rrr[,1]==cc[j,1] & rrr[,2]==cc[j,2] & rrr[,3]==cc[j,4]),4]
        cc[j,7] <- rrr[which(rrr[,1]==cc[j,1] & rrr[,2]==cc[j,2] & rrr[,3]==cc[j,4]),5]
        cc[j,8] <- rrr[which(rrr[,1]==cc[j,1] & rrr[,2]==cc[j,2] & rrr[,3]==cc[j,4]),6]
      }
      colnames(cc) <- c("Tissue","group","cell_type","TF","rss_value","Targets_number","image_URL","Targets")
      
      res <- rbind(res,cc)
    }
    cat("\n")
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/Scenic/scenic.csv",row.names=F)
  
  
}

#####scenic_enrichment
{
  res <- array("",dim=c(2,13))
  colnames(res) <- c("Tissue","group", "TF","ONTOLOGY",	"ID",	"Description",
                     "GeneRatio",	"BgRatio",	"pvalue",	"p.adjust",	"qvalue",	"geneID",	"Count"	)
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/Scenic_enrichment/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <- strsplit(x=temp[i,1],split='[_]')[[1]][2]
        temp[i,3] <- strsplit(x=temp[i,3],split='[(]')[[1]][1]
        
      }
      temp <- temp[which(temp[,2]=="csv"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.csv(paste(filea,temp1,"/",temp[i,1],sep=""))
        for(j in 1:dim(ID)[1]){
          ID[j,9] <- gsub("[/]",";",ID[j,9])
        }
        ID <- cbind(rep(temp[i,3],dim(ID)[1]),ID)
        ID <- cbind(rep( Group[which(Group[,2]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[s,3],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group", "TF","ONTOLOGY",	"ID",	"Description",
                          "GeneRatio",	"BgRatio",	"pvalue",	"p.adjust",	"qvalue",	"geneID",	"Count"	)
        res <- rbind(res,ID)
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/scenic enrichment/scenic_enrichment.csv",row.names=F)
}

#####hTFTarget
{
  res <- array("",dim=c(2,5))
  colnames(res) <- c("Tissue","group","cell_type", "TF","Target")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/hTFTarget/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <- strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt" & 	temp[,3]!="rssMat.txt"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""),header=T)
        ID <-  ID[,1:2]
        ID <- cbind(rep(paste(temp[i,3]," cell",sep=""),dim(ID)[1]) ,ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[s,3],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group","cell_type", "TF","Target")
        res <- rbind(res,ID)
        
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/hTFTarget/hTFTarget.csv",row.names=F)
  
}

#####TRRUST2Target
{
  res <- array("",dim=c(2,7))
  colnames(res) <- c("Tissue","group","cell_type", "TF","Target","Mode.of.Regulation","References.PMID.")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/",Tissue[s,1],"/TRRUST2/",sep="")
    filenames1 <- list.files(filea)
    
    for (temp1 in filenames1) {
      cat(temp1,"\n")
      
      filenames2 <- list.files(paste(filea,temp1,"/",sep=""))
      temp <- as.data.frame(array(NA,dim = c(length(filenames2),3)))
      temp[,1] <- filenames2
      for (i in 1:length(filenames2)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <- strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt" & 	temp[,3]!="rssMat.txt"),]
      
      for (i in 1:length(rownames(temp))) {
        cat(temp[i,3],"   ")
        ID <- read.table(paste(filea,temp1,"/",temp[i,1],sep=""),header=T)
        ID <- cbind(rep(paste(temp[i,3]," cell",sep=""),dim(ID)[1]) ,ID)
        ID <- cbind(rep( Group[which(Group[,1]==temp1),3],dim(ID)[1]),ID)
        ID <- cbind(rep( Tissue[s,3],dim(ID)[1]),ID)
        colnames(ID) <- c("Tissue","group","cell_type", "TF","Target","Mode.of.Regulation","References.PMID.")
        res <- rbind(res,ID)
        
      }
      cat("\n")
    }
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/TRRUST2/TRRUST2.csv",row.names=F)
}



#####细胞间通讯
{
  res <- array("",dim=c(2,16))
  colnames(res) <- c("Tissue","group","interacting_pair","partner_a","partner_b",
                     "gene_a","gene_b","secreted","receptor_a","receptor_b","annotation_strategy",
                     "is_integrin","cell.type_a","cell.type_b","exp_means","p.value")
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    filea <-  paste("E:/衰老数据库结果_4/细胞间通讯/细胞间通讯/",Tissue[s,2],sep="")
    
    ID <- read.csv(paste(filea,"/",Tissue[s,2],"_results.csv",sep=""))
    
    for(i in 1:dim(ID)[1]){
      ID[i,12] <- paste(ID[i,12]," cell",sep="")
      ID[i,13] <- paste(ID[i,13]," cell",sep="")
    }
    
    ID <- cbind(rep(Tissue[s,3],dim(ID)[1]),ID)
    colnames(ID) <- c("Tissue","group","interacting_pair","partner_a","partner_b",
                      "gene_a","gene_b","secreted","receptor_a","receptor_b","annotation_strategy",
                      "is_integrin","cell.type_a","cell.type_b","exp_means","p.value")
    res <- rbind(res,ID)
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/cell cell communication/cell_cell_communication.csv",row.names=F)
}

#####细胞间通讯统计
{
  res <- array("",dim=c(2,5))
  colnames(res) <- c("Tissue","group","SOURCE",	"TARGET",	"count")
  
  
  for (s in 1:17) {
    cat(s,"  ",arr[s],"\n")
    ID <- read.csv(paste("E:/衰老数据库结果_4/细胞间通讯/",Tissue[s,2],"_results.csv",sep=""),row.names=1)

    a <-  unique(as.character(ID[1,]))
    
    temp <- ID[3:dim(ID)[1],1:3]
    temp <- cbind(rep(a[1],dim(temp)[1]),temp)
    colnames(temp) <- c("group","SOURCE",	"TARGET",	"count")
    for(i in 2:length(a)){
      temp1 <- ID[3:dim(ID)[1],((i-1)*3+1):(i*3)]
      temp1 <- cbind(rep(a[i],dim(temp1)[1]),temp1)
      colnames(temp1) <- c("group","SOURCE",	"TARGET",	"count")
      temp <- rbind(temp,temp1)
    }
    
    for(i in 1:dim(temp)[1]){
      temp[i,2] <- paste(temp[i,2]," cell",sep="")
      temp[i,3] <- paste(temp[i,3]," cell",sep="")
    }
    temp <- temp[which(temp[,4]>0),]
    temp <- cbind(rep(Tissue[s,3],dim(temp)[1]),temp)
    colnames(temp) <- c("Tissue","group","SOURCE",	"TARGET",	"count")
    res <- rbind(res,temp)
  }  
  res <- res[-1,]
  res <- res[-1,]
  write.csv(res,"E:/数据整合/cell cell communication/cell_cell_communication_static.csv",row.names=F)
}


####gene summary
deg_overlap <- read.csv("E:/数据整合/deg overlap/deg_overlap.csv")

gene_summary <- read.csv("E:/衰老数据库结果_4/gene_summary.csv",row.names=1)
gene_summary <- gene_summary[,1:5]
gene_summary <- cbind(gene_summary,rep("",dim(gene_summary)[1]))

colnames(gene_summary)[6] <- "Tissue"
for(i in 1:dim(gene_summary)[1]){
  temp <-  unique(deg_overlap[which(deg_overlap[,4]==gene_summary[i,1]),1])
  if(length(temp)>0){
    a <- temp[1]
    if(length(temp)>1){
      for(j in 2:length(temp)){
        a <- paste(a,";",temp[j],sep="")
      }
    }
    gene_summary[i,6] <- a
  }

  
}
write.csv(gene_summary,"E:/数据整合/gene summary/gene_summary.csv")

####
{
  deg_overlap <- read.csv("E:/数据整合/deg overlap/deg_overlap.csv")
  immunegenes <- read.csv("E:/衰老数据库结果_4/immunegenes.csv")
  immunegenes <- unique(immunegenes[,1])  
  tert <- read.csv("E:/衰老数据库结果_4/tert.csv")
  tert <- unique(tert[,2])
  deg_overlap <- cbind(deg_overlap,rep("false",dim(deg_overlap)[1]))
  colnames(deg_overlap)[11:12] <- c("isImmunegenes","isTert")
  
  for(i in 1:dim(deg_overlap)[1]){
    if(deg_overlap[i,4]%in%immunegenes){
      deg_overlap[i,11] <- "true"
    }
    
    if(deg_overlap[i,4]%in%tert){
      deg_overlap[i,12] <- "true"
    }
  }

  write.csv(deg_overlap,"E:/数据整合/deg overlap/deg_overlap_res.csv",row.names=F)
  
  
  
  gene <- read.table("E:/数据整合_1/deg overlap(无需改动)/gene.txt",header=T)
  gene1 <- read.csv("E:/数据整合_1/deg overlap(无需改动)/gProfiler_hsapiens_2022-5-31 10-44-31.csv")
  gene1 <- gene1[,c(1,3)] 
  gene1 <- distinct(gene1,initial_alias,name,.keep_all = T)

  colnames(gene) <- c("gene","symble")
  colnames(gene1) <- c("gene","symble")
  gene <- rbind(gene,gene1)
  gene <- rbind(gene,c("Q9NY84","VNN3"))
  
  write.csv(gene,"E:/数据整合_1/deg overlap(无需改动)/gene.csv")
  
  gene1 <- read.csv("E:/数据整合_1/deg overlap(无需改动)/circadian clock.csv")
  a <- setdiff(gene1[,1],gene[,1])
  write.csv(a,"E:/数据整合_1/deg overlap(无需改动)/a.csv")
  
  gene <- gene[,2]
  
  deg_overlap <- read.csv("E:/数据整合/deg overlap/deg_overlap.csv")
  deg_overlap <- cbind(deg_overlap,rep("false",dim(deg_overlap)[1]))
  colnames(deg_overlap)[11] <- c("isInGeneList")
  
  for(i in 1:dim(deg_overlap)[1]){
    if(deg_overlap[i,4]%in%gene){
      deg_overlap[i,11] <- "true"
    }
  }
  
  write.csv(deg_overlap,"E:/数据整合_1/deg overlap(无需改动)/deg_overlap_res1.csv",row.names=F)
  
  
}


#########数据整合
{
  #####drug overlap
  {
    drug_overlap <- read.csv("E:/数据整合_1/drug overlap/drug_overlap.csv")
    
    res <- drug_overlap[1:2,]
    data <- drug_overlap[,c(1,2,4)]
    data <- distinct(data,Tissue,group,Gene,.keep_all = T)
    for(i in 1:dim(data)[1]){
      temp <- drug_overlap[which(drug_overlap[,1]==data[i,1]  &  drug_overlap[,2]==data[i,2]  &  drug_overlap[,4]==data[i,3] ),]
      temp[1,10] <- gsub("; ",",",temp[1,10])
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
          for(k in 5:10){
            if(k==10){
              temp[1,k] <- paste(temp[1,k],";",gsub("; ",",",temp[j,k]),sep="")
            }else{
              temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
            }
          }
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    write.csv(res,"E:/数据整合_1/drug overlap/drug_overlap1.csv")
  }
  
  ####databasse_web
  {
    database_web <- read.csv("/data03/HCB/data/database_web.csv")
  }
  
  ####disease_overlap
  {
    disease_overlap <- read.csv("/data03/HCB/data/disease_overlap.csv")
    
    res <- disease_overlap[1:2,]
    data <- disease_overlap[,c(1,2,4,5)]
    data <- distinct(data,Tissue,group,geneId,geneSymbol,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- disease_overlap[which(disease_overlap[,1]==data[i,1]  &  disease_overlap[,2]==data[i,2]  &  disease_overlap[,4]==data[i,3] & disease_overlap[,5]==data[i,4]),]
      
      temp[1,11] <- gsub(";",",",temp[1,11])
      
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          
          temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
          for (k in 6:18) {
            if(k==11){
              temp[1,k] <- paste(temp[1,k],";",gsub(";",",",temp[j,k]),sep="")
            }else{
              temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
            }
          }
          
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    
    
    data <- disease_overlap[,8:12]
    data <- distinct(data,diseaseId,.keep_all = T)
    write.csv(data,"/data03/HCB/data/diseaseID_data.csv",row.names=F)
    
    ans <- disease_overlap[,-9:-12]
    
    data <- ans[,c(1,2,3,4)]
    data <- distinct(data,Tissue,group,cell_type,geneId,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- ans[which(ans[,1]==data[i,1]  &  ans[,2]==data[i,2]  &  ans[,3]==data[i,3] & ans[,4]==data[i,4]),]
      
      pmid <- length(unique(temp[,"pmid"])) 
      
      ans[which(ans[,1]==data[i,1]  &  ans[,2]==data[i,2]  &  ans[,3]==data[i,3] & ans[,4]==data[i,4]),"pmid"] <- pmid
    }

    write.csv(ans,"/data03/HCB/data/disease_overlap_res.csv")
    
    
    ans1 <- distinct(ans1,Tissue,group,cell_type,geneId,geneSymbol,DSI,DPI,diseaseId,score,EI,YearInitial,YearFinal,pmid,source,.keep_all = T)
    
    write.csv(ans1,"/data03/HCB/data/disease_overlap_res.csv")   
        
    
  }
  
  #####scenic_rssmat
  {
    scenic <- read.csv("E:/数据整合_1/Scenic/scenic.csv")
    
    res <- scenic[1:2,]
    data <- scenic[,c(1,2,4)]
    data <- distinct(data,Tissue,group,TF,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- scenic[which(scenic[,1]==data[i,1]  &  scenic[,2]==data[i,2]  &  scenic[,4]==data[i,3] ),]
      
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
          temp[1,5] <- paste(temp[1,5],";",temp[j,5],sep="")
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    write.csv(res,"E:/数据整合_1/Scenic/scenic1.csv")
  }
  
  #####scenic_enrichment
  {
    scenic_enrichment <- read.csv("E:/数据整合_1/scenic enrichment(已更改)/scenic_enrichment.csv")
    
    res <- scenic_enrichment[1:2,]
    data <- scenic_enrichment[,c(1,2,3)]
    data <- distinct(data,Tissue,group,TF,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- scenic_enrichment[which(scenic_enrichment[,1]==data[i,1]  &  scenic_enrichment[,2]==data[i,2]  &  scenic_enrichment[,3]==data[i,3] ),]
      temp[1,12] <- gsub(";",",",temp[1,12])
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          for(k in 4:13){
            if(k==12){
              temp[1,k] <- paste(temp[1,k],";",gsub(";",",",temp[j,k]),sep="")
            }else{
              temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
            }
          }
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    write.table(res,"E:/数据整合_1/scenic enrichment(已更改)/scenic_enrichment.txt",sep=",",row.names=F)
   
  }
  
  #####specific_gene
  {
    specific_gene <- read.csv("E:/数据整合_1/specific gene(已更改)/specific_gene.csv")
    
    res <- specific_gene[1:2,]
    data <- specific_gene[,c(1,3)]
    data <- distinct(data,Tissue,Gene,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- specific_gene[which(specific_gene[,1]==data[i,1]  &  specific_gene[,3]==data[i,2] ),]
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          temp[1,2] <- paste(temp[1,2],";",temp[j,2],sep="")
          for(k in 4:11){
              temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
          }
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    write.table(res,"E:/数据整合_1/specific gene(已更改)/specific_gene.txt",sep=",",row.names=F)
  }
  
  #####TRRUST2
  {
    TRRUST2 <- read.csv("E:/数据整合_1/TRRUST2(已更改)/TRRUST2.csv")
    
    res <- TRRUST2[1:2,]
    data <- TRRUST2[,c(1,2,4)]
    data <- distinct(data,Tissue,group,TF,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- TRRUST2[which(TRRUST2[,1]==data[i,1]  &  TRRUST2[,2]==data[i,2]  &  TRRUST2[,4]==data[i,3] ),]
      temp[1,7] <- gsub(";","|",temp[1,7])
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          for(k in 5:7){
            if(k==7){
              temp[1,k] <- paste(temp[1,k],";",gsub(";","|",temp[j,k]),sep="")
            }else{
              temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
            }
          }
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    write.table(res,"E:/数据整合_1/TRRUST2(已更改)/TRRUST2.txt",sep=",",row.names=F)
  }
  
  #####hTFTarget
  {
    hTFTarget <- read.csv("/data03/HCB/data/hTFTarget.csv")
    
    res <- hTFTarget[1:2,]
    data <- hTFTarget[,c(1,2,4)]
    data <- distinct(data,Tissue,group,TF,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- hTFTarget[which(hTFTarget[,1]==data[i,1]  &  hTFTarget[,2]==data[i,2]  &  hTFTarget[,4]==data[i,3] ),]
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
            temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
            temp[1,5] <- paste(temp[1,5],";",temp[j,5],sep="")
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    write.table(res,"/data03/HCB/data/hTFTarget.txt",sep=",",row.names=F)
  }
  
  #####gene_CV
  {
    gene_CV <- read.csv("E:/数据整合_1/gene CV(无需改动)/gene_CV.csv")
    
    res <- gene_CV[1:2,]
    data <- gene_CV[,c(1,2,4)]
    data <- distinct(data,Tissue,group,Gene,.keep_all = T)
    
    for(i in 1:dim(data)[1]){
      temp <- gene_CV[which(gene_CV[,1]==data[i,1]  &  gene_CV[,2]==data[i,2]  &  gene_CV[,4]==data[i,3] ),]
      if(dim(temp)[1] >1){
        for(j in 2:dim(temp)[1]){
          temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
          temp[1,5] <- paste(temp[1,5],";",temp[j,5],sep="")
        }
      }
      res <- rbind(res,temp[1,])
    }
    res <- res[-1:-2,]
    
    write.table(res,"E:/数据整合_1/gene CV(无需改动)/gene_CV.txt",sep=",",row.names=F)
  }
  
  #######deg_specific
  {
    deg <- read.table("E:/数据整合_1/deg overlap(无需改动)/deg_overlap.txt",sep=",")
    specific <- read.csv("E:/数据整合_1/specific gene(已更改)/specific_gene.csv")
    deg <- cbind(deg,specific[,10:11])
    write.table(deg,"E:/数据整合_1/deg overlap(无需改动)/deg_specific_overlap.txt",sep=",")
  }
  
}



#########数据提取
{
  setwd("/data03/HCB/aging/skin/")
  scRNA <- readRDS("scRNA4.rds")
  exp_brain <- scRNA@assays$RNA@data[c("ETS1","DUSP4"),]
  exp_brain <- t(as.matrix(exp_brain))
  group <- scRNA@meta.data[,c(1,9)]
  exp_brain <- cbind(exp_brain,group)
  write.csv(exp_brain,"/data03/HCB/data/exp_brain.csv")
  
  
  exp_skin <- scRNA@assays$RNA@data[c("ETS1","DUSP4"),]
  exp_skin <- t(as.matrix(exp_skin))
  group <- scRNA@meta.data[,c(1,9)]
  exp_skin <- cbind(exp_skin,group)
  write.csv(exp_skin,"/data03/HCB/data/exp_skin.csv")
  
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/skin/"
    
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    {
      i=10
      mid <- subset(scRNA, idents = cluster[i], features= c("ETS1","DUSP4"), subset = group == "mid")
      old <- subset(scRNA, idents = cluster[i], features= c("ETS1","DUSP4"), subset = group == "old")
      mid_counts = mid@assays$RNA@data
      old_counts = old@assays$RNA@data
      
      r = 0.5
      a <- sample(1:dim(mid_counts)[2],floor(dim(mid_counts)[2]*r),replace = F)
      b <- sample(1:dim(old_counts)[2],floor(dim(old_counts)[2]*r),replace = F)
      mid_counts <- mid_counts["ETS1",a]
      old_counts <- old_counts["ETS1",b]
      gene_CV <- GeneCvAble(c(length(mid_counts[1,]),length(old_counts[1,]),mid_counts[1,],old_counts[1,]))
      
      "ETS1" %in% rownames(old_counts)
      
      "ETS1" %in% rownames(scRNA)
      
      
      
      
  }
  
}

}



########画图
{
  deg <- read.csv("E:/数据整合_1/deg overlap(无需改动)/deg_overlap.csv")
  
  for (i in 1:dim(deg)[1]){
    temp <- deg[i,2]
    a <- strsplit(x=temp,split=' ')[[1]][1]
    b <- strsplit(x=temp,split=' ')[[1]][3]
    deg[i,2] <- paste(b," vs ",a,sep="")
  }
  write.csv(deg,"E:/数据整合_1/deg_overlap.csv")
  
  deg <- read.table("/data03/HCB/data/deg_overlap.txt",sep=",")
  deg[which(deg[,4]=="1-Mar"),4] <- "MARCH1"
  deg[which(deg[,4]=="3-Mar"),4] <- "MARCH3"
  deg[which(deg[,4]=="2-Mar"),4] <- "MARCH2"
  deg[which(deg[,4]=="11-Sep"),4] <- "SEPT11"
  write.table(deg,"/data03/HCB/data/deg_overlap.txt",sep=",")
}

{
  library("ggpubr")
  library(Seurat)
  library(ggplot2)
  library(dplyr)
  
  
  files <- array(NA,dim=c(14,2))
  files[1,] <- c("Bladder","/data03/HCB/aging/bladder/analysis/scRNA4.rds")
  files[2,] <- c("Blood","/data03/HCB/aging/blood/analsis/scRNA1.rds")
  files[3,] <- c("Bone-marrow","/data03/HCB/aging/bone-marrow/scRNA4.rds")
  files[4,] <- c("Brain","/data03/HCB/aging/brain/scRNA4.rds")
  files[5,] <- c("Kidneys","/data03/HCB/aging/kidney/scRNA4.rds")
  files[6,] <- c("Liver","/data03/HCB/aging/liver/scRNA4.rds")
  files[7,] <- c("Lung","/data03/HCB/aging/lung/scRNA4.rds")
  files[8,] <- c("Pancreas","/data03/HCB/aging/Pancreas/analysis/scRNA4.rds")
  files[9,] <- c("Prostate","/data03/HCB/aging/prostate/scRNA4.rds")
  files[10,] <- c("Retina","/data03/HCB/aging/retina/result/scRNA5.rds")
  files[11,] <- c("Skeletal-muscle","/data03/HCB/aging/skeletal-muscle/scRNA4.rds")
  files[12,] <- c("Skin","/data03/HCB/aging/skin/scRNA4.rds")
  files[13,] <- c("Stomach","/data03/HCB/aging/stomach/scRNA4.rds")
  files[14,] <- c("Testis","/data03/HCB/aging/testis/analysis/scRNA4.rds")

  deg <- read.table("/data03/HCB/data/deg_specific_overlap_new.txt",sep=",")
  group_value <- c("youth","mid","old","supold")
  color_value <- c("#009900","#CC3300","#000066","darkred")
  
  
  for (i in 1:14){
    xxx = 1.5
    if(i == 2){
      xxx = 2
    }
    cat(files[i,1],"\n")
    scRNA <- readRDS(files[i,2])
    
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    group <- unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"group"])
    
    
    if(!dir.exists(paste("/data03/HCB/data/deg/",files[i,1],sep=""))){
      dir.create(paste("/data03/HCB/data/deg/",files[i,1],sep=""))
    }
    
    for (j in 1:length(cluster)){
      
      cat(cluster[j],"\n")
      
      cell_type <- paste(cluster[j]," cell",sep="")
      
      if(!dir.exists(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type,sep=""))){
        dir.create(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type,sep=""))
      }
      
      group_real <- group_value[which(group_value%in%group)]
      color_real <- color_value[which(group_value%in%group)]
      
      gene <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type),4]
      scRNA1 <- subset(scRNA, idents = cluster[j],features=gene)
      
      if(length(gene)>0){
        for (k in 1:length(gene)) {
          temp <- array("",dim=c(2,2))
          colnames(temp) <- c("group","exp")
          
          if(!dir.exists(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type,"/",gene[k],sep=""))){
            dir.create(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type,"/",gene[k],sep=""))
          }
          
          
          for (l in 1:length(group_real)) {
            
            unique(scRNA1@meta.data[,"group"])
            
            
            deg[which(deg[,4]==gene[k]),]
            
            scRNA2 <- subset(scRNA1, features=gene[k])
            
            scRNA2 <- subset(scRNA1, features=gene[k],subset = group == group_real[l])
            exp <- scRNA2@assays$RNA@data
            
            a <- array("",dim=c(length(exp),2))
            colnames(a) <- c("group","exp")
            a[,1] <- rep(group_real[l],length(exp))
            a[,2] <- exp[1,]
            temp <- rbind(temp,a)
          }
          temp <- as.data.frame(temp[-1:-2,]) 
          yma <- ceiling(max(as.numeric(temp[,2]))) + 2
          
          temp[,2] <- round(as.numeric(temp[,2]),4)
          
          info <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type & deg[,4]==gene[k]),]
          c <- paste(info[1,2],"  p:",info[1,5],sep = "")
          if(dim(info)[1]>1){
            for(l in 2:dim(info)[1]){
              t <- paste(info[l,2],"  p:",info[l,5],sep = "")
              c <- paste(c,t,sep = "\n")
            }
          }
          
          png(file= paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type,"/",gene[k],"/picture.png",sep=""),width = 500,height = 500)
          p <- ggboxplot(temp, x="group", y="exp", size = 1,color = "group", palette = color_real, add = "jitter", shape="group",ylim=c(0,yma))+
            annotate("text",x= xxx,y=yma-1, label= c,size = 8)+
            
            theme_bw(base_size = 25)+ylab(paste(gene[k],"  Expression",sep=""))+xlab("Group")+
            theme(axis.title.x =element_text(size=25), axis.title.y=element_text(size=25),panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),axis.text.x = element_text(size = 25,  color = "black"),
                  axis.text.y = element_text(size = 25,  color = "black"),legend.position = "none")
          print(p)
          dev.off()
          
        }
      }
      
    }
    
    
    "Kidneys"           "Collecting cell",       "Collecting_duct_A cell"  "Collecting_duct_B cell"
    "Lung"              "Endothelial cell",      "Endothelial Lymphatic cell"
    "Skeletal-muscle"   "B cell",                "B T NK cell"
    "Stomach"           "Fibroblasts cell",      "Fibroblasts myofibroblasts cell"
    "Stomach"           "Smooth muscle cell",    "Smooth muscle myofibroblasts cell"
    
    c(5,7)
    
    for (j in c(5,7)){
      
      cat(cluster[j],"\n")
      
      cell_type <- paste(cluster[j]," cell",sep="")
      
      cell_type1 <- "Smooth muscle myofibroblasts cell"
        
      if(!dir.exists(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type1,sep=""))){
        dir.create(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type1,sep=""))
      }
      
      group_real <- group_value[which(group_value%in%group)]
      color_real <- color_value[which(group_value%in%group)]
      
      gene <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type1),4]
      scRNA1 <- subset(scRNA, idents = cluster[j],features=gene)
      
      if(length(gene)>0){
        for (k in 1:length(gene)) {
          temp <- array("",dim=c(2,2))
          colnames(temp) <- c("group","exp")
          
          if(!dir.exists(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type1,"/",gene[k],sep=""))){
            dir.create(paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type1,"/",gene[k],sep=""))
          }
          
          
          for (l in 1:length(group_real)) {
            
            unique(scRNA1@meta.data[,"group"])
            
            
            deg[which(deg[,4]==gene[k]),]
            
            scRNA2 <- subset(scRNA1, features=gene[k])
            
            scRNA2 <- subset(scRNA1, features=gene[k],subset = group == group_real[l])
            exp <- scRNA2@assays$RNA@data
            
            a <- array("",dim=c(length(exp),2))
            colnames(a) <- c("group","exp")
            a[,1] <- rep(group_real[l],length(exp))
            a[,2] <- exp[1,]
            temp <- rbind(temp,a)
          }
          temp <- as.data.frame(temp[-1:-2,]) 
          yma <- ceiling(max(as.numeric(temp[,2]))) + 2
          
          temp[,2] <- round(as.numeric(temp[,2]),4)
          
          info <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type & deg[,4]==gene[k]),]
          c <- paste(info[1,2],"  p:",info[1,5],sep = "")
          if(dim(info)[1]>1){
            for(l in 2:dim(info)[1]){
              t <- paste(info[l,2],"  p:",info[l,5],sep = "")
              c <- paste(c,t,sep = "\n")
            }
          }
          
          png(file= paste("/data03/HCB/data/deg/",files[i,1],"/",cell_type1,"/",gene[k],"/picture.png",sep=""),width = 500,height = 500)
          p <- ggboxplot(temp, x="group", y="exp", size = 1,color = "group", palette = color_real, add = "jitter", shape="group",ylim=c(0,yma))+
            annotate("text",x= xxx,y=yma-1, label= c,size = 8)+
            
            theme_bw(base_size = 25)+ylab(paste(gene[k],"  Expression",sep=""))+xlab("Group")+
            theme(axis.title.x =element_text(size=25), axis.title.y=element_text(size=25),panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),axis.text.x = element_text(size = 25,  color = "black"),
                  axis.text.y = element_text(size = 25,  color = "black"),legend.position = "none")
          print(p)
          dev.off()
          
        }
      }
      
    }
    
  }
  
}

{
  library("ggpubr")
  library(Seurat)
  library(ggplot2)
  library(dplyr)
  
  files <- array(NA,dim=c(3,2))
  files[1,] <- c("Intestine","/data/HCB/aging/ileum/scRNA4.rds")
  files[2,] <- c("Oesophagus","/data/HCB/aging/oesophagus/scRNA4.rds")
  files[3,] <- c("Heart","/data/HCB/aging/heart/scRNA4.rds")
  
  deg <- read.csv("/data/HCB/aging/data/deg_overlap.txt")
  group_value <- c("youth","mid","old","supold")
  color_value <- c("#009900","#CC3300","#000066","darkred")
  
  for (i in 1:3){
    cat(files[i,1],"\n")
    scRNA <- readRDS(files[i,2])
    
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    group <- unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"group"])
    
    
    if(!dir.exists(paste("/data/HCB/aging/data/deg/",files[i,1],sep=""))){
      dir.create(paste("/data/HCB/aging/data/deg/",files[i,1],sep=""))
    }
    
    for (j in 1:length(cluster)){
      
      cat(cluster[j],"\n")
      
      cell_type <- paste(cluster[j]," cell",sep="")
      
      if(!dir.exists(paste("/data/HCB/aging/data/deg/",files[i,1],"/",cell_type,sep=""))){
        dir.create(paste("/data/HCB/aging/data/deg/",files[i,1],"/",cell_type,sep=""))
      }
      
      group_real <- group_value[which(group_value%in%group)]
      color_real <- color_value[which(group_value%in%group)]
      
      gene <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type),4]
      scRNA1 <- subset(scRNA, idents = cluster[j],features=gene)
      
      for (k in 1:length(gene)) {
        temp <- array("",dim=c(2,2))
        colnames(temp) <- c("group","exp")
        
        if(!dir.exists(paste("/data/HCB/aging/data/deg/",files[i,1],"/",cell_type,"/",gene[k],sep=""))){
          dir.create(paste("/data/HCB/aging/data/deg/",files[i,1],"/",cell_type,"/",gene[k],sep=""))
        }
        
        
        for (l in 1:length(group_real)) {
          exp <- subset(scRNA1, features=gene[k],subset = group == group_real[l])@assays$RNA@data
          
          a <- array("",dim=c(length(exp),2))
          colnames(a) <- c("group","exp")
          a[,1] <- rep(group_real[l],length(exp))
          a[,2] <- exp[1,]
          temp <- rbind(temp,a)
        }
        temp <- as.data.frame(temp[-1:-2,]) 
        yma <- ceiling(max(as.numeric(temp[,2]))) + 2
        
        temp[,2] <- round(as.numeric(temp[,2]),4)
        
        info <- deg[which(deg[,1]==files[i,1] & deg[,3]==cell_type & deg[,4]==gene[k]),]
        c <- paste(info[1,2],"  p:",info[1,5],sep = "")
        if(dim(info)[1]>1){
          for(l in 2:dim(info)[1]){
            t <- paste(info[l,2],"  p:",info[l,5],sep = "")
            c <- paste(c,t,sep = "\n")
          }
        }
        
        png(file= paste("/data/HCB/aging/data/deg/",files[i,1],"/",cell_type,"/",gene[k],"/picture.png",sep=""),width = 500,height = 500)
        p <- ggboxplot(temp, x="group", y="exp", size = 1,color = "group", palette = color_real, add = "jitter", shape="group",ylim=c(0,yma))+
          annotate("text",x= 1.5,y=yma-1, label= c,size = 8)+
          
          theme_bw(base_size = 25)+ylab(paste(gene[k],"  Expression",sep=""))+xlab("Group")+
          theme(axis.title.x =element_text(size=25), axis.title.y=element_text(size=25),panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),axis.text.x = element_text(size = 25,  color = "black"),
                axis.text.y = element_text(size = 25,  color = "black"),legend.position = "none")
        print(p)
        dev.off()
        
      }
      
    }
    
  }
}

########数据更改
{
  ##cell_cell_communication
  {
    deg <- read.csv("E:/数据整合_1/cell cell communication(无需改动)/cell_cell_communication.csv")
    
    l = 6
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/cell cell communication(无需改动)/cell_cell_communication.txt",sep=",")
  }
  
  ##drug_overlap
  {
    deg <- read.csv("E:/数据整合_1/drug overlap(已更改)/drug_overlap1.csv")
    m = 3
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    
    l = 5
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    deg <- deg[,-1]
    write.table(deg,"E:/数据整合_1/drug overlap(已更改)/drug_overlap.txt",sep=",")
  }
  
  ##enrichment_overlap
  {
    deg <- read.csv("E:/数据整合_1/enrichment overlap(无需改动)/enrichment_overlap.csv")
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    write.table(deg,"E:/数据整合_1/enrichment overlap(无需改动)/enrichment_overlap.txt",sep=",")
  }
  
  ##gene_CV
  {
    deg <- read.table("E:/数据整合_1/gene CV(无需改动)/gene_CV.txt",sep=",",header=T)
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    l = 4
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/gene CV(无需改动)/gene_CV1.txt",sep=",")
  }
  
  ##gene_summary
  {
    deg <- read.csv("E:/数据整合_1/gene summary(无需改动)/gene_summary.csv",row.names=1)
    
    l = 1
    
    deg[which(deg[,l]=="1-Mar"),c(1,3)] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),c(1,3)] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),c(1,3)] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),c(1,3)] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/gene summary(无需改动)/gene_summary.txt",sep=",")
  }
  
  ##scenic_enrichment
  {
    deg <- read.table("E:/数据整合_1/scenic enrichment(已更改)/scenic_enrichment.txt",sep=",",header=T)
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    l = 3
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/scenic enrichment(已更改)/scenic_enrichment.txt",sep=",")
  }
  
  ##scenic1
  {
    deg <- read.csv("E:/数据整合_1/Scenic(已更改)/scenic1.csv",row.names=1)
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    l = 4
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/Scenic(已更改)/scenic1.txt",sep=",")
  }
  
  ##specific_gene
  {
    deg <- read.csv("E:/数据整合_1/specific gene(已更改)/specific_gene.txt",sep=",",header=T)
    
    l = 3
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/specific gene(已更改)/specific_gene1.txt",sep=",")
  }
  
  ##TRRUST2
  {
    deg <- read.csv("E:/数据整合_1/TRRUST2(已更改)/TRRUST2.txt",sep=",",header=T)
    
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    l = 4
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"E:/数据整合_1/TRRUST2(已更改)/TRRUST2.txt",sep=",")
  }
  
  ##database_web
  {
    deg <- read.csv("/data03/HCB/data/database_web.csv",header=T)
    
    for(i in 1:dim(deg)[1]){
      if(deg[i,3]=="**"){
        deg[i,6] <- gsub("1-Mar","MARCH1",deg[i,6])
        deg[i,6] <- gsub("2-Mar","MARCH2",deg[i,6])
        deg[i,6] <- gsub("3-Mar","MARCH3",deg[i,6])
        deg[i,6] <- gsub("11-Sep","SEPT11",deg[i,6])
        
        cat("00")
      }
    }
    
    write.table(deg,"/data03/HCB/data/database_web.txt",sep=",")
  }
  
  length(which(deg[,3] == "**")) 
  
  ##disease_overlap_res1
  {
    deg <- read.csv("/data03/HCB/data/disease_overlap_res1.csv",header=T,row.names=1)
    
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    l = 5
    
    deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
    deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
    deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
    deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
    
    write.table(deg,"/data03/HCB/data/disease_overlap_res1.txt",sep=",")
  }
  
  
  ##hTFTarget
  {
    deg <- read.table("/data03/HCB/data/hTFTarget.txt",header=T,sep=",")
    
    m = 2
    for (i in 1:dim(deg)[1]){
      temp <- deg[i,m]
      a <- strsplit(x=temp,split=' ')[[1]][1]
      b <- strsplit(x=temp,split=' ')[[1]][3]
      deg[i,m] <- paste(b," vs ",a,sep="")
    }
    
    write.table(deg,"/data03/HCB/data/hTFTarget1.txt",sep=",")
  }
}


###atac数据整合
{
  ###marker
  {
    tissue <- read.csv("E:/ATAC待整合数据/organ_name.csv",header=F)
    
    file <- paste("E:/ATAC待整合数据/umap/")
    filenames <- list.files(file)
    
    res <- array("",dim=c(2,7))
    colnames(res) <- c("Tissue","group_name","seqnames","start","end","strand","name")
    
    for (s in 1:11) {
      cat(s,"  ",tissue[s,3],"\n")
      filea <-  paste("E:/ATAC待整合数据/umap/",tissue[s,3],"/final_celltype_markerlist.csv",sep="")
      
      ID <- read.csv(filea)
      ID <- ID[which(is.na(ID[,4])==F),2:7]
      
      for(i in 1:dim(ID)[1]){
        if(ID[i,5] == "1"){
          ID[i,5] = "-"
        }else{
          ID[i,5] = "+"
        }
      }
      
      ID <- cbind(rep(tissue[s,2],dim(ID)[1]),ID)
      colnames(ID) <- c("Tissue","group_name","seqnames","start","end","strand","name")
      res <- rbind(res,ID)
    }
    
    res <- res[-1,]
    res <- res[-1,]
    write.table(res,"E:/ATAC整合数据/marker/marker.table",sep=",",row.names=F)
    write.csv(res,"E:/ATAC整合数据/marker/marker.csv",row.names=F)
    
  }
  ##diff-peak
  {
    marker <- read.csv("E:/ATAC整合数据/marker/marker.csv")
    marker <- distinct(marker,Tissue,group_name,.keep_all = T)
    tissue <- rbind(marker,marker)
    tissue <- tissue[,1:4]
    colnames(tissue)[3:4] <- c("filenames","change")
    for(i in 1:dim(marker)[1]){
      tissue[((i-1)*2+1):((i-1)*2+2),1:2] <- marker[i,1:2]
      tissue[((i-1)*2+1):((i-1)*2+2),4] <- c("DOWN","UP")
    }
    
    file <- paste("E:/ATAC待整合数据/diff_peak/")
    filenames <- list.files(file)
    tissue[,3] <- filenames

    res <- array("",dim=c(2,13))
    colnames(res) <- c("Tissue","cell_type","change", "seqnames",	"start","end",	"Log2FC",
                       "Pval",	"MeanDiff",	"annotation",	"geneId",	"SYMBOL",	"GENENAME")
    
    for(i in 1:dim(tissue)[1]){
      ID <- read.csv(paste("E:/ATAC待整合数据/diff_peak/",tissue[i,3],sep=""))
      ID <- ID[,-4]
      for(j in 1:dim(ID)[1]){
        ID[j,7] <- gsub(",",";",ID[j,7])
        ID[j,10] <- gsub(",",";",ID[j,10])
      }
      ID <- cbind(rep(tissue[i,4],dim(ID)[1]),ID)
      ID <- cbind(rep(tissue[i,2],dim(ID)[1]),ID)
      ID <- cbind(rep(tissue[i,1],dim(ID)[1]),ID)
      
      colnames(ID) <- c("Tissue","cell_type","change", "seqnames",	"start","end",	"Log2FC",
                        "Pval",	"MeanDiff",	"annotation",	"geneId",	"SYMBOL",	"GENENAME")
      res <- rbind(res,ID)
    }
    
    res <- res[-1:-2,]
    
    write.table(res,"E:/ATAC整合数据/diff-peak/diff-peak.txt",sep=",")
    
    temp <- read.table("E:/ATAC整合数据/diff-peak/diff-peak.txt",sep=",",header=T)
    
    
    temp[which(temp[,3]=="DOWN"),3] <- "DECREASE"
    temp[which(temp[,3]=="UP"),3] <- "INCREASE"
    write.table(temp,"E:/ATAC整合数据/diff-peak/diff-peak1.txt",sep=",")
    
    
    temp <- read.table("E:/ATAC待整合数据/diff-peak1.txt",sep=",",header=T)
    
    temp[which(temp[,1] =="Skin" & temp[,2] == "T Lymphocyte" & temp[,12] == "ETS1"),]
    
    
  }
  ##aging-diff-peak
  {
    marker <- read.csv("E:/ATAC整合数据/marker/marker.csv")
    marker <- distinct(marker,Tissue,group_name,.keep_all = T)
    tissue <- rbind(marker,marker)
    tissue <- tissue[,1:4]
    colnames(tissue)[3:4] <- c("filenames","change")
    for(i in 1:dim(marker)[1]){
      tissue[((i-1)*2+1):((i-1)*2+2),1:2] <- marker[i,1:2]
      tissue[((i-1)*2+1):((i-1)*2+2),4] <- c("DOWN","UP")
    }
    
    file <- paste("E:/ATAC待整合数据/aging_diff_peak/")
    filenames <- list.files(file)
    tissue[,3] <- filenames
    
    res <- array("",dim=c(2,13))
    colnames(res) <- c("Tissue","cell_type","change", "seqnames",	"start","end",	"Log2FC",
                       "Pval",	"MeanDiff",	"annotation",	"geneId",	"SYMBOL",	"GENENAME")
    
    for(i in 1:dim(tissue)[1]){
      ID <- read.csv(paste("E:/ATAC待整合数据/aging_diff_peak/",tissue[i,3],sep=""))
      ID <- ID[,-4]
      for(j in 1:dim(ID)[1]){
        ID[j,7] <- gsub(",",";",ID[j,7])
        ID[j,10] <- gsub(",",";",ID[j,10])
      }
      ID <- cbind(rep(tissue[i,4],dim(ID)[1]),ID)
      ID <- cbind(rep(tissue[i,2],dim(ID)[1]),ID)
      ID <- cbind(rep(tissue[i,1],dim(ID)[1]),ID)
      
      colnames(ID) <- c("Tissue","cell_type","change", "seqnames",	"start","end",	"Log2FC",
                        "Pval",	"MeanDiff",	"annotation",	"geneId",	"SYMBOL",	"GENENAME")
      res <- rbind(res,ID)
    }
    
    res <- res[-1:-2,]
    
    
    write.table(res,"E:/ATAC整合数据/aging-diff-peak/aging-diff-peak.txt",sep=",")
    
    temp <- read.table("E:/ATAC整合数据/aging-diff-peak/aging-diff-peak.txt",sep=",",header=T)
    temp[which(temp[,3]=="DOWN"),3] <- "DECREASE"
    temp[which(temp[,3]=="UP"),3] <- "INCREASE"
    write.table(temp,"E:/ATAC整合数据/aging-diff-peak/aging-diff-peak1.txt",sep=",")
    
    
  }
  
  ##final_motif
  {
    file <- paste("E:/ATAC待整合数据/final_motif_csv/")
    filenames <- list.files(file)
    files <- array(NA,dim=c(length(filenames),5))
    files[,1] <- filenames
    
    for(i in 1:length(filenames)){
      files[i,2] <- gsub("Myeloid___Macrophage","Myeloid / Macrophage",files[i,1])
      files[i,2] <- gsub("sig_","",files[i,2])
      files[i,2] <- gsub("Adipose_Visceral_","Adipose-Visceral+",files[i,2])
      files[i,2] <- gsub("Artery_Aorta_","Artery-Aorta+",files[i,2])
      files[i,2] <- gsub("Colon_Sigmoid_","Colon-Sigmoid+",files[i,2])
      files[i,2] <- gsub("Colon_Transverse_","Colon-Transverse+",files[i,2])
      files[i,2] <- gsub("Esophagus_Muscularis_","Esophagus-Muscularis+",files[i,2])
      files[i,2] <- gsub("Skeletal_Muscle_","Skeletal-Muscle+",files[i,2])

      
      files[i,2] <- gsub("Brain_","Brain+",files[i,2])
      files[i,2] <- gsub("Lung_","Lung+",files[i,2])
      files[i,2] <- gsub("Pancreas_","Pancreas+",files[i,2])
      files[i,2] <- gsub("Skin_","Skin+",files[i,2])
      files[i,2] <- gsub("Stomach_","Stomach+",files[i,2])
            
      a <- strsplit(x=as.character(files[i,2]),split='[.]')[[1]][1]
      a <- strsplit(x=a,split='_')[[1]]
      files[i,5] <- a[length(a)]
      a <- strsplit(x=as.character(files[i,2]),split='[+]')[[1]]
      files[i,3] <- a[1]
      files[i,4] <-    gsub("_"," ",strsplit(x=as.character(a[2]),split='_m')[[1]][1])
    }
    
    res <- array("",dim=c(2,7))
    colnames(res) <- c("Tissue","cell_type","change", "TF",	"mlog10Pval","mid_Variability",	"old_Variability")
    
    for(i in 1:dim(files)[1]){
      ID <- read.csv(paste(file,files[i,1],sep=""))
      
      ID <- cbind(rep(files[i,5],dim(ID)[1]),ID)
      ID <- cbind(rep(files[i,4],dim(ID)[1]),ID)
      ID <- cbind(rep(files[i,3],dim(ID)[1]),ID)
      
      colnames(ID) <- c("Tissue","cell_type","change", "TF",	"mlog10Pval","mid_Variability",	"old_Variability")
      res <- rbind(res,ID)
    }
    
    temp <- res[-1:-2,]
    temp[which(temp[,3]=="down"),3] <- "DECREASE"
    temp[which(temp[,3]=="up"),3] <- "INCREASE"
    write.table(temp,"E:/ATAC整合数据/final_motif_csv/final_motif.txt",sep=",",row.names=F)
    
  }
  
  ##final_motif
  {
    file <- paste("E:/ATAC待整合数据/coA_result/")
    filenames <- list.files(file)
    files <- array(NA,dim=c(length(filenames),5))
    files[,1] <- filenames
    
    for(i in 1:length(filenames)){
      files[i,2] <- gsub("Myeloid___Macrophage","Myeloid / Macrophage",files[i,1])
      files[i,2] <- gsub("Adipose_Visceral_","Adipose-Visceral+",files[i,2])
      files[i,2] <- gsub("Artery_Aorta_","Artery-Aorta+",files[i,2])
      files[i,2] <- gsub("Colon_Sigmoid_","Colon-Sigmoid+",files[i,2])
      files[i,2] <- gsub("Colon_Transverse_","Colon-Transverse+",files[i,2])
      files[i,2] <- gsub("Esophagus_Muscularis_","Esophagus-Muscularis+",files[i,2])
      files[i,2] <- gsub("Skeletal_muscle_Gastrocnemius_","Skeletal-Muscle+",files[i,2])
      
      
      files[i,2] <- gsub("Brain_","Brain+",files[i,2])
      files[i,2] <- gsub("Lung_","Lung+",files[i,2])
      files[i,2] <- gsub("Pancreas_","Pancreas+",files[i,2])
      files[i,2] <- gsub("Skin_","Skin+",files[i,2])
      files[i,2] <- gsub("Stomach_","Stomach+",files[i,2])
      
      a <- strsplit(x=as.character(files[i,2]),split='[.]')[[1]][1]
      a <- strsplit(x=a,split='_')[[1]]
      files[i,5] <- a[length(a)]
      a <- strsplit(x=as.character(files[i,2]),split='[+]')[[1]]
      files[i,3] <- a[1]
      files[i,4] <-    gsub("_"," ",strsplit(x=as.character(a[2]),split='_c')[[1]][1])
    }
    
    res <- array("",dim=c(2,10))
    colnames(res) <- c("Tissue","cell_type","change", "seqnames.x",	"peak1_start",
                       "peak1_end","peak2_start","peak2_end","correlation","peak1_SYMBOL")
    
    for(i in 1:dim(files)[1]){
      ID <- read.csv(paste(file,files[i,1],sep=""))
      
      ID <- cbind(rep(files[i,5],dim(ID)[1]),ID)
      ID <- cbind(rep(files[i,4],dim(ID)[1]),ID)
      ID <- cbind(rep(files[i,3],dim(ID)[1]),ID)
      
      colnames(ID) <- c("Tissue","cell_type","change", "seqnames.x",	"peak1_start",
                        "peak1_end","peak2_start","peak2_end","correlation","peak1_SYMBOL")
      res <- rbind(res,ID)
    }
    
    temp <- res[-1:-2,]
    temp[which(temp[,3]=="down"),3] <- "DECREASE"
    temp[which(temp[,3]=="up"),3] <- "INCREASE"
    write.table(temp,"E:/ATAC整合数据/coA_result/coA_result.txt",sep=",",row.names=F)
    
  }
}


###gene_CV
{
  
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  library(Rcpp)
  library(ggpubr)
  sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
  
  
  files <- array(NA,dim=c(14,2))
  files[1,] <- c("Bladder","/data03/HCB/aging/bladder/analysis/scRNA4.rds")
  files[2,] <- c("Blood","/data03/HCB/aging/blood/analsis/scRNA1.rds")
  files[3,] <- c("Bone-marrow","/data03/HCB/aging/bone-marrow/scRNA4.rds")
  files[4,] <- c("Brain","/data03/HCB/aging/brain/scRNA4.rds")
  files[5,] <- c("Kidneys","/data03/HCB/aging/kidney/scRNA4.rds")
  files[6,] <- c("Liver","/data03/HCB/aging/liver/scRNA4.rds")
  files[7,] <- c("Lung","/data03/HCB/aging/lung/scRNA4.rds")
  files[8,] <- c("Pancreas","/data03/HCB/aging/Pancreas/analysis/scRNA4.rds")
  files[9,] <- c("Prostate","/data03/HCB/aging/prostate/scRNA4.rds")
  files[10,] <- c("Retina","/data03/HCB/aging/retina/result/scRNA5.rds")
  files[11,] <- c("Skeletal-muscle","/data03/HCB/aging/skeletal-muscle/scRNA4.rds")
  files[12,] <- c("Skin","/data03/HCB/aging/skin/scRNA4.rds")
  files[13,] <- c("Stomach","/data03/HCB/aging/stomach/scRNA4.rds")
  files[14,] <- c("Testis","/data03/HCB/aging/testis/analysis/scRNA4.rds")
  
  deg <- read.table("/data03/HCB/data/gene_cv/deg_specific_overlap_new.txt",sep=",")
  deg[which(deg[,3]=="\xa6æ\xc4 T cell"),3] <- "γδ T cell"
  
  res <- array("",dim=c(2,5))
  colnames(res) <- c("Tissue","group","cell_type","Gene", "Result")

  
  for (i in 1:14){
    cat(files[i,1],"\n")
    scRNA <- readRDS(files[i,2])
    
    temp <- deg[which(deg[,1]==files[i,1]),1:5]
    colnames(temp) <- c("Tissue","group","cell_type","Gene", "Result")
    
    group <- unique(temp[,2])
    cell_type <- unique(temp[,3])
    gene <- unique(temp[,4])
    
    temp <- array(NA,dim=c(length(group)*length(cell_type)*length(gene),5))
    colnames(temp) <- c("Tissue","group","cell_type","Gene", "Result")
    temp[,1] <- files[i,1]
    
    a <- "1"
    for(m in 1:length(group)){
      a <- c(a,rep(group[m],length(cell_type)*length(gene)))
    }
    temp[,2] <- a[-1]
    
    a <- "1"
    for(m in 1:length(cell_type)){
      a <- c(a,rep(cell_type[m],length(gene)))
    }
    a <- a[-1]
    b <- "1"
    for(m in 1:length(group)){
      b <- c(b,a)
    }
    temp[,3] <- b[-1]
    
    a <- "1"
    for(m in 1:(length(group)*length(cell_type))){
      a <- c(a,gene)
    }
    temp[,4] <- a[-1]
 
    #加速懒得写了   
    for(j in 1:dim(temp)[1]){
      
      group1 <- strsplit(x=as.character(temp[j,2]),split=' vs ')[[1]][1]
      group2 <- strsplit(x=as.character(temp[j,2]),split=' vs ')[[1]][2]
      cluster <- strsplit(x=as.character(paste(temp[j,3],"X",sep = "")),split=' cellX')[[1]][1]

      if(i==7 & cluster=="Endothelial Lymphatic"){
        t1 <- subset(scRNA, idents="Endothelial/Lymphatic", features= temp[j,4], subset = group == group1)
        t2 <- subset(scRNA, idents="Endothelial/Lymphatic", features= temp[j,4], subset = group == group2)
      }else if(i==11 & cluster=="B T NK"){
        t1 <- subset(scRNA, idents="B/T/NK", features= temp[j,4], subset = group == group1)
        t2 <- subset(scRNA, idents="B/T/NK", features= temp[j,4], subset = group == group2)
      }else if(i==13 & cluster=="Fibroblasts myofibroblasts"){
        t1 <- subset(scRNA, idents="Fibroblasts/myofibroblasts", features= temp[j,4], subset = group == group1)
        t2 <- subset(scRNA, idents="Fibroblasts/myofibroblasts", features= temp[j,4], subset = group == group2)
      }else if(i==13 & cluster=="Smooth muscle myofibroblasts"){
        t1 <- subset(scRNA, idents="Smooth muscle/myofibroblasts", features= temp[j,4], subset = group == group1)
        t2 <- subset(scRNA, idents="Smooth muscle/myofibroblasts", features= temp[j,4], subset = group == group2)
      }else{
        t1 <- subset(scRNA, idents = cluster, features= temp[j,4], subset = group == group1)
        t2 <- subset(scRNA, idents = cluster, features= temp[j,4], subset = group == group2)
      }
       
      t1_counts = t1@assays$RNA@data
      t2_counts = t2@assays$RNA@data
      
      r1 = 10000/length(colnames(t1))
      r2 = 10000/length(colnames(t2))
      
      if(r1<=1){
        a <- sample(1:dim(t1_counts)[2],floor(dim(t1_counts)[2]*r1),replace = F)
        t1_counts <- t1_counts[1,a]
      }
      if(r2<=1){
        b <- sample(1:dim(t2_counts)[2],floor(dim(t2_counts)[2]*r2),replace = F)
        t2_counts <- t2_counts[1,b]
      }
      if(class(t1_counts)!="numeric"){
        t1_counts <- c(t1_counts[1,])
      }
      if(class(t2_counts)!="numeric"){
        t2_counts <- c(t2_counts[1,])
      }
      temp[j,5] <- GeneCvAble(c(length(t1_counts),length(t2_counts),t1_counts,t2_counts))
    }
    res <- rbind(res,temp)
  }
  
  res <- res[-1:-2,]
  
  write.csv(res,"/data03/HCB/data/gene_cv/gene_cv3.csv")
}

{
  
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  library(ggpubr)
  library(Rcpp)
  sourceCpp(file="/data/HCB/aging/CVDemo.cpp")
  
  
  files <- array(NA,dim=c(3,2))
  files[1,] <- c("Intestine","/data/HCB/aging/ileum/scRNA4.rds")
  files[2,] <- c("Oesophagus","/data/HCB/aging/oesophagus/scRNA4.rds")
  files[3,] <- c("Heart","/data/HCB/aging/heart/scRNA4.rds")
  
  deg <- read.csv("/data/HCB/aging/data/deg_overlap.txt")
  
  res <- array("",dim=c(2,5))
  colnames(res) <- c("Tissue","group","cell_type","Gene", "Result")
  
  
  for (i in 1:3){
    cat(files[i,1],"\n")
    scRNA <- readRDS(files[i,2])
    
    temp <- deg[which(deg[,1]==files[i,1]),1:5]
    colnames(temp) <- c("Tissue","group","cell_type","Gene", "Result")
    
    group <- unique(temp[,2])
    cell_type <- unique(temp[,3])
    gene <- unique(temp[,4])
    
    temp <- array(NA,dim=c(length(group)*length(cell_type)*length(gene),5))
    colnames(temp) <- c("Tissue","group","cell_type","Gene", "Result")
    temp[,1] <- files[i,1]
    
    a <- "1"
    for(m in 1:length(group)){
      a <- c(a,rep(group[m],length(cell_type)*length(gene)))
    }
    temp[,2] <- a[-1]
    
    a <- "1"
    for(m in 1:length(cell_type)){
      a <- c(a,rep(cell_type[m],length(gene)))
    }
    a <- a[-1]
    b <- "1"
    for(m in 1:length(group)){
      b <- c(b,a)
    }
    temp[,3] <- b[-1]
    
    a <- "1"
    for(m in 1:(length(group)*length(cell_type))){
      a <- c(a,gene)
    }
    temp[,4] <- a[-1]
    
    for(j in 1:dim(temp)[1]){
      group1 <- strsplit(x=as.character(temp[j,2]),split=' vs ')[[1]][1]
      group2 <- strsplit(x=as.character(temp[j,2]),split=' vs ')[[1]][2]
      
      cluster <- strsplit(x=as.character(paste(temp[j,3],"X",sep = "")),split=' cellX')[[1]][1]
      
      t1 <- subset(scRNA, idents = cluster, features= temp[j,4], subset = group == group1)
      t2 <- subset(scRNA, idents = cluster, features= temp[j,4], subset = group == group2)
      
      t1_counts = t1@assays$RNA@data
      t2_counts = t2@assays$RNA@data
      
      r1 = 10000/length(colnames(t1))
      r2 = 10000/length(colnames(t2))
      
      if(r1<=1){
        a <- sample(1:dim(t1_counts)[2],floor(dim(t1_counts)[2]*r1),replace = F)
        t1_counts <- t1_counts[,a]
      }
      if(r2<=1){
        b <- sample(1:dim(t2_counts)[2],floor(dim(t2_counts)[2]*r2),replace = F)
        t2_counts <- t2_counts[,b]
      }
      if(class(t1_counts)!="numeric"){
        t1_counts <- c(t1_counts[1,])
      }
      if(class(t2_counts)!="numeric"){
        t2_counts <- c(t2_counts[1,])
      }
      
      temp[j,5] <- GeneCvAble(c(length(t1_counts),length(t2_counts),t1_counts,t2_counts))

    }
    res <- rbind(res,temp)
  }
  
  res <- res[-1:-2,]
  
  write.csv(res,"/data/HCB/aging/data/gene_cv/gene_cv4.csv")
}

{
  gene_CV <- read.csv("E:/数据整合_1/gene CV(无需改动)/gene_CV.csv")

  gene_CV[which(gene_CV[,2]=="youth vs mid"),2] <- "mid vs youth"
  gene_CV[which(gene_CV[,2]=="youth vs old"),2] <- "old vs youth"
  gene_CV[which(gene_CV[,2]=="youth vs supold"),2] <- "supold vs youth"
  gene_CV[which(gene_CV[,2]=="mid vs old"),2] <- "old vs mid"
  gene_CV[which(gene_CV[,2]=="mid vs supold"),2] <- "supold vs mid"
  gene_CV[which(gene_CV[,2]=="old vs supold"),2] <- "supold vs old"
  
  gene_cv1 <- read.csv("E:/数据整合_1/gene CV(无需改动)/gene_cv3.csv",row.names=1)
  gene_cv2 <- read.csv("E:/数据整合_1/gene CV(无需改动)/gene_cv4.csv",row.names=1)
  
  gene_cv1 <- rbind(gene_cv1,gene_cv2)
  
  gene_CV <- rbind(gene_CV,gene_cv1)
  
  gene_CV[which(gene_CV[,3]%in%c("γδ T cell","纬未 T cell")),3] <- "Gamma Delta T cell"
  
  
  unique(gene_CV[,2])

  gene_CV <- distinct(gene_CV,Tissue,group,cell_type,Gene,.keep_all = T)

  deg <- gene_CV
  l=4
  deg[which(deg[,l]=="1-Mar"),l] <- "MARCH1"
  deg[which(deg[,l]=="3-Mar"),l] <- "MARCH3"
  deg[which(deg[,l]=="2-Mar"),l] <- "MARCH2"
  deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
  deg[which(deg[,l]=="11-Sep"),l] <- "SEPT11"
  deg[which(deg[,l]=="4-Sep"),l] <- "4-SEP"
  
  
  res <- gene_CV[1:2,]
  data <- gene_CV[,c(1,2,4)]
  data <- distinct(data,Tissue,group,Gene,.keep_all = T)
  
  for(i in 1:dim(data)[1]){
    temp <- gene_CV[which(gene_CV[,1]==data[i,1]  &  gene_CV[,2]==data[i,2]  &  gene_CV[,4]==data[i,3] ),]
    if(dim(temp)[1] >1){
      for(j in 2:dim(temp)[1]){
        temp[1,3] <- paste(temp[1,3],";",temp[j,3],sep="")
        temp[1,5] <- paste(temp[1,5],";",temp[j,5],sep="")
      }
    }
    res <- rbind(res,temp[1,])
  }
  res <- res[-1:-2,]
  
  
  write.table(res,"E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL_Last.txt",sep=",",row.names=F)
  
  res <-read.table("E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL.txt",sep=",",header=T)
  
  "MARCH1"%in%res[,4]
  "MARCH3"%in%res[,4]
  "MARCH2"%in%res[,4]
  "SEPT11"%in%res[,4]
  "4-SEP"%in%res[,4]
  
  "1-Mar"%in%res[,4]
  "3-Mar"%in%res[,4]
  "2-Mar"%in%res[,4]
  "11-Sep"%in%res[,4]
  "4-Sep"%in%res[,4]
  
  res[which(res[,4]=="1-Mar"),4] <- "MARCH1"
  res[which(res[,4]=="3-Mar"),4] <- "MARCH3"
  res[which(res[,4]=="2-Mar"),4] <- "MARCH2"
  res[which(res[,4]=="11-Sep"),4] <- "SEPT11"
  res[which(res[,4]=="4-Sep"),4] <- "4-SEP"
  
  
  

  
  write.table(res,"E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL1.txt",sep=",",row.names=F)
  
  
}
####gene_summary
{
  setwd("E:/数据整合_1/gene summary(无需改动)")
  gene_summary <- read.table("gene_summary.txt",sep=",")
  
  a <- read.csv("websearchgenelist.csv")
  length(a[,2])
  gene_summary[,1] %in% gene_list
  setdiff(gene_summary[,1],gene_list)
  
  
  cc <- read.csv("E:/数据整合_1/cell cell communication(无需改动)/cell_cell_communication.csv")
  gene_list <- c(cc[,6],cc[,7])
  
  marker <- read.csv("E:/数据整合_1/cell marker(无需改动)/marker.csv")
  gene_list <- c(gene_list,marker[,3])
  
  deg <- read.table("E:/数据整合_1/deg overlap(无需改动)/deg_overlap.txt",sep=",")
  gene_list <- c(gene_list,deg[,4])
  
  gene_cv <- read.csv("E:/数据整合_1/gene CV(无需改动)/gene_CV.csv")
  gene_list <- c(gene_list,gene_cv[,4])
  
  scenic <- read.table("E:/数据整合_1/Scenic(已更改)/scenic1.txt",sep=",")
  gene_list <- c(gene_list,scenic[,4])
  
  gene_list <- unique(gene_list)
  
  for (i in 1:dim(scenic)[1]) {
    gene_list <- c(gene_list,strsplit(x=scenic[i,8],split=';')[[1]])
  }
  
  atac2 <- read.table("E:/数据整合_1/gene summary(无需改动)/ATAC_gene_summary.txt",sep=",")
  gene_list <-c(gene_list,atac2[,1])
  
  gene_list <- unique(gene_list)
  
  gene_list[which(gene_list=="1-Mar")] <- "MARCH1"
  gene_list[which(gene_list=="3-Mar")] <- "MARCH3"
  gene_list[which(gene_list=="2-Mar")] <- "MARCH2"
  gene_list[which(gene_list=="11-Sep")] <- "SEPT11"
    

  write.table(gene_list,"E:/数据整合_1/gene summary(无需改动)/gene_list.txt",sep=",",row.names=F)

  
  library(stringi)
  library(clusterProfiler)
  library(org.Hs.eg.db)
  
  a <- read.csv("gProfiler_hsapiens_2022-6-14 17-54-04.csv")
  # 需要转换的Ensembl_ID
  Ensembl_ID <- gene_list
  # 采用bitr()函数进行转换
  gene_symbol <- bitr(Ensembl_ID, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
  # 查看转换的结果
  gene_symbol
  
  a <- setdiff(gene_list,gene_symbol[,1])
  write.table(a,"E:/数据整合_1/gene summary(无需改动)/a.txt",sep=",",row.names=F)
  write.table(gene_symbol,"E:/数据整合_1/gene summary(无需改动)/gene_symbol.txt",sep=",",row.names=F)
  
  gene <- read.csv("E:/数据整合_1/gene summary(无需改动)/gene_symbol.csv",header=T)
  
  t <- read.csv("E:/数据整合_1/gene summary(无需改动)/gProfiler_hsapiens_2022-6-14 19-14-42.csv",header=T)
  
  gene <- gene[1:5687,]
  for(i in 1:dim(gene)[1]){
    if(gene[i,1]%in%t[,1]){
      gene[i,3] <- t[which(t[,1]==gene[i,1])[1],2]
      gene[i,4] <- t[which(t[,1]==gene[i,1])[1],4]
      gene[i,5] <- t[which(t[,1]==gene[i,1])[1],5]
    }
  }
  gene[5621:5687,2:5] <-""
  
  gene <- cbind(gene,rep("FALSE",5687))
  gene <- cbind(gene,rep("FALSE",5687))
  gene <- cbind(gene,rep("FALSE",5687))
  
  l=1
  gene[which(gene[,l]=="1-Mar"),l] <- "MARCH1"
  gene[which(gene[,l]=="3-Mar"),l] <- "MARCH3"
  gene[which(gene[,l]=="2-Mar"),l] <- "MARCH2"
  gene[which(gene[,l]=="11-Sep"),l] <- "SEPT11"
  gene[which(gene[,l]=="4-Sep"),l] <- "4-SEP"
  
    
  colnames(gene)[6:8] <- c("isInCircadian","isInImmunegenes","isInTert")
  
  gene <- read.csv("E:/数据整合_1/gene_summary1.txt",sep="\t",header=T)
  
  Circadian <- read.csv("E:/数据整合_1/gene summary(无需改动)/gene.csv")
  
  
  "3-Mar" %in%tert[,2]
  
  Immunegenes <- read.csv("E:/数据整合_1/gene summary(无需改动)/immunegenes.csv")
  tert <- read.csv("E:/数据整合_1/gene summary(无需改动)/tert.csv")
  
  length(intersect(gene[,1],Circadian[,3]))
  length(intersect(gene[,1],Immunegenes[,1]))
  length(intersect(gene[,1],tert[,2]))
  
  for(i in 1:dim(gene)[1]){
    if(gene[i,1]%in%Circadian[,3]){
      gene[i,6] <- "TRUE"
    }
    if(gene[i,1]%in%Immunegenes[,1]){
      gene[i,7] <- "TRUE"
    }
    if(gene[i,1]%in%tert[,2]){
      gene[i,8] <- "TRUE"
    }
  }
  colnames(gene)[3] <- "ENSG"
  write.table(gene,"E:/数据整合_1/gene summary(无需改动)/gene_summary.txt",sep=",",row.names=F)
  

}


##gene_summary_list
{
  gene_summary <- read.table("E:/数据整合_1/gene summary(无需改动)/gene_summary_last1_new.txt",sep=",",header=T)
  
  "1-Mar"%in%gene_summary[,1]
  "3-Mar"%in%gene_summary[,1]
  "2-Mar"%in%gene_summary[,1]
  "11-Sep"%in%gene_summary[,1]
  "4-Sep"%in%gene_summary[,1]
  
  "MARCH1"%in%gene_summary[,1]
  "MARCH3"%in%gene_summary[,1]
  "MARCH2"%in%gene_summary[,1]
  "SEPT11"%in%gene_summary[,1]
  "4-SEP"%in%gene_summary[,1]
  
  
  cc <- read.csv("E:/数据整合_1/cell cell communication(无需改动)/cell_cell_communication.csv")
  gene_list <- cc[,c(1,6)]
  gene_list1 <- cc[,c(1,7)]
  colnames(gene_list) <- c("Tissue","gene")
  colnames(gene_list1) <- c("Tissue","gene")
  gene_list <- rbind(gene_list,gene_list1)
  gene_list <- distinct(gene_list,Tissue,gene,.keep_all = T)
  
  marker <- read.csv("E:/数据整合_1/cell marker(无需改动)/marker.csv")
  gene_list1 <- marker[,c(1,3)]
  colnames(gene_list1) <- c("Tissue","gene")
  gene_list <- rbind(gene_list,gene_list1)
  
  deg <- read.table("E:/数据整合_1/deg overlap(无需改动)/deg_overlap.txt",sep=",")
  gene_list1 <- deg[,c(1,4)]
  colnames(gene_list1) <- c("Tissue","gene")
  gene_list <- rbind(gene_list,gene_list1)
  
  gene_cv <- read.table("E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL.txt",sep=",",header=T)
  gene_list1 <- gene_cv[,c(1,4)]
  colnames(gene_list1) <- c("Tissue","gene")
  gene_list <- rbind(gene_list,gene_list1)
  
  scenic <- read.table("E:/数据整合_1/Scenic(已更改)/scenic1.txt",sep=",")
  gene_list1 <- scenic[,c(1,4)]
  colnames(gene_list1) <- c("Tissue","gene")
  gene_list <- rbind(gene_list,gene_list1)
  
  
  atac2 <- read.table("E:/数据整合_1/gene summary(无需改动)/gene_summary3.txt",sep=",",header=T)
  gene_list1 <- atac2[,c(2,1)]
  colnames(gene_list1) <- c("Tissue","gene")
  
  f<- gene_list1[which(gene_list1[,1]=="Esophagus-Muscularis"),2] 
  f <- intersect(f,gene_list[which(gene_list[,1]=="Oesophagus"),2])
  
  gene_list[which(gene_list[,1]=="Oesophagus" & gene_list[,2]%in%f),1] <- "Oesophagus|Esophagus-Muscularis"
  gene_list1[which(gene_list1[,1]=="Esophagus-Muscularis" & gene_list1[,2]%in%f),1] <- "Oesophagus|Esophagus-Muscularis"

  gene_list <- rbind(gene_list,gene_list1)
  
  gene_list[which(gene_list[,1]=="Bladder" & gene_list[,2]=="S100A11"),]
  
  
  gene_list <- distinct(gene_list,Tissue,gene,.keep_all = T)
  
  
  gene_summary <- cbind(gene_summary,rep("",dim(gene_summary)[1]))
  colnames(gene_summary)[11] <- "Tissue"
 
  for(i in 1:dim(gene_summary)[1]){
    gene <- gene_summary[i,1]
    tissue <- unique(gene_list[which(gene_list[,2]==gene),1])  
    
    temp <- tissue[1]
    if(length(tissue)>1){
      for(j in 2:length(tissue)){
        temp <- paste(temp,";",tissue[j],sep="")
      }
    }
    gene_summary[i,11] <- temp
  }

  write.table(gene_summary,"E:/数据整合_1/gene summary(无需改动)/gene_summary_last2.txt",sep=",",row.names=F)
  gene <- gene_summary
  
  write.table(gene,"E:/数据整合_1/gene summary(无需改动)/gene_summary_last1_new.txt",sep=",",row.names=F)
}

###疾病
{
  res <- read.csv("/data03/HCB/aging/疾病/all_gene_disease_pmid_associations.tsv/all_gene_disease_pmid_associations.csv")
  
  res[which(res[,2]=="1-Mar"),1] <- "MARCH1"
  res[which(res[,2]=="3-Mar"),1] <- "MARCH3"
  res[which(res[,2]=="2-Mar"),1] <- "MARCH2"
  res[which(res[,2]=="11-Sep"),1] <- "SEPT11"
  res[which(res[,2]=="4-Sep"),1] <- "4-SEP"

  gene <- read.table("/data03/HCB/aging/疾病/gene_summary_last.txt",sep=",",header=T)
  gene <- gene[,1]
  
  res <- res[which(res[,2]%in%gene),]
  
  write.table(res,"/data03/HCB/aging/疾病/disease_overlap.txt",sep=",",row.names=F)
  
  
  
  data <- disease_overlap[,5:9]
  data <- distinct(data,diseaseId,.keep_all = T)
  write.table(data,"/data03/HCB/aging/疾病/disease_ID.txt",sep=",",row.names=F)
  
  ans <- disease_overlap[,-6:-9]
  
  data <- ans[,c(1)]
  data <- unique(data)
  
  for(i in 1:length(data)){
    temp <- ans[which(ans[,1]==data[i]),]
    
    pmid <- length(unique(temp[,"pmid"])) 
    
    ans[which(ans[,1]==data[i]),"pmid"] <- pmid
  }
  ans <- distinct(ans,geneId,geneSymbol,DSI,DPI,diseaseId,score,EI,YearInitial,YearFinal,pmid,source,.keep_all = T)
  write.table(ans,"/data03/HCB/aging/疾病/disease_overlap_res_new.txt",sep=",",row.names=F)
  

}


#####药物
{
  drug <- read.csv("/data03/HCB/drug/CTD_chem_gene_ixns.csv")
  drug <- drug[,c(1,2,4,6,9,11)]
  colnames(drug) <- c("ChemicalName","ChemicalID","GeneSymbol","GeneForms","InteractionActions","PubMedIDs")
  
  gene <- read.table("/data03/HCB/aging/疾病/gene_summary_last.txt",sep=",",header=T)
  gene <- gene[,1]
  
  drug <- drug[which(drug[,3]%in%gene),]
  
  res <- drug[1:2,]
  
  data <- unique(drug[,3])

  
  for(i in 1:length(data)){
    
    temp <- drug[which(drug[,3]==data[i]),]
    
    for(j in 1:dim(temp)[1]){
      for(k in c(1,5)){
        temp[j,k] <- gsub(","," ",temp[j,k])
        temp[j,k] <- gsub(";","|",temp[j,k])
      }
    }
    
    if(dim(temp)[1] >1){
      for(j in 2:dim(temp)[1]){
        for(k in c(1,2,4,5,6)){
          temp[1,k] <- paste(temp[1,k],";",temp[j,k],sep="")
        }
      }
    }
    res <- rbind(res,temp[1,])
  }
  res <- res[-1:-2,]
  write.table(drug,"/data03/HCB/drug/drug_overlap_last_new.txt",sep=",",row.names=F)
  
}

{
             
  {
    Kidneys_A <- gene[which(gene[,1] == "Kidneys" & gene[,3] == "Collecting_duct_A cell"),4]
    Kidneys_B <- gene[which(gene[,1] == "Kidneys" & gene[,3] == "Collecting_duct_B cell"),4]
    
    Lung <- unique(gene[which(gene[,3] == "Endothelial cell"),1])   "Endothelial Lymphatic cell"
    
    Skeletal-muscle "B cell" "B T NK cell"
    
    
    Stomach  "Fibroblasts cell" "Fibroblasts myofibroblasts cell"
    
    "Smooth muscle cell"    "Smooth muscle myofibroblasts cell"        
  }
}
{
  ##deg_overlap
  {
    deg <- read.table("E:/数据整合_1/deg overlap(无需改动)/deg_specific_overlap.txt",sep=",")
    
    Kidneys_A <- read.table("E:/数据整合_1/deg overlap(无需改动)/Collecting_duct_A_DEG_mid_old.txt",sep="",header=T)
    Kidneys_A <- row.names(Kidneys_A[which(Kidneys_A[,6] %in% c("DOWN","UP")),])
    Kidneys_B <- read.table("E:/数据整合_1/deg overlap(无需改动)/Collecting_duct_B_DEG_mid_old.txt",sep="",header=T)
    Kidneys_B <- row.names(Kidneys_B[which(Kidneys_B[,6] %in% c("DOWN","UP")),])
    gene <- deg[which(deg[,j]=="Collecting cell" & deg[,i] =="Kidneys"),k] 
    gene_A <- intersect(gene,Kidneys_A)
    gene_B <- setdiff(gene,Kidneys_A)
    c(gene_A,gene_B) %in% gene
    gene %in% c(gene_A,gene_B)
    Kidneys_A <- gene_A
    Kidneys_B <- gene_B
    
    i = 1
    j = 3
    k = 4
    
    
    deg[which(deg[,i]=="Kidneys" & deg[,j]=="Collecting cell" & deg[,k]%in% Kidneys_A),j] <- "Collecting_duct_A cell"
    deg[which(deg[,i]=="Kidneys" & deg[,j]=="Collecting cell" & deg[,k]%in% Kidneys_B),j] <- "Collecting_duct_B cell"
    
    deg[which(deg[,i]=="Lung" & deg[,j]=="Endothelial cell"),j] <- "Endothelial Lymphatic cell"
    
    deg[which(deg[,i]=="Skeletal-muscle" & deg[,j]=="B cell"),j] <- "B T NK cell"
    
    deg[which(deg[,i]=="Stomach" & deg[,j]=="Fibroblasts cell"),j] <-"Fibroblasts myofibroblasts cell"
    deg[which(deg[,i]=="Stomach" & deg[,j]=="Smooth muscle cell"),j] <-"Smooth muscle myofibroblasts cell"
    
    
    write.table(deg,"E:/数据整合_1/deg overlap(无需改动)/deg_specific_overlap_new.txt",sep=",")
  }
  
  ##enrichment
  {
    deg <- read.table("E:/数据整合_1/enrichment overlap(无需改动)/enrichment_overlap.txt",header=T,sep=",")
    
    temp <- deg[1:2,]
    
    
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    Up_ID <- intersect(rownames(Kidneys_A)[which(Kidneys_A[,'change']=="UP")],gene_A) 
    transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
    eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
    eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
    
    a <- as.data.frame(eGo_ALL@result)
    a <- cbind(rep("UP",89),a)
    a <- cbind(rep("Collecting_duct_A cell",89),a)
    a <- cbind(rep("old vs mid",89),a)
    a <- cbind(rep("Kidneys",89),a)
    a <- cbind(a,rep("2022/4/26",89))
    a <- cbind(a,rep("2022/4/26",89))
    colnames(a) <- colnames(temp)
    temp <- rbind(temp,a)
    
    
    Up_ID <- intersect(rownames(Kidneys_B)[which(Kidneys_B[,'change']=="UP")],gene_B) 
    DOWN_ID <- intersect(rownames(Kidneys_B)[which(Kidneys_B[,'change']=="DOWN")],gene_B)
    
    transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
    eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
    eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
    
    a <- as.data.frame(eGo_ALL@result)
    a <- cbind(rep("UP",160),a)
    a <- cbind(rep("Collecting_duct_B cell",160),a)
    a <- cbind(rep("old vs mid",160),a)
    a <- cbind(rep("Kidneys",160),a)
    a <- cbind(a,rep("2022/4/26",160))
    a <- cbind(a,rep("2022/4/26",160))
    colnames(a) <- colnames(temp)
    temp <- rbind(temp,a)
    
    temp <- temp[-1:-2,]
    deg <- deg[-which(deg[,1]=="Kidneys" & deg[,3]=="Collecting cell"),]
    
    deg <- rbind(deg,temp)
    
    
    i = 1
    j = 3
    
    deg[which(deg[,i]=="Lung" & deg[,j]=="Endothelial cell"),j] <- "Endothelial Lymphatic cell"
    
    deg[which(deg[,i]=="Skeletal-muscle" & deg[,j]=="B cell"),j] <- "B T NK cell"
    
    deg[which(deg[,i]=="Stomach" & deg[,j]=="Fibroblasts cell"),j] <-"Fibroblasts myofibroblasts cell"
    deg[which(deg[,i]=="Stomach" & deg[,j]=="Smooth muscle cell"),j] <-"Smooth muscle myofibroblasts cell"
    
    write.table(deg,"E:/数据整合_1/enrichment overlap(无需改动)/enrichment_overlap_new.txt",sep=",")
  }

  ##gene_CV
  {
    deg <- read.table("E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL1.txt",sep=",",header=T)
    
    for(l in 1:dim(deg)[1]){
      if(deg[l,1]=="Kidneys" & deg[l,4]%in% Kidneys_A){
        deg[l,3] <- gsub("Collecting cell","Collecting_duct_A cell",deg[l,3])
      }else if(deg[l,1]=="Kidneys" & deg[l,4]%in% Kidneys_B){
        deg[l,3] <- gsub("Collecting cell","Collecting_duct_B cell",deg[l,3])
      }else if(deg[l,1]=="Lung"){
        deg[l,3] <- gsub("Endothelial cell","Endothelial Lymphatic cell",deg[l,3])
      }else if(deg[l,1]=="Skeletal-muscle"){
        deg[l,3] <- gsub("B cell","B T NK cell",deg[l,3])
      }else if(deg[l,1]=="Stomach"){
        deg[l,3] <- gsub("Fibroblasts cell","Fibroblasts myofibroblasts cell",deg[l,3])
        deg[l,3] <- gsub("Smooth muscle cell","Smooth muscle myofibroblasts cell",deg[l,3])
      }
      
    }
    
    
    write.table(deg,"E:/数据整合_1/gene CV(无需改动)/gene_CV_ALL1_new.txt",sep=",")
  }
  
  
  ##scenic1
  {
    deg <- read.table("E:/数据整合_1/Scenic(已更改)/scenic1.txt",row.names=1,sep=",")

    for(l in 1:dim(deg)[1]){
      if(deg[l,1]=="Kidneys" & deg[l,4]%in% Kidneys_A){
        deg[l,3] <- gsub("Collecting cell","Collecting_duct_A cell",deg[l,3])
      }else if(deg[l,1]=="Kidneys" & deg[l,4]%in% Kidneys_B){
        deg[l,3] <- gsub("Collecting cell","Collecting_duct_B cell",deg[l,3])
      }else if(deg[l,1]=="Lung"){
        deg[l,3] <- gsub("Endothelial cell","Endothelial Lymphatic cell",deg[l,3])
      }else if(deg[l,1]=="Skeletal-muscle"){
        deg[l,3] <- gsub("B cell","B T NK cell",deg[l,3])
      }else if(deg[l,1]=="Stomach"){
        deg[l,3] <- gsub("Fibroblasts cell","Fibroblasts myofibroblasts cell",deg[l,3])
        deg[l,3] <- gsub("Smooth muscle cell","Smooth muscle myofibroblasts cell",deg[l,3])
      }
      
    }
    
    write.table(deg,"E:/数据整合_1/Scenic(已更改)/scenic1_new.txt",sep=",")
  }
  
}
"Kidneys"           "Collecting cell",       "Collecting_duct_A cell"  "Collecting_duct_B cell"
"Lung"              "Endothelial cell",      "Endothelial Lymphatic cell"
"Skeletal-muscle"   "B cell",                "B T NK cell"
"Stomach"           "Fibroblasts cell",      "Fibroblasts myofibroblasts cell"
"Stomach"           "Smooth muscle cell",    "Smooth muscle myofibroblasts cell"

###################################################################################################胰腺pancreas
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  {
    expr1 <- read_tsv("/data03/HCB/aging/Pancreas/Neonatal_Pancreas/exprMatrix.tsv")
    expr1 <- as.data.frame(expr1)
    rownames(expr1) <- expr1[,1]
    meta <- read_tsv("/data03/HCB/aging/Pancreas/Neonatal_Pancreas/meta.tsv")
    meta <- as.data.frame(meta)
    meta1 <- meta
    meta1 <- distinct(meta1,patient_ID,.keep_all = T)
    
    for (i in 1:length(rownames(meta1))) {
      meta_temp <- meta[which(meta[,3]==meta1[i,3]),]
      temp <- expr1[,meta_temp[,1]]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","youth",i,sep = "")
      if(i==1){  
        scdata <- temp
      }else{
        scdata <- cbind(scdata,temp)  
      }
    }
    saveRDS(scdata, "scdata.rds")
    scdata <- readRDS("scdata.rds")
    
    expr <- read_tsv("/data03/HCB/aging/Pancreas/Adult_Pancreas/exprMatrix.tsv")
    expr <- as.data.frame(expr)
    rownames(expr) <- expr[,1]
    meta <- read_tsv("/data03/HCB/aging/Pancreas/Adult_Pancreas/meta.tsv")
    meta <- as.data.frame(meta)
    meta <- cbind(meta,rep(NA,length(rownames(meta))))
    colnames(meta)[length(colnames(meta))] <- "Sample_ID"
    for (i in 1:length(rownames(meta))) {
      meta$Sample_ID[i] <- strsplit(x=as.character(meta[i,1]),split='_')[[1]][2]
    }
    meta1 <- meta
    meta1 <- distinct(meta1,patient_ID,age,Sample_ID,.keep_all = T)
    
    meta2 <- meta1[which(meta1[,4]<=20),]
    for (i in 1:length(rownames(meta2))){
      meta_temp <- meta[which(meta[,2]==meta1[i,2]&meta[,10]==meta1[i,10]),]
      temp <- expr[,meta_temp[,1]]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","youth",i+2,sep = "")
      if(i==1){  
        scdata2 <- temp
      }else{
        scdata2 <- cbind(scdata2,temp)  
      } 
    }
    meta2 <- meta1[which(meta1[,4]>20&meta1[,4]<=60),]
    for (i in 1:length(rownames(meta2))){
      meta_temp <- meta[which(meta[,2]==meta1[i,2]&meta[,10]==meta1[i,10]),]
      temp <- expr[,meta_temp[,1]]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","mid",i,sep = "")
      scdata2 <- cbind(scdata2,temp)
    }
    meta2 <- meta1[which(meta1[,4]>60),]
    for (i in 1:length(rownames(meta2))){
      meta_temp <- meta[which(meta[,2]==meta1[i,2]&meta[,10]==meta1[i,10]),]
      temp <- expr[,meta_temp[,1]]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","old",i,sep = "")
      scdata2 <- cbind(scdata2,temp)  
    }
    
    a<-rownames(scdata2)
    for (i in 1:length(a)) {
      a[i] <- strsplit(x=as.character(a[i]),split='[|]')[[1]][1]
    }
    rownames(scdata2) <- a
    a <- intersect(rownames(scdata2),rownames(scdata))
    
    scdata <- scdata[a,]
    scdata2 <- scdata2[a,]
    experiment.data <- cbind(scdata,scdata2)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      names.delim = "_")
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=2000
    maxUMI=10000
    pctMT=20
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1.5) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("pancreas.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `0` = "Ductal", `2` = "Ductal",`15` = "Ductal",`21` = "Ductal",`22` = "Ductal",`25` = "Ductal",
                          `18` = "Alpha",
                          `13` = "Beta",
                          `23` = "Delta",
                          `14` = "Endothelial",
                          `24` = "Macrophages",
                          `16` = "Activated Stellate",
                          `3` = "Acinar-s",`4` = "Acinar-s",`5` = "Acinar-s",`8` = "Acinar-s",`10` = "Acinar-s",
                          `1` = "Acinar-i",`6` = "Acinar-i",`7` = "Acinar-i",`9` = "Acinar-i",`11` = "Acinar-i",`12` = "Acinar-i",`17` = "Acinar-i",
                          `19` = "Acinar-i",`20` = "Acinar-i",`26` = "Acinar-i"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
        {orig_ident[i]="youth"}
      else if(temp=="mid")
        {orig_ident[i]="mid"}
      else
        {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    
    ##############################Cluster图
    value_temp <- c("Endothelial" = "#CC6699","Acinar-s" = "#CC33CC", "Ductal" = "#6699CC", "Delta" = "#FFCC00", "Macrophages" = "#33CCCC",
                    "Acinar-i" = "#FF3366","Beta" = "#FF33FF", "Alpha" = "#9933CC", "Activated Stellate" = "#663300")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")

    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
                                     panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
                                     ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
                                     panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
                                     ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }


    
  }

  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-old
    if(!dir.exists(paste("./result/DEG/youth-old/"))){
      dir.create(paste("./result/DEG/youth-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }

    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }

        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }

        }
      }
    }
   
    ##############youth-old
    if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                          axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }

  ###表达模式
  {
    filea <- "/data03/HCB/aging/Pancreas/analysis/result/DEG/"
    setwd(paste(filea,"mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    
    if(!dir.exists(paste(filea,"patten/",sep = ""))){
      dir.create(paste(filea,"patten/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/UP/",sep = ""))){
      dir.create(paste(filea,"patten/UP/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/DOWN/",sep = ""))){
      dir.create(paste(filea,"patten/DOWN/",sep = ""))
    }
    
    for (i in 1:dim(temp)[1]) {
      youth_mid <- read.table(paste(filea,"youth-mid/",temp[i,3],"_DEG_youth_mid.txt",sep = ""))
      mid_old <- read.table(paste(filea,"mid-old/",temp[i,3],"_DEG_mid_old.txt",sep = ""))
      youth_old <- read.table(paste(filea,"youth-old/",temp[i,3],"_DEG_youth_old.txt",sep = ""))
      #########UP
      youth_mid_old_UP_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="UP")],rownames(mid_old)[which(mid_old[,"change"]=="UP")])
      rep_youth_old_gene <- intersect(youth_mid_old_UP_gene,rownames(youth_old)[which(youth_old[,"change"]=="UP")])
      a <- length(youth_mid_old_UP_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        UP <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(UP) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(UP) <- c("youth_mid_old_UP")
        UP[1,1:a] <- c(youth_mid_old_UP_gene,rep(NA,a))[1:a]
        UP[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(UP,paste(filea,"patten/UP/",temp[i,3],"_UP.txt",sep = ""))
      }
      #########DOWN
      youth_mid_old_DOWN_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="DOWN")],rownames(mid_old)[which(mid_old[,"change"]=="DOWN")])
      rep_youth_old_gene <- intersect(youth_mid_old_DOWN_gene,rownames(youth_old)[which(youth_old[,"change"]=="DOWN")])
      a <- length(youth_mid_old_DOWN_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        DOWN <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(DOWN) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(DOWN) <- "youth_mid_old_DOWN"
        DOWN[1,1:a] <- c(youth_mid_old_DOWN_gene,rep(NA,a))[1:a]
        DOWN[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(DOWN,paste(filea,"patten/DOWN/",temp[i,3],"_DOWN.txt",sep = ""))
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(Rcpp)
    library(ggpubr)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/Pancreas/analysis/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
               add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth-old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth-old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        youth_counts = youth@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(old_counts[j,]),youth_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        filea <- "/data03/HCB/aging/Pancreas/analysis/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <-  intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
          
        }
        #############youth_old
        if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
    {
      cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_mid/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/Pancreas/analysis/result/Scenic/youth_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
 
    filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
 
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    tf <- tf[which(tf[,1]%in%gene_overlap),]
    
    filea <- "/data03/HCB/aging/Pancreas/analysis/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/Pancreas/analysis/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 1000,height = 800)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 1000,height = 800)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 1000,height = 800)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/Pancreas/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
      ########youth-old
      {
        setwd(paste(filea,"result/DEG/youth-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########youth-mid
      {
        setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/pancreas.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/Pancreas/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/pancreas.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/Pancreas/analysis/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/pancreas.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,2)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number")
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
    }
    res[length(celltype)+1,1] <- sum(res[1:length(celltype),1])
    res[length(celltype)+1,2] <- sum(res[1:length(celltype),2])
    res[length(celltype)+1,1]==dim(scRNA@meta.data)[1]
    res[length(celltype)+1,2]==dim(gene)[1]
    
    write.csv(res,"/data03/HCB/aging/cell_number/pancreas.csv")
  }
  
}





######################################################################################################血液blood
#10X 数据
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    youth1 <- Read10X("/data03/HCB/aging/blood/H1/")
    youth2 <- Read10X("/data03/HCB/aging/blood/H2/")
    youth3 <- Read10X("/data03/HCB/aging/blood/H3/")
    colnames(youth1) <- paste(colnames(youth1),"youth1",sep = "_")
    colnames(youth2) <- paste(colnames(youth2),"youth2",sep = "_")
    colnames(youth3) <- paste(colnames(youth3),"youth3",sep = "_")
    
    
    mid1 <- Read10X("/data03/HCB/aging/blood/32190_33/")
    mid2 <- Read10X("/data03/HCB/aging/blood/41540_32/")
    mid3 <- Read10X("/data03/HCB/aging/blood/45044_25/")
    mid4 <- Read10X("/data03/HCB/aging/blood/83775_43/")
    mid5 <- Read10X("/data03/HCB/aging/blood/85037_25/")
    colnames(mid1) <- paste(colnames(mid1),"mid1",sep = "_")
    colnames(mid2) <- paste(colnames(mid2),"mid2",sep = "_")
    colnames(mid3) <- paste(colnames(mid3),"mid3",sep = "_")
    colnames(mid4) <- paste(colnames(mid4),"mid4",sep = "_")
    colnames(mid5) <- paste(colnames(mid5),"mid5",sep = "_")
    mid6 <- read.csv("/data03/HCB/aging/blood/CT1_50s.csv",row.names = 1)
    mid6 <- distinct(mid6,gene,.keep_all = T)
    rownames(mid6) <- mid6[,1]
    mid6 <- mid6[,-1]
    colnames(mid6) <- paste(gsub("[.]","-",colnames(mid6)),"_mid6",sep = "")
    
    
    old1 <- read.csv("/data03/HCB/aging/blood/CT2_70s.csv",row.names = 1)
    old1 <- distinct(old1,gene,.keep_all = T)
    rownames(old1) <- old1[,1]
    old1 <- old1[,-1]
    colnames(old1) <- paste(gsub("[.]","-",colnames(old1)),"_old1",sep = "")
    old2 <- read.csv("/data03/HCB/aging/blood/CT3_60s.csv",row.names = 1)
    old2 <- distinct(old2,gene,.keep_all = T)
    rownames(old2) <- old2[,1]
    old2 <- old2[,-1]
    colnames(old2) <- paste(gsub("[.]","-",colnames(old2)),"_old2",sep = "")
    old3 <- read.csv("/data03/HCB/aging/blood/CT4_70s.csv",row.names = 1)
    old3 <- distinct(old3,gene,.keep_all = T)
    rownames(old3) <- old3[,1]
    old3 <- old3[,-1]
    colnames(old3) <- paste(gsub("[.]","-",colnames(old3)),"_old3",sep = "")
    old4 <- read.csv("/data03/HCB/aging/blood/CT5_80s.csv",row.names = 1)
    old4 <- distinct(old4,gene,.keep_all = T)
    rownames(old4) <- old4[,1]
    old4 <- old4[,-1]
    colnames(old4) <- paste(gsub("[.]","-",colnames(old4)),"_old4",sep = "")
    
    
    supold1 <- read.csv("/data03/HCB/aging/blood/SC1_110s.csv",row.names = 1)
    supold1 <- distinct(supold1,gene,.keep_all = T)
    rownames(supold1) <- supold1[,1]
    supold1 <- supold1[,-1]
    colnames(supold1) <- paste(gsub("[.]","-",colnames(supold1)),"_supold1",sep = "")
    
    supold2 <- read.csv("/data03/HCB/aging/blood/SC2_110s.csv",row.names = 1)
    supold2 <- distinct(supold2,gene,.keep_all = T)
    rownames(supold2) <- supold2[,1]
    supold2 <- supold2[,-1]
    colnames(supold2) <- paste(gsub("[.]","-",colnames(supold2)),"_supold2",sep = "")
    
    supold3 <- read.csv("/data03/HCB/aging/blood/SC3_110s.csv",row.names = 1)
    supold3 <- distinct(supold3,gene,.keep_all = T)
    rownames(supold3) <- supold3[,1]
    supold3 <- supold3[,-1]
    colnames(supold3) <- paste(gsub("[.]","-",colnames(supold3)),"_supold3",sep = "")
    
    supold4 <- read.csv("/data03/HCB/aging/blood/SC4_110s.csv",row.names = 1)
    supold4 <- distinct(supold4,gene,.keep_all = T)
    rownames(supold4) <- supold4[,1]
    supold4 <- supold4[,-1]
    colnames(supold4) <- paste(gsub("[.]","-",colnames(supold4)),"_supold4",sep = "")
    
    supold5 <- read.csv("/data03/HCB/aging/blood/SC5_110s.csv",row.names = 1)
    supold5 <- distinct(supold5,gene,.keep_all = T)
    rownames(supold5) <- supold5[,1]
    supold5 <- supold5[,-1]
    colnames(supold5) <- paste(gsub("[.]","-",colnames(supold5)),"_supold5",sep = "")
    
    supold6 <- read.csv("/data03/HCB/aging/blood/SC6_110s.csv",row.names = 1)
    supold6 <- distinct(supold6,gene,.keep_all = T)
    rownames(supold6) <- supold6[,1]
    supold6 <- supold6[,-1]
    colnames(supold6) <- paste(gsub("[.]","-",colnames(supold6)),"_supold6",sep = "")
    
    supold7 <- read.csv("/data03/HCB/aging/blood/SC7_110s.csv",row.names = 1)
    supold7 <- distinct(supold7,gene,.keep_all = T)
    rownames(supold7) <- supold7[,1]
    supold7 <- supold7[,-1]
    colnames(supold7) <- paste(gsub("[.]","-",colnames(supold7)),"_supold7",sep = "")
    
    
    a <- intersect(rownames(youth1),rownames(youth2))
    a <- intersect(a,rownames(mid1))
    a <- intersect(a,rownames(old1))
    a <- intersect(a,rownames(supold1))
    length(a)
    
    youth1 <- youth1[a,]
    youth2 <- youth2[a,]
    youth3 <- youth3[a,]
    mid1 <- mid1[a,]
    mid2 <- mid2[a,]
    mid3 <- mid3[a,]
    mid4 <- mid4[a,]
    mid5 <- mid5[a,]
    mid6 <- mid6[a,]
    old1 <- old1[a,]
    old2 <- old2[a,]
    old3 <- old3[a,]
    old4 <- old4[a,]
    supold1 <- supold1[a,]
    supold2 <- supold2[a,]
    supold3 <- supold3[a,]
    supold4 <- supold4[a,]
    supold5 <- supold5[a,]
    supold6 <- supold6[a,]
    supold7 <- supold7[a,]
    
    experiment.data <- cbind(youth1,youth2)
    experiment.data <- cbind(experiment.data,youth3)
    scRNA1 <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    experiment.data <- cbind(mid1,mid2)
    experiment.data <- cbind(experiment.data,mid3)
    experiment.data <- cbind(experiment.data,mid4)
    experiment.data <- cbind(experiment.data,mid5)
    scRNA2 <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    experiment.data <- cbind(old1,old2)
    experiment.data <- cbind(experiment.data,old3)
    experiment.data <- cbind(experiment.data,old4)
    scRNA3 <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    experiment.data <- cbind(supold1,supold2)
    experiment.data <- cbind(experiment.data,supold3)
    experiment.data <- cbind(experiment.data,supold4)
    experiment.data <- cbind(experiment.data,supold5)
    experiment.data <- cbind(experiment.data,supold6)
    experiment.data <- cbind(experiment.data,supold7)
    scRNA4 <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    scRNA5 <- CreateSeuratObject(
      mid6,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    scRNA <- merge(scRNA1,scRNA2)
    scRNA <- merge(scRNA,scRNA3)
    scRNA <- merge(scRNA,scRNA4)
    scRNA <- merge(scRNA,scRNA5)
    
    rm(scRNA1)
    rm(scRNA2)
    rm(scRNA3)
    rm(scRNA4)
    rm(scRNA5)
    
    #mat <- Matrix(data = 0L, nrow=320127, ncol = 8189, sparse = TRUE)
    #object.size(mid6)
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=2000
    maxUMI=10000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident", plot_convergence = FALSE,max.iter.harmony = 30) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 2) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("blood.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `6` = "naive B", `16` = "naive B", `24` = "naive B", `28` = "naive B", `31` = "naive B", 
                          `0` = "naive CD4+ T",`4` = "naive CD4+ T",`5` = "naive CD4+ T",
                          `1` = "Activated CD8+ T",`2` = "Activated CD8+ T",`3` = "Activated CD8+ T",`7` = "Activated CD8+ T",`8` = "Activated CD8+ T",
                          `10` = "Activated CD8+ T",`11` = "Activated CD8+ T",`12` = "Activated CD8+ T",`27` = "Activated CD8+ T",`30` = "Activated CD8+ T",
                          `18` = "γδ T",
                          `20` = "megakaryocytes",
                          `23` = "mDC type 2",`26` = "mDC type 2",
                          `9` = "Granulocytes",`13` = "Granulocytes",`15` = "Granulocytes",`17` = "Granulocytes",`21` = "Granulocytes",
                          `22` = "Granulocytes",`29` = "Granulocytes",
                          `14` = "Blood derived monocyte",
                          `25` = "Plasmacytoid dendritic",
                          `19` = "T-cell 2"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else if(temp=="old")
      {orig_ident[i]="old"}
      else{orig_ident[i]="supold"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA1.rds")
    #scRNA <- readRDS("scRNA1.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,6]))
    ##############################Cluster图
    value_temp <- c("naive B" = "#CC6699","naive CD4+ T" = "#CC33CC", "Activated CD8+ T" = "#6699CC", "γδ T" = "#FFCC00", "mDC type 2" = "#33CCCC",
                    "megakaryocytes" = "#FF3366","Granulocytes" = "#FF33FF", "Blood derived monocyte" = "#9933CC", "Plasmacytoid dendritic" = "#663300",
                    "T-cell 2" = "#99FF99")
 
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066","supold"="darkred")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF","supold"="#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF","supold"="#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066","supold"="#FFFFFF")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#FFFFFF","supold"="darkred")
      png(paste0("./result/CellGroup4.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA1.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-old
    if(!dir.exists(paste("./result/DEG/youth-old/"))){
      dir.create(paste("./result/DEG/youth-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################old-supold
    if(!dir.exists(paste("./result/DEG/old-supold/"))){
      dir.create(paste("./result/DEG/old-supold/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'old', ident.2 = 'supold', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/old-supold/",cluster[i],"_DEG_old_supold.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/old-supold/",cluster[i],"_DEG_old_supold.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-supold
    if(!dir.exists(paste("./result/DEG/youth-supold/"))){
      dir.create(paste("./result/DEG/youth-supold/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'supold', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-supold/",cluster[i],"_DEG_youth_supold.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-supold/",cluster[i],"_DEG_youth_supold.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################mid-supold
    if(!dir.exists(paste("./result/DEG/mid-supold/"))){
      dir.create(paste("./result/DEG/mid-supold/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'supold', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-supold/",cluster[i],"_DEG_mid_supold.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-supold/",cluster[i],"_DEG_mid_supold.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
    
    
    
    
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/blood/analsis/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
          
        }
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############youth-supold
    if(!dir.exists(paste(filea,"DEG/GO/youth-supold/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-supold/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-supold/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-supold/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-supold/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############mid-supold
    if(!dir.exists(paste(filea,"DEG/GO/mid-supold/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-supold/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-supold/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-supold/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-supold/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############old-supold
    if(!dir.exists(paste(filea,"DEG/GO/old-supold/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/old-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/old-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/old-supold/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/old-supold/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/old-supold/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/old-supold/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  ###表达模式
  {
    filea <- "/data03/HCB/aging/blood/analsis/result/DEG/"
    setwd(paste(filea,"mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]

    if(!dir.exists(paste(filea,"patten/",sep = ""))){
      dir.create(paste(filea,"patten/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/UP/",sep = ""))){
      dir.create(paste(filea,"patten/UP/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/DOWN/",sep = ""))){
      dir.create(paste(filea,"patten/DOWN/",sep = ""))
    }
    
    for (i in 1:dim(temp)[1]) {
      youth_mid <- read.table(paste(filea,"youth-mid/",temp[i,3],"_DEG_youth_mid.txt",sep = ""))
      mid_old <- read.table(paste(filea,"mid-old/",temp[i,3],"_DEG_mid_old.txt",sep = ""))
      old_supold <- read.table(paste(filea,"old-supold/",temp[i,3],"_DEG_old_supold.txt",sep = ""))
      
      youth_old <- read.table(paste(filea,"youth-old/",temp[i,3],"_DEG_youth_old.txt",sep = ""))
      youth_supold <- read.table(paste(filea,"youth-supold/",temp[i,3],"_DEG_youth_supold.txt",sep = ""))
      mid_supold <- read.table(paste(filea,"mid-supold/",temp[i,3],"_DEG_mid_supold.txt",sep = ""))
      #########UP
      youth_mid_old_UP_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="UP")],rownames(mid_old)[which(mid_old[,"change"]=="UP")])
      mid_old_supold_UP_gene <- intersect(rownames(mid_old)[which(mid_old[,"change"]=="UP")],rownames(old_supold)[which(old_supold[,"change"]=="UP")])
      youth_mid_old_supold_UP_gene <- intersect(youth_mid_old_UP_gene,mid_old_supold_UP_gene)
      
      rep_youth_old_gene <- intersect(youth_mid_old_UP_gene,rownames(youth_old)[which(youth_old[,"change"]=="UP")])
      rep_mid_supold_gene <- intersect(mid_old_supold_UP_gene,rownames(mid_supold)[which(mid_supold[,"change"]=="UP")])
      rep_youth_supold_gene <- intersect(youth_mid_old_supold_UP_gene,rownames(youth_supold)[which(youth_supold[,"change"]=="UP")])
     
      a <- max(length(youth_mid_old_UP_gene),length(mid_old_supold_UP_gene),length(youth_mid_old_supold_UP_gene))
      b <- max(length(rep_youth_old_gene),length(rep_mid_supold_gene),length(rep_youth_supold_gene))
      
      UP <- as.data.frame(array(NA,dim = c(3,a+b)))
      colnames(UP) <- c(rep("gene",a),rep("rep_gene",b))
      rownames(UP) <- c("youth_mid_old_UP","mid_old_supold_UP","youth_mid_old_supold_UP")
      
      UP[1,1:a] <- c(youth_mid_old_UP_gene,rep(NA,a))[1:a]
      UP[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
      UP[2,1:a] <- c(mid_old_supold_UP_gene,rep(NA,a))[1:a]
      UP[2,(a+1):(a+b)] <- c(rep_mid_supold_gene,rep(NA,a))[1:b]
      UP[3,1:a] <- c(youth_mid_old_supold_UP_gene,rep(NA,a))[1:a]
      UP[3,(a+1):(a+b)] <- c(rep_youth_supold_gene,rep(NA,a))[1:b]
      write.table(UP,paste(filea,"patten/UP/",temp[i,3],"_UP.txt",sep = ""))
      #########DOWN
      youth_mid_old_DOWN_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="DOWN")],rownames(mid_old)[which(mid_old[,"change"]=="DOWN")])
      mid_old_supold_DOWN_gene <- intersect(rownames(mid_old)[which(mid_old[,"change"]=="DOWN")],rownames(old_supold)[which(old_supold[,"change"]=="DOWN")])
      youth_mid_old_supold_DOWN_gene <- intersect(youth_mid_old_DOWN_gene,mid_old_supold_DOWN_gene)
      
      rep_youth_old_gene <- intersect(youth_mid_old_DOWN_gene,rownames(youth_old)[which(youth_old[,"change"]=="DOWN")])
      rep_mid_supold_gene <- intersect(mid_old_supold_DOWN_gene,rownames(mid_supold)[which(mid_supold[,"change"]=="DOWN")])
      rep_youth_supold_gene <- intersect(youth_mid_old_supold_DOWN_gene,rownames(youth_supold)[which(youth_supold[,"change"]=="DOWN")])
      
      a <- max(length(youth_mid_old_DOWN_gene),length(mid_old_supold_DOWN_gene),length(youth_mid_old_supold_DOWN_gene))
      b <- max(length(rep_youth_old_gene),length(rep_mid_supold_gene),length(rep_youth_supold_gene))
      
      DOWN <- as.data.frame(array(NA,dim = c(3,a+b)))
      colnames(DOWN) <- c(rep("gene",a),rep("rep_gene",b))
      rownames(DOWN) <- c("youth_mid_old_DOWN","mid_old_supold_DOWN","youth_mid_old_supold_DOWN")
      
      DOWN[1,1:a] <- c(youth_mid_old_DOWN_gene,rep(NA,a))[1:a]
      DOWN[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
      DOWN[2,1:a] <- c(mid_old_supold_DOWN_gene,rep(NA,a))[1:a]
      DOWN[2,(a+1):(a+b)] <- c(rep_mid_supold_gene,rep(NA,a))[1:b]
      DOWN[3,1:a] <- c(youth_mid_old_supold_DOWN_gene,rep(NA,a))[1:a]
      DOWN[3,(a+1):(a+b)] <- c(rep_youth_supold_gene,rep(NA,a))[1:b]
      write.table(DOWN,paste(filea,"patten/DOWN/",temp[i,3],"_DOWN.txt",sep = ""))
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/blood/analsis/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA1.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth-old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        youth_counts = youth@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(old_counts[j,]),youth_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth-old/",cluster[i],"_youth_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-supold
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_supold/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_supold/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        supold <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "supold")
        youth_counts = youth@assays$RNA@data
        supold_counts = supold@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(supold_counts[j,]),youth_counts[j,],supold_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_supold/",cluster[i],"_youth_supold.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_supold/",cluster[i],"_youth_supold.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############mid-supold
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_supold/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_supold/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        supold <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "supold")
        mid_counts = mid@assays$RNA@data
        supold_counts = supold@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(supold_counts[j,]),mid_counts[j,],supold_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_supold/",cluster[i],"_mid_supold.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_supold/",cluster[i],"_mid_supold.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############old-supold
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/old_supold/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/old_supold/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        supold <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "supold")
        old_counts = old@assays$RNA@data
        supold_counts = supold@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(old_counts[j,]),length(supold_counts[j,]),old_counts[j,],supold_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/old_supold/",cluster[i],"_old_supold.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/old_supold/",cluster[i],"_old_supold.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/blood/analsis/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA1.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
          
        }
        #############youth_old
        if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
        #############mid_supold
        if(!dir.exists(paste(filea,"result/Scenic/mid_supold/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_supold/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-supold/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-supold/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-supold/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","supold"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_supold/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_supold/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_supold/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
        #############youth_supold
        if(!dir.exists(paste(filea,"result/Scenic/youth_supold/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_supold/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-supold/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-supold/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-supold/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","supold"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_supold/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_supold/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_supold/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
        #############old_supold
        if(!dir.exists(paste(filea,"result/Scenic/old_supold/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/old_supold/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/old-supold/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/old-supold/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/old-supold/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("old","supold"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/old_supold/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/old_supold/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/old_supold/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
    }
    
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/mid_old/
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/youth_old/
        bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/youth_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/mid_supold/
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/mid_supold/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/old_supold/
        bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/old_supold/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data03/HCB/aging/blood/analsis/result/Scenic/youth_supold/
        bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/blood/analsis/result/Scenic/youth_supold/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
  }

  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/blood/analsis/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-supold
    if(!dir.exists(paste(filea,"hTFTarget/youth-supold/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-supold/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############mid-supold
    if(!dir.exists(paste(filea,"hTFTarget/mid-supold/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-supold/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############old-supold
    if(!dir.exists(paste(filea,"hTFTarget/old-supold/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/old-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/old-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/old-supold/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/blood/analsis/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############mid-supold
    if(!dir.exists(paste(filea,"TRRUST2/mid-supold/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-supold/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-supold
    if(!dir.exists(paste(filea,"TRRUST2/youth-supold/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-supold/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############old-supold
    if(!dir.exists(paste(filea,"TRRUST2/old-supold/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/old-supold/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/old-supold/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/old-supold/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/blood/analsis/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############mid_supold
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_supold/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_supold/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_supold/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_supold/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_supold/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_supold
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_supold/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_supold/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_supold/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_supold/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_supold/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############old_supold
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/old_supold/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/old_supold/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/old_supold/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/old_supold/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/old_supold/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/blood/analsis/"
    scRNA <- readRDS(paste(filea,"scRNA1.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
      ########youth-old
      {
        setwd(paste(filea,"result/DEG/youth-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########youth-mid
      {
        setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########mid-supold
      {
        setwd(paste(filea,"result/DEG/mid-supold",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
      ########youth-supold
      {
        setwd(paste(filea,"result/DEG/youth-supold",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########old-supold
      {
        setwd(paste(filea,"result/DEG/old-supold",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/blood.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/blood/analsis/"
    scRNA <- readRDS(paste(filea,"scRNA1.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/blood.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/blood/analsis/"
    
    scRNA <- readRDS(paste(fileb,"scRNA1.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/blood.csv")
    gene <- gene[,c(1,3)]
    gene[5:7,1] <- celltype[1]
    gene[10,1] <- celltype[5]
    gene[20:21,1] <- celltype[7]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data03/HCB/aging/cell_number/blood.csv")
  }
  
}




###################################################################################################视网膜retina
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    mid1 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2a.tsv")
    mid2 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2b.tsv")
    mid3 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3a.tsv")
    mid4 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3b.tsv")
    
    
    old <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r1.tsv",skip = 1)
    old <- as.data.frame(old)
    for (i in 2:length(colnames(old))) {
      colnames(old)[i] <- strsplit(x=colnames(old)[i],split='[.]')[[1]][1]
    }
    old <- rbind(old,colnames(old))
    old_temp <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r1.tsv")
    colnames(old)[1:length(colnames(old))] <- c('gene',colnames(old_temp))
    rownames(old) <- old[,1]
    
    temp1 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2a.tsv",skip = 1)
    temp1 <- as.data.frame(temp1)
    for (i in 2:length(colnames(temp1))) {
      colnames(temp1)[i] <- strsplit(x=colnames(temp1)[i],split='[.]')[[1]][1]
    }
    temp1 <- rbind(temp1,colnames(temp1))
    temp <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2a.tsv")
    colnames(temp1)[1:length(colnames(temp1))] <- c('gene',colnames(temp))
    rownames(temp1) <- temp1[,1]
    mid1 <- temp1
    
    temp1 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2b.tsv",skip = 1)
    temp1 <- as.data.frame(temp1)
    for (i in 2:length(colnames(temp1))) {
      colnames(temp1)[i] <- strsplit(x=colnames(temp1)[i],split='[.]')[[1]][1]
    }
    temp1 <- rbind(temp1,colnames(temp1))
    temp <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r2b.tsv")
    colnames(temp1)[1:length(colnames(temp1))] <- c('gene',colnames(temp))
    rownames(temp1) <- temp1[,1]
    mid2 <- temp1
    
    temp1 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3a.tsv",skip = 1)
    temp1 <- as.data.frame(temp1)
    for (i in 2:length(colnames(temp1))) {
      colnames(temp1)[i] <- strsplit(x=colnames(temp1)[i],split='[.]')[[1]][1]
    }
    temp1 <- rbind(temp1,colnames(temp1))
    temp <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3a.tsv")
    colnames(temp1)[1:length(colnames(temp1))] <- c('gene',colnames(temp))
    rownames(temp1) <- temp1[,1]
    mid3 <- temp1
    
    temp1 <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3b.tsv",skip = 1)
    temp1 <- as.data.frame(temp1)
    for (i in 2:length(colnames(temp1))) {
      colnames(temp1)[i] <- strsplit(x=colnames(temp1)[i],split='[.]')[[1]][1]
    }
    temp1 <- rbind(temp1,colnames(temp1))
    temp <- read_tsv("/data03/HCB/aging/retina/data2/ae_exp_raw_r3b.tsv")
    colnames(temp1)[1:length(colnames(temp1))] <- c('gene',colnames(temp))
    rownames(temp1) <- temp1[,1]
    mid4 <- temp1
    old <- old[,-1]
    mid1 <- mid1[,-1]
    mid2 <- mid2[,-1]
    mid3 <- mid3[,-1]
    mid4 <- mid4[,-1]
    colnames(old) <- paste(colnames(old),"_old",sep = "")
    colnames(mid1) <- paste(colnames(mid1),"_mid1",sep = "")
    colnames(mid2) <- paste(colnames(mid2),"_mid2",sep = "")
    colnames(mid3) <- paste(colnames(mid3),"_mid3",sep = "")
    colnames(mid4) <- paste(colnames(mid4),"_mid4",sep = "")
    
    experiment.data <- cbind(old,mid1)
    experiment.data <- cbind(experiment.data,mid2)
    experiment.data <- cbind(experiment.data,mid3)
    experiment.data <- cbind(experiment.data,mid4)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=5000
    maxUMI=20000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
    
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 3) %>%
      identity()
    
    #按照聚类分组展示细胞异同
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("retina1.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `19` = "Monocytes", 
                          `10` = "Mueller glia",`21` = "Mueller glia",`22` = "Mueller glia",
                          `23` = "Retinal ganglion",
                          `0` = "Rod photoreceptors",`1` = "Rod photoreceptors",`2` = "Rod photoreceptors",`3` = "Rod photoreceptors",
                          `4` = "Rod photoreceptors",`5` = "Rod photoreceptors",`6` = "Rod photoreceptors",`7` = "Rod photoreceptors",
                          `8` = "Rod photoreceptors",`12` = "Rod photoreceptors",`15` = "Rod photoreceptors",`17` = "Rod photoreceptors",
                          `16` = "Cone photoreceptors",`20` = "Cone photoreceptors",`24` = "Cone photoreceptors",
                          `28` = "Retinal astrocytes",
                          `9` = "Bipolar",`13` = "Bipolar",`18` = "Bipolar",`26` = "Bipolar",`11` = "Bipolar",
                          `14` = "Amacrine",`25` = "Amacrine",
                          `27` = "Horizontal"
    )
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else
      {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA5.rds")
    #scRNA <- readRDS("scRNA5.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    
    ##############################Cluster图
    value_temp <- c("Monocytes" = "#CC6699","Mueller glia" = "#CC33CC", "Retinal ganglion" = "#6699CC", "Rod photoreceptors" = "#FFCC00", 
                    "Cone photoreceptors" = "#33CCCC",
                    "Retinal astrocytes" = "#FF3366","Bipolar" = "#FF33FF", "Amacrine" = "#9933CC", "Horizontal" = "#663300")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
  }
  
  {
    scRNA <- readRDS("scRNA5.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/retina/result/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(Rcpp)
    library(ggpubr)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/retina/result/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA5.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4000,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/retina/result/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA5.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/retina/result/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/retina/result/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/retina/result/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
 
  }
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/retina/result/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/retina/result/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/retina/result/"
    scRNA <- readRDS(paste(filea,"scRNA5.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/retina.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/retina/result/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/retina.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/retina/result/"
    
    scRNA <- readRDS(paste(fileb,"scRNA5.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/retina.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data03/HCB/aging/cell_number/retina.csv")
  }
  
}




##################################################################################################膀胱bladder
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    mid1 <- Read10X("/data03/HCB/aging/bladder/GSM3723357/")
    mid2 <- Read10X("/data03/HCB/aging/bladder/GSM3723358/")
    mid3 <- Read10X("/data03/HCB/aging/bladder/GSM3723359/")
    
    old1 <- Read10X("/data03/HCB/aging/bladder/SRR12603780/outs/filtered_feature_bc_matrix/")
    old2 <- Read10X("/data03/HCB/aging/bladder/SRR12603781/outs/filtered_feature_bc_matrix/")
    old3 <- Read10X("/data03/HCB/aging/bladder/SRR12603788/outs/filtered_feature_bc_matrix/")
    
    colnames(mid1) <- paste(colnames(mid1),"mid1",sep = "_")
    colnames(mid2) <- paste(colnames(mid2),"mid2",sep = "_")
    colnames(mid3) <- paste(colnames(mid3),"mid3",sep = "_")
    
    colnames(old1) <- paste(colnames(old1),"old1",sep = "_")
    colnames(old2) <- paste(colnames(old2),"old2",sep = "_")
    colnames(old3) <- paste(colnames(old3),"old3",sep = "_")
    
    a <- intersect(rownames(mid1),rownames(old1))
    mid1 <- mid1[a,]
    mid2 <- mid2[a,]
    mid3 <- mid3[a,]
    old1 <- old1[a,]
    old2 <- old2[a,]
    old3 <- old3[a,]
    
    experiment.data <- cbind(mid1,mid2)
    experiment.data <- cbind(experiment.data,mid3)
    experiment.data <- cbind(experiment.data,old1)
    experiment.data <- cbind(experiment.data,old2)
    experiment.data <- cbind(experiment.data,old3)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=6000
    maxUMI=40000
    pctMT=20
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("bladder1.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `5` = "myo-CAFs",`17` = "myo-CAFs",`23` = "myo-CAFs",
                          `18` = "Myeloid",
                          `19` = "Mast",
                          `0` = "Epithelial",`2` = "Epithelial",`11` = "Epithelial",`12` = "Epithelial",`15` = "Epithelial",
                          `1` = "Fibroblast",`7` = "Fibroblast",`9` = "Fibroblast",`21` = "Fibroblast",`24` = "Fibroblast",`25` = "Fibroblast",
                          `27` = "Fibroblast",
                          `4` = "Endothelial",`8` = "Endothelial",`10` = "Endothelial",`14` = "Endothelial",
                          `13` = "Monocyte",
                          `3` = "T",`6` = "T",
                          `16` = "Basal",`20` = "Basal",`22` = "Basal",`26` = "Basal"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    
    value_temp <- c("B" = "#CC6699","Mast" = "#CC33CC", "Endothelial/Lymphatic" = "#6699CC", "Fibroblasts" = "#FFCC00", "Alveolar" = "#33CCCC",
                    "Epithelial" = "#FF3366","Myeloid" = "#FF33FF", "T" = "#9933CC")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/bladder/analysis/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(Rcpp)
    library(ggpubr)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/bladder/analysis/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/bladder/analysis/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/bladder/analysis/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/bladder/analysis/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/bladder/analysis/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/bladder/analysis/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/bladder/analysis/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/bladder/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/bladder.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/bladder/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/bladder.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/bladder/analysis/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/bladder.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data03/HCB/aging/cell_number/bladder.csv")
  }
  
}




##################################################################################################睾丸testis
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    #睾丸
    youth1 <-read.csv("/data03/HCB/aging/testis/data1/LZ011_2.csv",row.names = 1)
    youth2 <-read.csv("/data03/HCB/aging/testis/data1/LZ009_5.csv",row.names = 1)
    youth3 <-read.csv("/data03/HCB/aging/testis/data1/LZ005_8.csv",row.names = 1)
    youth4 <-read.csv("/data03/HCB/aging/testis/data1/LZ008_11.csv",row.names = 1)
    youth5 <-read.csv("/data03/HCB/aging/testis/data1/LZ016_17.csv",row.names = 1)
    
    mid1 <-read.csv("/data03/HCB/aging/testis/data1/LZ003_23.csv",row.names = 1)
    mid2 <-read.csv("/data03/HCB/aging/testis/data1/LZ013_25.csv",row.names = 1)
    mid3 <-read.csv("/data03/HCB/aging/testis/data1/LZ014_28.csv",row.names = 1)
    mid4 <-read.csv("/data03/HCB/aging/testis/data1/LZ007_28.csv",row.names = 1)
    mid5 <-read.csv("/data03/HCB/aging/testis/data1/LZ015_31.csv",row.names = 1)
    
    colnames(youth1) <- paste(gsub("[_]","-",colnames(youth1)),"_","youth1",sep = "")
    colnames(youth2) <- paste(gsub("[_]","-",colnames(youth2)),"_","youth2",sep = "")
    colnames(youth3) <- paste(gsub("[_]","-",colnames(youth3)),"_","youth3",sep = "")
    colnames(youth4) <- paste(gsub("[_]","-",colnames(youth4)),"_","youth4",sep = "")
    colnames(youth5) <- paste(gsub("[_]","-",colnames(youth5)),"_","youth5",sep = "")
    
    colnames(mid1) <- paste(gsub("[_]","-",colnames(mid1)),"_","mid1",sep = "")
    colnames(mid2) <- paste(gsub("[_]","-",colnames(mid2)),"_","mid2",sep = "")
    colnames(mid3) <- paste(gsub("[_]","-",colnames(mid3)),"_","mid3",sep = "")
    colnames(mid4) <- paste(gsub("[_]","-",colnames(mid4)),"_","mid4",sep = "")
    colnames(mid5) <- paste(gsub("[_]","-",colnames(mid5)),"_","mid5",sep = "")
    
    experiment.data <- cbind(youth1,youth2)
    experiment.data <- cbind(experiment.data,youth3)
    experiment.data <- cbind(experiment.data,youth4)
    experiment.data <- cbind(experiment.data,youth5)
    experiment.data <- cbind(experiment.data,mid1)
    experiment.data <- cbind(experiment.data,mid2)
    experiment.data <- cbind(experiment.data,mid3)
    experiment.data <- cbind(experiment.data,mid4)
    experiment.data <- cbind(experiment.data,mid5)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=10000
    maxUMI=50000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("testis1.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `3` = "Spermatogonia",`10` = "Spermatogonia",`28` = "Spermatogonia",
                          `6` = "Spermatids",`9` = "Spermatids",`12` = "Spermatids",`20` = "Spermatids",`23` = "Spermatids",`25` = "Spermatids",
                          `26` = "Spermatids",`27` = "Spermatids",`30` = "Spermatids",
                          `19` = "Endotheliocytes",
                          `13` = "PTM",`14` = "PTM",
                          `32` = "Soma precursor",
                          `1` = "Leydig",`2` = "Leydig",`21` = "Leydig",`35` = "Leydig",
                          `0` = "Sertoli",`4` = "Sertoli",`5` = "Sertoli",`34` = "Sertoli",`36` = "Sertoli",
                          `16` = "Germ",`17` = "Germ",`18` = "Germ",`22` = "Germ",
                          `24` = "Macrophage",`33` = "Macrophage",
                          `37` = "Kidney",`11` = "Kidney",`15` = "Kidney",`8` = "Kidney",`29` = "Kidney",`31` = "Kidney",`7` = "Kidney"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("Spermatogonia" = "#CC6699","Spermatids" = "#CC33CC", "Endotheliocytes" = "#6699CC", "PTM" = "#FFCC00", 
                    "Soma precursor" = "#33CCCC",
                    "Leydig" = "#FF3366","Sertoli" = "#FF33FF", "Germ" = "#9933CC","Macrophage" = "#663300", "Kidney" = "#99FF99")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }

    
  }

  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/testis/analysis/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
          
        }
      }
    }

  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/testis/analysis/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 3500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/testis/analysis/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
          
        }

    }
    
    {
      cd /data03/HCB/aging/testis/analysis/result/Scenic/youth_mid/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/testis/analysis/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/testis/analysis/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/testis/analysis/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/testis/analysis/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/testis/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########youth-mid
      {
        setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/testis.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/testis/analysis/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/testis.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/testis/analysis/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/testis.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }  
    write.csv(res,"/data03/HCB/aging/cell_number/testis.csv")
  }
  
}




#######################################################################################################皮肤skin
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    youth1 <- Read10X("/data03/HCB/aging/skin/HRR172193/")
    youth2 <- Read10X("/data03/HCB/aging/skin/HRR172194/")
    youth3 <- Read10X("/data03/HCB/aging/skin/HRR172195/")
    youth4 <- Read10X("/data03/HCB/aging/skin/HRR172196/")
    
    mid1 <- Read10X("/data03/HCB/aging/skin/HRR172197/")
    mid2 <- Read10X("/data03/HCB/aging/skin/HRR172198/")
    mid3 <- Read10X("/data03/HCB/aging/skin/HRR172199/")
    mid4 <- Read10X("/data03/HCB/aging/skin/HRR172200/")
    mid5 <- Read10X("/data03/HCB/aging/skin/HRR172201/")
    mid6 <- Read10X("/data03/HCB/aging/skin/HRR172202/")
    mid7 <- Read10X("/data03/HCB/aging/skin/HRR172203/")
    mid8 <- Read10X("/data03/HCB/aging/skin/HRR172204/")
    mid9 <- Read10X("/data03/HCB/aging/skin/HRR172205/")
    mid10 <- Read10X("/data03/HCB/aging/skin/HRR172206/")
    mid11 <- Read10X("/data03/HCB/aging/skin/HRR172207/")
    mid12 <- Read10X("/data03/HCB/aging/skin/HRR172208/")
    mid13 <- Read10X("/data03/HCB/aging/skin/HRR172209/")
    mid14 <- Read10X("/data03/HCB/aging/skin/HRR172210/")
    mid15 <- Read10X("/data03/HCB/aging/skin/HRR172211/")
    mid16 <- Read10X("/data03/HCB/aging/skin/HRR172212/")
    mid17 <- Read10X("/data03/HCB/aging/skin/HRR172213/")
    mid18 <- Read10X("/data03/HCB/aging/skin/HRR172214/")
    mid19 <- Read10X("/data03/HCB/aging/skin/HRR172215/")
    mid20 <- Read10X("/data03/HCB/aging/skin/HRR172216/")
    
    old1 <- Read10X("/data03/HCB/aging/skin/HRR172217/")
    old2 <- Read10X("/data03/HCB/aging/skin/HRR172218/")
    old3 <- Read10X("/data03/HCB/aging/skin/HRR172219/")
    old4 <- Read10X("/data03/HCB/aging/skin/HRR172220/")
    old5 <- Read10X("/data03/HCB/aging/skin/HRR172221/")
    old6 <- Read10X("/data03/HCB/aging/skin/HRR172222/")
    old7 <- Read10X("/data03/HCB/aging/skin/HRR172223/")
    old8 <- Read10X("/data03/HCB/aging/skin/HRR172224/")
    old9 <- Read10X("/data03/HCB/aging/skin/HRR172225/")
    old10 <- Read10X("/data03/HCB/aging/skin/HRR172226/")
    old11 <- Read10X("/data03/HCB/aging/skin/HRR172227/")
    old12 <- Read10X("/data03/HCB/aging/skin/HRR172228/")
    
    colnames(youth1) <- paste(colnames(youth1),"_","youth1",sep = "")
    colnames(youth2) <- paste(colnames(youth2),"_","youth2",sep = "")
    colnames(youth3) <- paste(colnames(youth3),"_","youth3",sep = "")
    colnames(youth4) <- paste(colnames(youth4),"_","youth4",sep = "")
    
    colnames(mid1) <- paste(colnames(mid1),"_","mid1",sep = "")
    colnames(mid2) <- paste(colnames(mid2),"_","mid2",sep = "")
    colnames(mid3) <- paste(colnames(mid3),"_","mid3",sep = "")
    colnames(mid4) <- paste(colnames(mid4),"_","mid4",sep = "")
    colnames(mid5) <- paste(colnames(mid5),"_","mid5",sep = "")
    colnames(mid6) <- paste(colnames(mid6),"_","mid6",sep = "")
    colnames(mid7) <- paste(colnames(mid7),"_","mid7",sep = "")
    colnames(mid8) <- paste(colnames(mid8),"_","mid8",sep = "")
    colnames(mid9) <- paste(colnames(mid9),"_","mid9",sep = "")
    colnames(mid10) <- paste(colnames(mid10),"_","mid10",sep = "")
    colnames(mid11) <- paste(colnames(mid11),"_","mid11",sep = "")
    colnames(mid12) <- paste(colnames(mid12),"_","mid12",sep = "")
    colnames(mid13) <- paste(colnames(mid13),"_","mid13",sep = "")
    colnames(mid14) <- paste(colnames(mid14),"_","mid14",sep = "")
    colnames(mid15) <- paste(colnames(mid15),"_","mid15",sep = "")
    colnames(mid16) <- paste(colnames(mid16),"_","mid16",sep = "")
    colnames(mid17) <- paste(colnames(mid17),"_","mid17",sep = "")
    colnames(mid18) <- paste(colnames(mid18),"_","mid18",sep = "")
    colnames(mid19) <- paste(colnames(mid19),"_","mid19",sep = "")
    colnames(mid20) <- paste(colnames(mid20),"_","mid20",sep = "")
    
    colnames(old1) <- paste(colnames(old1),"_","old1",sep = "")
    colnames(old2) <- paste(colnames(old2),"_","old2",sep = "")
    colnames(old3) <- paste(colnames(old3),"_","old3",sep = "")
    colnames(old4) <- paste(colnames(old4),"_","old4",sep = "")
    colnames(old5) <- paste(colnames(old5),"_","old5",sep = "")
    colnames(old6) <- paste(colnames(old6),"_","old6",sep = "")
    colnames(old7) <- paste(colnames(old7),"_","old7",sep = "")
    colnames(old8) <- paste(colnames(old8),"_","old8",sep = "")
    colnames(old9) <- paste(colnames(old9),"_","old9",sep = "")
    colnames(old10) <- paste(colnames(old10),"_","old10",sep = "")
    colnames(old11) <- paste(colnames(old11),"_","old11",sep = "")
    colnames(old12) <- paste(colnames(old12),"_","old12",sep = "")
    
    experiment.data <- cbind(youth1,youth2)
    experiment.data <- cbind(experiment.data,youth3)
    experiment.data <- cbind(experiment.data,youth4)
    experiment.data <- cbind(experiment.data,mid1)
    experiment.data <- cbind(experiment.data,mid2)
    experiment.data <- cbind(experiment.data,mid3)
    experiment.data <- cbind(experiment.data,mid4)
    experiment.data <- cbind(experiment.data,mid5)
    experiment.data <- cbind(experiment.data,mid6)
    experiment.data <- cbind(experiment.data,mid7)
    experiment.data <- cbind(experiment.data,mid8)
    experiment.data <- cbind(experiment.data,mid9)
    experiment.data <- cbind(experiment.data,mid10)
    experiment.data <- cbind(experiment.data,mid11)
    experiment.data <- cbind(experiment.data,mid12)
    experiment.data <- cbind(experiment.data,mid13)
    experiment.data <- cbind(experiment.data,mid14)
    experiment.data <- cbind(experiment.data,mid15)
    experiment.data <- cbind(experiment.data,mid16)
    experiment.data <- cbind(experiment.data,mid17)
    experiment.data <- cbind(experiment.data,mid18)
    experiment.data <- cbind(experiment.data,mid19)
    experiment.data <- cbind(experiment.data,mid20)
    experiment.data <- cbind(experiment.data,old1)
    experiment.data <- cbind(experiment.data,old2)
    experiment.data <- cbind(experiment.data,old3)
    experiment.data <- cbind(experiment.data,old4)
    experiment.data <- cbind(experiment.data,old5)
    experiment.data <- cbind(experiment.data,old6)
    experiment.data <- cbind(experiment.data,old7)
    experiment.data <- cbind(experiment.data,old8)
    experiment.data <- cbind(experiment.data,old9)
    experiment.data <- cbind(experiment.data,old10)
    experiment.data <- cbind(experiment.data,old11)
    experiment.data <- cbind(experiment.data,old12)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=4000
    maxUMI=30000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("skin.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `0` = "Basal",`2` = "Basal",`7` = "Basal",`13` = "Basal",`17` = "Basal",`23` = "Basal",`31` = "Basal",`32` = "Basal",
                          `8` = "Mitotic",`10` = "Mitotic",`15` = "Mitotic",
                          `21` = "Vellus hair follicle",`25` = "Vellus hair follicle",
                          `14` = "Melanocyte",`26` = "Melanocyte",
                          `1` = "Spinous",`3` = "Spinous",`4` = "Spinous",`5` = "Spinous",`6` = "Spinous",`11` = "Spinous",`27` = "Spinous",
                          `12` = "Granular",
                          `19` = "Endothelial",`22` = "Endothelial",
                          `16` = "Immune",`20` = "Immune",`29` = "Immune",`30` = "Immune",
                          `9` = "Fibroblast",`24` = "Fibroblast",`28` = "Fibroblast",
                          `18` = "Pericyte",
                          `33` = "Orbicularis oculi muscle"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,6]))
    ##############################Cluster图
    
    value_temp <- c("Basal" = "#CC6699","Mitotic" = "#CC33CC", "Vellus hair follicle" = "#6699CC", "Melanocyte" = "#FFCC00", "Spinous" = "#33CCCC",
                    "Granular" = "#FF3366","Endothelial" = "#FF33FF", "Immune" = "#9933CC", "Fibroblast" = "#663300","Pericyte" = "#99FF99",
                    "Orbicularis oculi muscle" = "#993366")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("/data03/HCB/aging/skin/scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-old
    if(!dir.exists(paste("./result/DEG/youth-old/"))){
      dir.create(paste("./result/DEG/youth-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0,min.cells.group = 1)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }

  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/skin/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
          
        }
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }  

  ###表达模式
  {
    filea <- "/data03/HCB/aging/skin/result/DEG/"
    setwd(paste(filea,"mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    
    if(!dir.exists(paste(filea,"patten/",sep = ""))){
      dir.create(paste(filea,"patten/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/UP/",sep = ""))){
      dir.create(paste(filea,"patten/UP/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/DOWN/",sep = ""))){
      dir.create(paste(filea,"patten/DOWN/",sep = ""))
    }
    
    for (i in 9:dim(temp)[1]) {
      youth_mid <- read.table(paste(filea,"youth-mid/",temp[i,3],"_DEG_youth_mid.txt",sep = ""))
      mid_old <- read.table(paste(filea,"mid-old/",temp[i,3],"_DEG_mid_old.txt",sep = ""))
      youth_old <- read.table(paste(filea,"youth-old/",temp[i,3],"_DEG_youth_old.txt",sep = ""))
      #########UP
      youth_mid_old_UP_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="UP")],rownames(mid_old)[which(mid_old[,"change"]=="UP")])
      rep_youth_old_gene <- intersect(youth_mid_old_UP_gene,rownames(youth_old)[which(youth_old[,"change"]=="UP")])
      a <- length(youth_mid_old_UP_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        UP <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(UP) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(UP) <- c("youth_mid_old_UP")
        UP[1,1:a] <- c(youth_mid_old_UP_gene,rep(NA,a))[1:a]
        UP[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(UP,paste(filea,"patten/UP/",temp[i,3],"_UP.txt",sep = ""))
      }
      #########DOWN
      youth_mid_old_DOWN_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="DOWN")],rownames(mid_old)[which(mid_old[,"change"]=="DOWN")])
      rep_youth_old_gene <- intersect(youth_mid_old_DOWN_gene,rownames(youth_old)[which(youth_old[,"change"]=="DOWN")])
      a <- length(youth_mid_old_DOWN_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        DOWN <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(DOWN) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(DOWN) <- "youth_mid_old_DOWN"
        DOWN[1,1:a] <- c(youth_mid_old_DOWN_gene,rep(NA,a))[1:a]
        DOWN[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(DOWN,paste(filea,"patten/DOWN/",temp[i,3],"_DOWN.txt",sep = ""))
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/skin/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        youth_counts = youth@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(old_counts[j,]),youth_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/skin/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
          
        }
        #############youth_old
        if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/skin/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/skin/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
    {
      cd /data03/HCB/aging/skin/result/Scenic/youth_mid/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/skin/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data03/HCB/aging/skin/result/Scenic/youth_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/skin/result/Scenic/youth_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/skin/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/skin/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/skin/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/skin/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
      ########youth-old
      {
        setwd(paste(filea,"result/DEG/youth-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########youth-mid
      {
        setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/skin.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    filea <- "/data03/HCB/aging/skin/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/skin.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.3,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/skin/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/skin.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }    
    write.csv(res,"/data03/HCB/aging/cell_number/skin.csv")
  }
  
}





#######################################################################################################肺lung
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    cp /data03/ZLX/lung1_GSE122960/raw_matrix/* /data03/HCB/aging/lung/
      cp /data03/ZLX/lung2/* /data03/HCB/aging/lung/lung2/
      
      cp /data03/ZLX/lung2/1247/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1247/
      cd /data03/HCB/aging/lung/1247/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/BT1293/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1293/
      cd /data03/HCB/aging/lung/1293/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/BT1294/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1294/
      cd /data03/HCB/aging/lung/1294/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/BT1301/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1301/
      cd /data03/HCB/aging/lung/1301/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/BT1378/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1378/
      cd /data03/HCB/aging/lung/1378/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/scrBT1428/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1428/
      cd /data03/HCB/aging/lung/1428/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp /data03/ZLX/lung2/scrBT1429m/outs/filtered_feature_bc_matrix/* /data03/HCB/aging/lung/1429/
      cd /data03/HCB/aging/lung/1429/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    hd5 <- h5read('GSM3489185_Donor_02_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid1",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- scRNA_temp
    
    hd5 <- h5read('GSM3489187_Donor_03_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid2",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    hd5 <- h5read('GSM3489189_Donor_04_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid3",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    hd5 <- h5read('GSM3489191_Donor_05_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid4",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    hd5 <- h5read('GSM3489195_Donor_07_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid5",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    hd5 <- h5read('GSM3489197_Donor_08_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","mid6",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    hd5 <- h5read('GSM3489182_Donor_01_raw_gene_bc_matrices_h5.h5','/')
    barcodes <- hd5$GRCh38$barcodes
    barcodes <- paste(barcodes,"_","old1",sep = "")
    counts <- hd5$GRCh38$data
    gene_id <- hd5$GRCh38$gene_names
    indices <- hd5$GRCh38$indices
    indptr <- hd5$GRCh38$indptr
    shape <- hd5$GRCh38$shape
    hd5 <- sparseMatrix(i = indices[], p = indptr[],x = as.numeric(x = counts[]), dims =shape[],dimnames=list(gene_id,barcodes), repr = "C")
    scRNA_temp <- CreateSeuratObject(hd5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    old2 <- Read10X("/data03/HCB/aging/lung/1247/")
    colnames(old2) <- paste(colnames(old2),"_","old2",sep = "")
    old3 <- Read10X("/data03/HCB/aging/lung/1293/")
    colnames(old3) <- paste(colnames(old3),"_","old3",sep = "")
    old4 <- Read10X("/data03/HCB/aging/lung/1294/")
    colnames(old4) <- paste(colnames(old4),"_","old4",sep = "")
    old5 <- Read10X("/data03/HCB/aging/lung/1301/")
    colnames(old5) <- paste(colnames(old5),"_","old5",sep = "")
    old6 <- Read10X("/data03/HCB/aging/lung/1378/")
    colnames(old6) <- paste(colnames(old6),"_","old6",sep = "")
    old7 <- Read10X("/data03/HCB/aging/lung/1429/")
    colnames(old7) <- paste(colnames(old7),"_","old7",sep = "")
    mid7 <- Read10X("/data03/HCB/aging/lung/1428/")
    colnames(mid7) <- paste(colnames(mid7),"_","mid7",sep = "")
    
    experiment.data <- cbind(old2,old3)
    experiment.data <- cbind(experiment.data,old4)
    experiment.data <- cbind(experiment.data,old5)
    experiment.data <- cbind(experiment.data,old6)
    experiment.data <- cbind(experiment.data,old7)
    experiment.data <- cbind(experiment.data,mid7)
    scRNA_temp <- CreateSeuratObject(experiment.data,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA_temp)
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=6000
    maxUMI=30000
    pctMT=20
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("lung1.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `29` = "B",
                          `21` = "Mast",`32` = "Mast",`33` = "Mast",
                          `0` = "Endothelial/Lymphatic",`18` = "Endothelial/Lymphatic",`28` = "Endothelial/Lymphatic",
                          `1` = "Endothelial/Lymphatic",`8` = "Endothelial/Lymphatic",`19` = "Endothelial/Lymphatic",`31` = "Endothelial/Lymphatic",
                          `3` = "Endothelial/Lymphatic",`9` = "Endothelial/Lymphatic",`22` = "Endothelial/Lymphatic",`34` = "Endothelial/Lymphatic",
                          `5` = "Endothelial/Lymphatic",`11` = "Endothelial/Lymphatic",`23` = "Endothelial/Lymphatic",`35` = "Endothelial/Lymphatic",
                          `6` = "Endothelial/Lymphatic",`12` = "Endothelial/Lymphatic",`26` = "Endothelial/Lymphatic",
                          `7` = "Endothelial/Lymphatic",`14` = "Endothelial/Lymphatic",`27` = "Endothelial/Lymphatic",
                          `24` = "Fibroblasts",
                          `16` = "Alveolar",`20` = "Alveolar",
                          `30` = "Epithelial",
                          `2` = "Myeloid",`10` = "Myeloid",`17` = "Myeloid",`25` = "Myeloid",
                          `4` = "T",`13` = "T",`15` = "T"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("B" = "#CC6699","Mast" = "#CC33CC", "Endothelial/Lymphatic" = "#6699CC", "Fibroblasts" = "#FFCC00", "Alveolar" = "#33CCCC",
                    "Epithelial" = "#FF3366","Myeloid" = "#FF33FF", "T" = "#9933CC")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }

  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      
      
      if(i ==1){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i ==1 ){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/lung/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
  
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/lung/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/lung/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
        cd /data03/HCB/aging/lung/result/Scenic/mid_old/
          mkdir output
        bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
        cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/lung/result/Scenic/mid_old/
          bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
        
        R
        {
          options(stringsAsFactors = FALSE)
          library(data.table)
          library(pbapply)
          library(philentropy)
          library(ggrepel)
          library(latex2exp)
          library(ggplot2)
          library(plyr)
          library(ggsci)
          cell.info <- readRDS("Cell_info.rds")
          rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
          rownames(rasMat) <- rasMat$V1
          colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
          rasMat <- rasMat[, -1]
          saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
          cell.types <- names(table(cell.info$Cell_Type))
          ctMat <- lapply(cell.types, function(i) {
            as.numeric(cell.info$Cell_Type == i)
          })
          ctMat <- do.call(cbind, ctMat)
          colnames(ctMat) <- cell.types
          rownames(ctMat) <- rownames(cell.info)
          rssMat <- pblapply(colnames(rasMat), function(i) {
            sapply(colnames(ctMat), function(j) {
              1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
            })
          })
          rssMat <- do.call(rbind, rssMat)
          rownames(rssMat) <- colnames(rasMat)
          colnames(rssMat) <- colnames(ctMat)
          write.table(rssMat,"./output/rssMat.txt")
          q()
        }
        
      }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/lung/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
 
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/lung/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/lung/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/lung/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/lung.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/lung/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/lung.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/lung/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/lung.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/lung.csv")
  }
  
}





#######################################################################################################骨骼肌skeletal-muscle
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    scRNA <-read.table("/data03/HCB/aging/skeletal-muscle/GSE143704_DeMicheli_HumanMuscleAtlas_rawdata.txt")
    scRNA1<- scRNA
    ID1<- c('092618','101018','062419')
    ID2<- c('B','061419','062719','080619','092712','111418','120518')
    for (i in 1:length(colnames(scRNA))) {
      a <- strsplit(x=(colnames(scRNA)[i]),split='_')[[1]][2]
      for (j in 1:3) {
        if(a==ID1[j]){
          colnames(scRNA)[i] <- paste(strsplit(x=colnames(scRNA)[i],split='_')[[1]][3],"_mid",j,sep = "")   
          break
        }
      }
      for (j in 1:7) {
        if(a==ID2[j]){
          if(j==1){
            colnames(scRNA)[i] <- paste(strsplit(x=colnames(scRNA)[i],split='_')[[1]][4],"_old",j,sep = "")
            break
          }else{
            colnames(scRNA)[i] <- paste(strsplit(x=colnames(scRNA)[i],split='_')[[1]][3],"_old",j,sep = "")
            break
          }
        }
      }
    }
    
    scRNA <- CreateSeuratObject(
      scRNA,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=4000
    maxUMI=5000
    pctMT=20
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("skeletal-muscle.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `1` = "Adipocytes",`3` = "Adipocytes",`17` = "Adipocytes",
                          `7` = "Fibroblast 1",
                          `2` = "Fibroblast 2",`13` = "Fibroblast 2",
                          `6` = "Pericytes and Smooth muscle",`12` = "Pericytes and Smooth muscle",
                          `4` = "Endothelial 2",`8` = "Endothelial 2",`11` = "Endothelial 2",`15` = "Endothelial 2",`16` = "Endothelial 2",
                          `10` = "Tissue-resident macrophages",`19` = "Tissue-resident macrophages",
                          `9` = "Inflammatory macrophages and monocytes",
                          `0` = "MuSC1 and progenitors 1",`18` = "MuSC1 and progenitors 1",`20` = "MuSC1 and progenitors 1",
                          `5` = "B/T/NK",
                          `14` = "Myonuclei"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图

    value_temp <- c("Adipocytes" = "#CC6699","Fibroblast 1" = "#CC33CC", "Fibroblast 2" = "#6699CC", "Pericytes and Smooth muscle" = "#FFCC00",
                    "Endothelial 2" = "#33CCCC",
                    "Tissue-resident macrophages" = "#FF3366","Inflammatory macrophages and monocytes" = "#FF33FF",
                    "MuSC1 and progenitors 1" = "#9933CC", "B/T/NK" = "#663300","Pericyte" = "#99FF99",
                    "Myonuclei" = "#993366")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }

    for (i in 6:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      
      
      if(i %in% c(6)){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i %in% c(6)){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
    
  }

  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/skeletal-muscle/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/skeletal-muscle/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 7000,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/skeletal-muscle/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/skeletal-muscle/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/skeletal-muscle/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/skeletal-muscle/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/skeletal-muscle/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/skeletal-muscle/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/skeletal-muscle/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/skeletal-muscle.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/skeletal-muscle/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/skeletal-muscle.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/skeletal-muscle/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/skeletal-muscle.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/skeletal-muscle.csv")
  }
  
}





#######################################################################################################胃stomach
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    cp -r /data03/ZLX/stomach1/* /data03/HCB/aging/stomach/
      cp -r /data03/ZLX/stomach4/* /data03/HCB/aging/stomach/
      
      cd /data03/HCB/aging/stomach/5846_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/5866_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/5931_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/6207_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/6342_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/6592_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/6709_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/stomach/6649_n1/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz 
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    mid1 <-read.table("GSM4008651_Adult-Stomach1_dge.txt",row.names = 1,header = T)
    mid2 <-read.table("GSM4008652_Adult-Stomach2_dge.txt",row.names = 1,header = T)
    
    old1 <-read.table("GSM4008653_Adult-Stomach3-1_dge.txt",row.names = 1,header = T)
    old2 <-read.table("GSM4008654_Adult-Stomach3-2_dge.txt",row.names = 1,header = T)
    old3 <-read.table("GSM4008655_Adult-Stomach3-3_dge.txt",row.names = 1,header = T)
    
    colnames(mid1) <- paste(colnames(mid1),"_mid1",sep = "")
    colnames(mid2) <- paste(colnames(mid2),"_mid2",sep = "")
    colnames(old1) <- paste(colnames(old1),"_old1",sep = "")
    colnames(old2) <- paste(colnames(old2),"_old2",sep = "")
    colnames(old3) <- paste(colnames(old3),"_old3",sep = "")
    
    mid3 <- Read10X("/data03/HCB/aging/stomach/6592_n1/")
    colnames(mid3) <- paste(colnames(mid3),"_mid3",sep = "")
    mid4 <- Read10X("/data03/HCB/aging/stomach/6709_n1/")
    colnames(mid4) <- paste(colnames(mid4),"_mid4",sep = "")
    
    old4 <- Read10X("/data03/HCB/aging/stomach/5846_n1/")
    colnames(old4) <- paste(colnames(old4),"_old4",sep = "")
    old5 <- Read10X("/data03/HCB/aging/stomach/5866_n1/")
    colnames(old5) <- paste(colnames(old5),"_old5",sep = "")
    old6 <- Read10X("/data03/HCB/aging/stomach/5931_n1/")
    colnames(old6) <- paste(colnames(old6),"_old6",sep = "")
    old7 <- Read10X("/data03/HCB/aging/stomach/6207_n1/")
    colnames(old7) <- paste(colnames(old7),"_old7",sep = "")
    old8 <- Read10X("/data03/HCB/aging/stomach/6342_n1/")
    colnames(old8) <- paste(colnames(old8),"_old8",sep = "")
    old9 <- Read10X("/data03/HCB/aging/stomach/6649_n1/")
    colnames(old9) <- paste(colnames(old9),"_old9",sep = "")
    
    a <- intersect(rownames(mid1),rownames(old4))
    a <- intersect(a,rownames(old1))
    a <- intersect(a,rownames(mid3))
    a <- intersect(a,rownames(mid2))
    a <- intersect(a,rownames(old2))
    a <- intersect(a,rownames(old3))
    mid1 <- mid1[a,]
    mid2 <- mid2[a,]
    mid3 <- mid3[a,]
    mid4 <- mid4[a,]
    old1 <- old1[a,]
    old2 <- old2[a,]
    old3 <- old3[a,]
    old4 <- old4[a,]
    old5 <- old5[a,]
    old6 <- old6[a,]
    old7 <- old7[a,]
    old8 <- old8[a,]
    old9 <- old9[a,]
    
    scRNA <- CreateSeuratObject(mid1,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA1 <- CreateSeuratObject(mid2,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(mid3,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(mid4,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old1,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old2,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old3,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old4,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old6,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old7,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old8,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    scRNA1 <- CreateSeuratObject(old9,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA <- merge(scRNA,scRNA1)
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=2000
    maxUMI=7000
    pctMT=50
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1.5) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("stomach.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `0` = "Gastric epithelium",`2` = "Gastric epithelium",`5` = "Gastric epithelium",`6` = "Gastric epithelium",
                          `8` = "Gastric epithelium",`12` = "Gastric epithelium",`14` = "Gastric epithelium",`16` = "Gastric epithelium",
                          `3` = "Fibroblasts/myofibroblasts",`11` = "Fibroblasts/myofibroblasts",`10` = "Fibroblasts/myofibroblasts",
                          `18` = "Smooth muscle/myofibroblasts",
                          `7` = "B",
                          `13` = "plasma",`15` = "plasma",
                          `17` = "Monocytes",
                          `1` = "T",`4` = "T",`9` = "T",
                          `19` = "Dendritic"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("Gastric epithelium" = "#CC6699","Fibroblasts/myofibroblasts" = "#CC33CC", "Smooth muscle/myofibroblasts" = "#6699CC",
                    "B" = "#33CCCC","plasma" = "#FF3366","Monocytes" = "#FF33FF", "T" = "#9933CC", "Dendritic" = "#663300")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      

      if(i %in% c(2,4)){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i %in% c(2,4)){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/stomach/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/stomach/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4000,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/stomach/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/stomach/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/stomach/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/stomach/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/stomach/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/stomach/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/stomach/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/stomach.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/stomach/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/stomach.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/stomach/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/stomach.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }     
    write.csv(res,"/data03/HCB/aging/cell_number/stomach.csv")
  }
  
}






#######################################################################################################肝脏liver
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    ID <- read.csv("E:/衰老/肝脏/ID.csv",row.names=1)
    ID <- cbind(ID,array(NA,dim = c(length(rownames(ID)),4)))
    colnames(ID) <- c("barcodes","part_barcodes","belong_ID","ID","group")
    ID1 <- read.csv("E:/衰老/肝脏/ID1.csv")
    ID2 <- list.files("E:/衰老/肝脏/GSE124395_RAW")
    ID_matrix <- as.data.frame(array(NA,dim = c(length(ID2),10)))
    colnames(ID_matrix)[c(1,2,9,10)] <- c("ID2","part_barcodes","belong_ID","group")
    ID_matrix[,1] <- ID2
    for (i in 1:length(ID2)) {
      temp <- unlist(strsplit(x=strsplit(x=ID_matrix[i,1],split='[.]')[[1]][1],split='[_]'))
      ID_matrix[i,2] <- length(temp)
      ID_matrix[i,9] <- temp[1]
      for (j in 3:(ID_matrix[i,2])) {
        temp1 <- paste(temp[2],temp[3],sep = "_")
        if(j>3){
          for (k in 4:j) {
            temp1 <- paste(temp1,temp[k],sep = "_")
          }
        }
        ID_matrix[i,j] <- temp1
      }
    }
    for (i in 1:length(rownames(ID_matrix))) {
      if(ID_matrix[i,9]%in%ID1[,1]){
        ID_matrix[i,10] <- ID1[which(ID1[,1]==ID_matrix[i,9]),4]
      }
    }
    ID_matrix <- ID_matrix[which(is.na(ID_matrix[,10])==F),]
    for (i in 1:length(rownames(ID))) {
      for (j in 1:258) {
        temp = unlist(strsplit(x=ID[i,1],split='[_]'))
        temp1 <- paste(temp[1],temp[2],sep = "_")
        if(length(temp)>3){
          for (k in 3:(length(temp)-1)) {
            temp1 <- paste(temp1,temp[k],sep = "_")
          }
        }
        if(temp1%in%ID_matrix[j,3:ID_matrix[j,2]]){
          ID[i,5]=ID_matrix[j,10]
          break
        }
      }
    }
    ID <- ID[which(is.na(ID[,5])==F),]
    ID <- ID[,c(1,5)]
    write.csv(ID,"E:/衰老/肝脏/ID_result.csv")

    scRNA <- readRDS("/data03/HCB/aging/liver/GSE124395_Normalhumanliverdata.RData")
    
    ID_result <- read.csv("ID_result.csv",header = T,row.names = 1)
    a <- colnames(scRNA)
    for (i in 1:length(a)) {
      temp <- ID_result[which(ID_result[,1]==a[i]),2]
      a[i] <- paste(gsub("[_]","-",a[i]),temp,sep = "_")
    }
    colnames(scRNA) <- a
    
    scRNA <- CreateSeuratObject(scRNA,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=5000
    maxUMI=25000
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
 
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("liver.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `16` = "B",
                          `3` = "Kupffer",`13` = "Kupffer",
                          `2` = "NK,NKT,T",`5` = "NK,NKT,T",`6` = "NK,NKT,T",`9` = "NK,NKT,T",`12` = "NK,NKT,T",`15` = "NK,NKT,T",`17` = "NK,NKT,T",
                          `0` = "Liver sinusoidal endothelial",`10` = "Liver sinusoidal endothelial",`19` = "Liver sinusoidal endothelial",
                          `1` = "Hepatocytes",`7` = "Hepatocytes",`8` = "Hepatocytes",`11` = "Hepatocytes",`20` = "Hepatocytes",`21` = "Hepatocytes",
                          `22` = "Hepatocytes",`24` = "Hepatocytes",
                          `4` = "EPCAM+ and Cholangiocytes",`14` = "EPCAM+ and Cholangiocytes",`18` = "EPCAM+ and Cholangiocytes",
                          `23` = "Stellate and Myofibroblasts"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("B" = "#CC6699","Kupffer" = "#CC33CC", "NK,NKT,T" = "#6699CC", "Liver sinusoidal endothelial" = "#FFCC00",
                    "Hepatocytes" = "#33CCCC",
                    "EPCAM+ and Cholangiocytes" = "#FF3366","Stellate and Myofibroblasts" = "#FF33FF")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
 
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/liver/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    
  }
  
  {
      library(ggplot2)
      library(cowplot)
      library(Matrix)
      library(dplyr)
      library(readr)
      library(Seurat)
      library(harmony)
      library(tidyverse)
      library(patchwork)
      library(patchwork)
      library(lemon)
      library(MAST)
      ulimit::memory_limit(100000)
      library(ggpubr)
      library(Rcpp)
      sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
      
      filea <- "/data03/HCB/aging/liver/"
      
      if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
        dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
      }
      scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
      cluster <- unique(scRNA$ident)
      #############mid-old
      if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
        dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
      }
      {
        rowleng <- 2000
        gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
        rownames(gene_CV) <- VariableFeatures(scRNA)
        colnames(gene_CV) <- cluster
        for (i in 1:length(cluster)) {
          mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
          old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
          mid_counts = mid@assays$RNA@data
          old_counts = old@assays$RNA@data
          cat(cluster[i],": Start!","\n")
          for (j in 1:rowleng) {
            if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
            if((j %% 200) == 1){cat((j-1)/200+1)}
            if((j %% 40) == 0 & j<=1960){cat("-")}
            if(j == 2000){cat("|","\n")}
            gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
          }
        }
        write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
      }
      {
        fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
        colnames(fig) <- c("exp","cluster")
        for (i in 1:length(cluster)) {
          fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
          fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
        }
        fig <- na.omit(fig)
        png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4000,height = 1500)
        p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                    add.params = list(fill="white",size=0.5))+
          theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
          theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
                axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
        print(p)
        dev.off()
      }
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/liver/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/liver/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/liver/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/liver/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/liver/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/liver/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/liver/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/liver.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/liver/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/liver.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/liver/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/liver.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }  
    
    write.csv(res,"/data03/HCB/aging/cell_number/liver.csv")
  }
  
}





#######################################################################################################前列腺prostate
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    mid <- read.table("/data03/HCB/aging/prostate/GSM4008646_Adult-Prostate1_dge.txt",row.names = 1,header = T)
    colnames(mid) <- paste(colnames(mid),"_mid",sep = "")
    
    old1 <-read.table("/data03/HCB/aging/prostate/8646/GSM4556600_MF002_human_cleanraw_counts_matrix.txt",header = T,sep = "\t")
    old2 <-read.table("/data03/HCB/aging/prostate/8646/GSM4556601_MM033_human_clean_raw_counts_matrix.txt",header = T,sep = "\t")
    old3 <-read.table("/data03/HCB/aging/prostate/8646/GSM4556602_MM037_clean_raw_counts_matrix.txt",header = T,sep = "\t")
    old1 <- distinct(old1,X,.keep_all = T)
    rownames(old1) <- old1[,1]
    old1 <- old1[,-1]
    
    old2 <- distinct(old2,X,.keep_all = T)
    rownames(old2) <- old2[,1]
    old2 <- old2[,-1]
    old3 <- distinct(old3,X,.keep_all = T)
    rownames(old3) <- old3[,1]
    old3 <- old3[,-1]
    
    colnames(old1) <- paste(colnames(old1),"_old1",sep = "")
    colnames(old2) <- paste(colnames(old2),"_old2",sep = "")
    colnames(old3) <- paste(colnames(old3),"_old3",sep = "")
    
    mid <- na.omit(mid)
    old1 <- na.omit(old1)
    old2 <- na.omit(old2)
    old3 <- na.omit(old3)
    a <- intersect(rownames(mid),rownames(old1))
    a <- intersect(a,rownames(old2))
    a <- intersect(a,rownames(old3))
    mid <- mid[a,]
    old1 <- old1[a,]
    old2 <- old2[a,]
    old3 <- old3[a,]
    
    scRNA <- cbind(mid,old1)
    scRNA <- cbind(scRNA,old2)
    scRNA <- cbind(scRNA,old3)
    scRNA <- CreateSeuratObject(scRNA,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=6000
    maxUMI=20000
    pctMT=20
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("prostate.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `0` = "Lum Acinar",`1` = "Lum Acinar",`5` = "Lum Acinar",`8` = "Lum Acinar",`12` = "Lum Acinar",`14` = "Lum Acinar",
                          `15` = "Lum Acinar",
                          `9` = "Lum Ductal",
                          `13` = "PrU-like",
                          `2` = "Basal",`3` = "Basal",`6` = "Basal",
                          `7` = "Macrophages",`10` = "Macrophages",
                          `4` = "T",
                          `11` = "Other cells",`16` = "Other cells"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("Lum Acinar" = "#CC6699","Lum Ductal" = "#CC33CC", "PrU-like" = "#6699CC", "Basal" = "#FFCC00",
                    "Macrophages" = "#33CCCC","T" = "#FF3366","Other cells" = "#FF33FF")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.5, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.5, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.5, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    ########cluster[,7]只存在old中
    for (i in 5:6) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0,min.cells.group=1)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      
      
      if(i %in% c(10)){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i %in% c(10)){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/prostate/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }

  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/prostate/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,6)))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster[1:6]
      for (i in 1:6) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*6,2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:6) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/prostate/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/prostate/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/prostate/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/prostate/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/prostate/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/prostate/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/prostate/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/prostate.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/prostate/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/prostate.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/prostate/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/prostate.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/prostate.csv")
  }
  
}





#######################################################################################################骨髓 bone marrow
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    mid1 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/161/")
    colnames(mid1) <- paste(colnames(mid1),"_mid1",sep = "")
    mid2 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/162/")
    colnames(mid2) <- paste(colnames(mid2),"_mid2",sep = "")
    mid3 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/164/")
    colnames(mid3) <- paste(colnames(mid3),"_mid3",sep = "")
    mid4 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/166/")
    colnames(mid4) <- paste(colnames(mid4),"_mid4",sep = "")
    mid5 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/167/")
    colnames(mid5) <- paste(colnames(mid5),"_mid5",sep = "")
    mid6 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/168/")
    colnames(mid6) <- paste(colnames(mid6),"_mid6",sep = "")
    mid7 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/169/")
    colnames(mid7) <- paste(colnames(mid7),"_mid7",sep = "")
    mid8 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/170/")
    colnames(mid8) <- paste(colnames(mid8),"_mid8",sep = "")
    mid9 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/172/")
    colnames(mid9) <- paste(colnames(mid9),"_mid9",sep = "")
    mid10 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/175/")
    colnames(mid10) <- paste(colnames(mid10),"_mid10",sep = "")
    mid11 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/176/")
    colnames(mid11) <- paste(colnames(mid11),"_mid11",sep = "")
    mid12 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/178/")
    colnames(mid12) <- paste(colnames(mid12),"_mid12",sep = "")
    mid13 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/179/")
    colnames(mid13) <- paste(colnames(mid13),"_mid13",sep = "")
    mid14 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/180/")
    colnames(mid14) <- paste(colnames(mid14),"_mid14",sep = "")
    mid15 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/181/")
    colnames(mid15) <- paste(colnames(mid15),"_mid15",sep = "")
    mid16 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/182/")
    colnames(mid16) <- paste(colnames(mid16),"_mid16",sep = "")
    mid17 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/183/")
    colnames(mid17) <- paste(colnames(mid17),"_mid17",sep = "")
    mid18 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/184/")
    colnames(mid18) <- paste(colnames(mid18),"_mid18",sep = "")
    mid19 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/185/")
    colnames(mid19) <- paste(colnames(mid19),"_mid19",sep = "")
    
    
    old1 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/163/")
    colnames(old1) <- paste(colnames(old1),"_old1",sep = "")
    old2 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/165/")
    colnames(old2) <- paste(colnames(old2),"_old2",sep = "")
    old3 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/171/")
    colnames(old3) <- paste(colnames(old3),"_old3",sep = "")
    old4 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/173/")
    colnames(old4) <- paste(colnames(old4),"_old4",sep = "")
    old5 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/174/")
    colnames(old5) <- paste(colnames(old5),"_old5",sep = "")
    old6 <- Read10X("/data03/HCB/aging/bone-marrow/GSE120221_RAW/177/")
    colnames(old6) <- paste(colnames(old6),"_old6",sep = "")
    
    scRNA <- cbind(mid1,mid2)
    scRNA <- cbind(scRNA,mid3)
    scRNA <- cbind(scRNA,mid4)
    scRNA <- cbind(scRNA,mid5)
    scRNA <- cbind(scRNA,mid6)
    scRNA <- cbind(scRNA,mid7)
    scRNA <- cbind(scRNA,mid8)
    scRNA <- cbind(scRNA,mid9)
    scRNA <- cbind(scRNA,mid10)
    scRNA <- cbind(scRNA,mid11)
    scRNA <- cbind(scRNA,mid12)
    scRNA <- cbind(scRNA,mid13)
    scRNA <- cbind(scRNA,mid14)
    scRNA <- cbind(scRNA,mid15)
    scRNA <- cbind(scRNA,mid16)
    scRNA <- cbind(scRNA,mid17)
    scRNA <- cbind(scRNA,mid18)
    scRNA <- cbind(scRNA,mid19)
    
    scRNA <- cbind(scRNA,old1)
    scRNA <- cbind(scRNA,old2)
    scRNA <- cbind(scRNA,old3)
    scRNA <- cbind(scRNA,old4)
    scRNA <- cbind(scRNA,old5)
    scRNA <- cbind(scRNA,old6)
    
    scRNA <- CreateSeuratObject(scRNA,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=3000
    maxUMI=25000
    pctMT=8
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }

  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("bone-marrow.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 40,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `0` = "CD4+ naive T",`1` = "CD4+ naive T",
                          `3` = "CD14+ monocytes",`10` = "CD14+ monocytes",
                          `5` = "CD20+ B",`7` = "CD20+ B",
                          `2` = "NK",`4` = "NK",`6` = "NK",`11` = "NK",`13` = "NK",`15` = "NK",`18` = "NK",
                          `8` = "CD16+ monocytes",
                          `19` = "Dendritic",
                          `9` = "Monocyte progenitors",`12` = "Monocyte progenitors",
                          `14` = "Plasmacytoid dendritic",
                          `16` = "Plasma",`17` = "Plasma"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("CD4+ naive T" = "#CC6699","CD14+ monocytes" = "#CC33CC", "CD20+ B" = "#6699CC", "NK" = "#FFCC00",
                    "CD16+ monocytes" = "#33CCCC",
                    "Dendritic" = "#FF3366","Monocyte progenitors" = "#FF33FF","Plasmacytoid dendritic" = "#9933CC", "Plasma" = "#663300")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      
      
      if(i %in% c(100)){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[+]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i %in% c(100)){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[+]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/bone-marrow/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }

  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/bone-marrow/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/bone-marrow/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/bone-marrow/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/bone-marrow/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/bone-marrow/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/bone-marrow/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/bone-marrow/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/bone-marrow/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/bone-marrow.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/bone-marrow/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/bone-marrow.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/bone-marrow/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/bone-marrow.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/bone-marrow.csv")
  }
  
}





#######################################################################################################脑brain
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  {
    cp /data03/ZLX/brain/* /data03/HCB/aging/brain/
      
      cd /data03/HCB/aging/brain/autism_young/4341/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5387/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5408/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5538/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5577/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5893/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5936/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5958/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/autism_young/5976/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391908/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391909/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391913/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391915/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391918/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391919/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391925/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391922/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391921/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391926/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391927/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391928/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391930/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391931/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391932/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391933/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391935/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/depressive_mid/SRR12391937/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    
    
    cd /data03/HCB/aging/brain/AD_old/D17-8753/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8755/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8757/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8759/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8761/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8763/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8765/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8767/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8769/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8771/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8773/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8775/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8777/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8779/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8781/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8783/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8785/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8787/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8789/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8791/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8793/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8795/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8797/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/aging/brain/AD_old/D17-8799/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cp -r /data03/ZLX/brain/depressive_mid/5546/ /data03/HCB/GJJ/data/
    cp -r /data03/ZLX/brain/depressive_mid/5609/ /data03/HCB/GJJ/data/
    cp -r /data03/ZLX/brain/depressive_mid/5891/ /data03/HCB/GJJ/data/
    
    cd /data03/HCB/GJJ/data/5546/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/GJJ/data/5609/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    cd /data03/HCB/GJJ/data/5891/
      gunzip barcodes.tsv.gz
    gunzip features.tsv.gz
    mv features.tsv genes.tsv
    gunzip matrix.mtx.gz
    
    
    
    
    youth1 <- Read10X("/data03/HCB/aging/brain/autism_young/4341/")
    colnames(youth1) <- paste(colnames(youth1),"_youth1",sep = "")
    
    youth2 <- Read10X("/data03/HCB/aging/brain/autism_young/5387/")
    colnames(youth2) <- paste(colnames(youth2),"_youth2",sep = "")
    
    youth3 <- Read10X("/data03/HCB/aging/brain/autism_young/5408/")
    colnames(youth3) <- paste(colnames(youth3),"_youth3",sep = "")
    
    youth4 <- Read10X("/data03/HCB/aging/brain/autism_young/5538/")
    colnames(youth4) <- paste(colnames(youth4),"_youth4",sep = "")
    
    youth5 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391922/")
    colnames(youth5) <- paste(colnames(youth5),"_youth5",sep = "")
    
    youth6 <- Read10X("/data03/HCB/aging/brain/autism_young/5893/")
    colnames(youth6) <- paste(colnames(youth6),"_youth6",sep = "")
    
    youth7 <- Read10X("/data03/HCB/aging/brain/autism_young/5936/")
    colnames(youth7) <- paste(colnames(youth7),"_youth7",sep = "")
    
    youth8 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391915/")
    colnames(youth8) <- paste(colnames(youth8),"_youth8",sep = "")
    
    youth9 <- Read10X("/data03/HCB/aging/brain/autism_young/5976/")
    colnames(youth9) <- paste(colnames(youth9),"_youth9",sep = "")
    
    youth10 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391909/")
    colnames(youth10) <- paste(colnames(youth10),"_youth10",sep = "")
    
    scRNA1 <- CreateSeuratObject(youth1,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA2 <- CreateSeuratObject(youth2,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA3 <- CreateSeuratObject(youth3,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA4 <- CreateSeuratObject(youth4,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA5 <- CreateSeuratObject(youth5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA6 <- CreateSeuratObject(youth6,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA7 <- CreateSeuratObject(youth7,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA8 <- CreateSeuratObject(youth8,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA9 <- CreateSeuratObject(youth9,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA10 <- CreateSeuratObject(youth10,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    
    scRNA1 <- merge(scRNA1,scRNA2)
    scRNA3 <- merge(scRNA3,scRNA4)
    scRNA5 <- merge(scRNA5,scRNA6)
    scRNA7 <- merge(scRNA7,scRNA8)
    scRNA9 <- merge(scRNA9,scRNA10)
    
    scRNA1 <- merge(scRNA1,scRNA3)
    scRNA1 <- merge(scRNA1,scRNA5)
    scRNA1 <- merge(scRNA1,scRNA7)
    scRNA01 <- merge(scRNA1,scRNA9)
    saveRDS(scRNA01, "scRNA01.rds")
    
    
    
    mid1 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391937/")
    colnames(mid1) <- paste(colnames(mid1),"_mid1",sep = "")
    
    mid2 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391935/")
    colnames(mid2) <- paste(colnames(mid2),"_mid2",sep = "")
    
    mid3 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391933/")
    colnames(mid3) <- paste(colnames(mid3),"_mid3",sep = "")
    
    mid4 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391932/")
    colnames(mid4) <- paste(colnames(mid4),"_mid4",sep = "")
    
    mid5 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391931/")
    colnames(mid5) <- paste(colnames(mid5),"_mid5",sep = "")
    
    mid6 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391930/")
    colnames(mid6) <- paste(colnames(mid6),"_mid6",sep = "")
    
    mid7 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391928/")
    colnames(mid7) <- paste(colnames(mid7),"_mid7",sep = "")
    
    mid8 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391927/")
    colnames(mid8) <- paste(colnames(mid8),"_mid8",sep = "")
    
    mid9 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391926/")
    colnames(mid9) <- paste(colnames(mid9),"_mid9",sep = "")
    
    mid10 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391921/")
    colnames(mid10) <- paste(colnames(mid10),"_mid10",sep = "")
    
    mid11 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391913/")
    colnames(mid11) <- paste(colnames(mid11),"_mid11",sep = "")
    
    mid12 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391925/")
    colnames(mid12) <- paste(colnames(mid12),"_mid12",sep = "")
    
    mid13 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391919/")
    colnames(mid13) <- paste(colnames(mid13),"_mid13",sep = "")
    
    mid14 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391918/")
    colnames(mid14) <- paste(colnames(mid14),"_mid14",sep = "")
    
    mid15 <- Read10X("/data03/HCB/aging/brain/autism_young/5958/")
    colnames(mid15) <- paste(colnames(mid15),"_mid15",sep = "")
    
    mid16 <- Read10X("/data03/HCB/aging/brain/autism_young/5577/")
    colnames(mid16) <- paste(colnames(mid16),"_mid16",sep = "")
    
    mid17 <- Read10X("/data03/HCB/GJJ/data/5546/")
    colnames(mid17) <- paste(colnames(mid17),"_mid17",sep = "")
    
    mid18 <- Read10X("/data03/HCB/GJJ/data/5609/")
    colnames(mid18) <- paste(colnames(mid18),"_mid18",sep = "")
    
    mid19 <- Read10X("/data03/HCB/GJJ/data/5891/")
    colnames(mid19) <- paste(colnames(mid19),"_mid19",sep = "")
    
    
    
    scRNA1 <- CreateSeuratObject(mid1,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA2 <- CreateSeuratObject(mid2,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA3 <- CreateSeuratObject(mid3,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA4 <- CreateSeuratObject(mid4,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA5 <- CreateSeuratObject(mid5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA6 <- CreateSeuratObject(mid6,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA7 <- CreateSeuratObject(mid7,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA8 <- CreateSeuratObject(mid8,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA9 <- CreateSeuratObject(mid9,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA10 <- CreateSeuratObject(mid10,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA11 <- CreateSeuratObject(mid11,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA12 <- CreateSeuratObject(mid12,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA13 <- CreateSeuratObject(mid13,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA14 <- CreateSeuratObject(mid14,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA15 <- CreateSeuratObject(mid15,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA16 <- CreateSeuratObject(mid16,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA17 <- CreateSeuratObject(mid16,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA18 <- CreateSeuratObject(mid16,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA19 <- CreateSeuratObject(mid16,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    
    
    scRNA1 <- merge(scRNA1,scRNA2)
    scRNA3 <- merge(scRNA3,scRNA4)
    scRNA5 <- merge(scRNA5,scRNA6)
    scRNA7 <- merge(scRNA7,scRNA8)
    scRNA9 <- merge(scRNA9,scRNA10)
    scRNA11 <- merge(scRNA11,scRNA12)
    scRNA13 <- merge(scRNA13,scRNA14)
    scRNA15 <- merge(scRNA15,scRNA16)
    scRNA17 <- merge(scRNA17,scRNA18)
    
    scRNA1 <- merge(scRNA1,scRNA3)
    scRNA5 <- merge(scRNA5,scRNA7)
    scRNA9 <- merge(scRNA9,scRNA11)
    scRNA13 <- merge(scRNA13,scRNA15)
    scRNA17 <- merge(scRNA17,scRNA19)
    
    scRNA1 <- merge(scRNA1,scRNA5)
    scRNA1 <- merge(scRNA1,scRNA9)
    scRNA1 <- merge(scRNA1,scRNA13)
    scRNA02 <- merge(scRNA1,scRNA17)
    
    table(scRNA02$orig.ident)
    saveRDS(scRNA02, "scRNA02.rds")
    
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    old1 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8753/")
    colnames(old1) <- paste(colnames(old1),"_old1",sep = "")
    
    old2 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8755/")
    colnames(old2) <- paste(colnames(old2),"_old2",sep = "")
    
    old3 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8757/")
    colnames(old3) <- paste(colnames(old3),"_old3",sep = "")
    
    old4 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8759/")
    colnames(old4) <- paste(colnames(old4),"_old4",sep = "")
    
    old5 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8761/")
    colnames(old5) <- paste(colnames(old5),"_old5",sep = "")
    
    old6 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8763/")
    colnames(old6) <- paste(colnames(old6),"_old6",sep = "")
    
    old7 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8765/")
    colnames(old7) <- paste(colnames(old7),"_old7",sep = "")
    
    old8 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8767/")
    colnames(old8) <- paste(colnames(old8),"_old8",sep = "")
    
    old9 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8769/")
    colnames(old9) <- paste(colnames(old9),"_old9",sep = "")
    
    old10 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8771/")
    colnames(old10) <- paste(colnames(old10),"_old10",sep = "")
    
    old11 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8773/")
    colnames(old11) <- paste(colnames(old11),"_old11",sep = "")
    
    old12 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8775/")
    colnames(old12) <- paste(colnames(old12),"_old12",sep = "")
    
    old13 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8777/")
    colnames(old13) <- paste(colnames(old13),"_old13",sep = "")
    
    old14 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8779/")
    colnames(old14) <- paste(colnames(old14),"_old14",sep = "")
    
    old15 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8781/")
    colnames(old15) <- paste(colnames(old15),"_old15",sep = "")
    
    old16 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8783/")
    colnames(old16) <- paste(colnames(old16),"_old16",sep = "")
    
    old17 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8785/")
    colnames(old17) <- paste(colnames(old17),"_old17",sep = "")
    
    old18 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8787/")
    colnames(old18) <- paste(colnames(old18),"_old18",sep = "")
    
    old19 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8789/")
    colnames(old19) <- paste(colnames(old19),"_old19",sep = "")
    
    old20 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8791/")
    colnames(old20) <- paste(colnames(old20),"_old20",sep = "")
    
    old21 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8793/")
    colnames(old21) <- paste(colnames(old21),"_old21",sep = "")
    
    old22 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8795/")
    colnames(old22) <- paste(colnames(old22),"_old22",sep = "")
    
    old23 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8797/")
    colnames(old23) <- paste(colnames(old23),"_old23",sep = "")
    
    old24 <- Read10X("/data03/HCB/aging/brain/AD_old/D17-8799/")
    colnames(old24) <- paste(colnames(old24),"_old24",sep = "")
    
    old25 <- Read10X("/data03/HCB/aging/brain/depressive_mid/SRR12391908/")
    colnames(old25) <- paste(colnames(old25),"_old25",sep = "")
    
    scRNA1 <- CreateSeuratObject(old1,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA2 <- CreateSeuratObject(old2,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA3 <- CreateSeuratObject(old3,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA4 <- CreateSeuratObject(old4,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA5 <- CreateSeuratObject(old5,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA6 <- CreateSeuratObject(old6,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA7 <- CreateSeuratObject(old7,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA8 <- CreateSeuratObject(old8,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA9 <- CreateSeuratObject(old9,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA10 <- CreateSeuratObject(old10,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA11 <- CreateSeuratObject(old11,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA12 <- CreateSeuratObject(old12,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA13 <- CreateSeuratObject(old13,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA14 <- CreateSeuratObject(old14,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA15 <- CreateSeuratObject(old15,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA16 <- CreateSeuratObject(old16,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA17 <- CreateSeuratObject(old17,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA18 <- CreateSeuratObject(old18,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA19 <- CreateSeuratObject(old19,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA20 <- CreateSeuratObject(old20,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA21 <- CreateSeuratObject(old21,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA22 <- CreateSeuratObject(old22,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA23 <- CreateSeuratObject(old23,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA24 <- CreateSeuratObject(old24,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    scRNA25 <- CreateSeuratObject(old25,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    
    scRNA1 <- merge(scRNA1,scRNA2)
    scRNA3 <- merge(scRNA3,scRNA4)
    scRNA5 <- merge(scRNA5,scRNA6)
    scRNA7 <- merge(scRNA7,scRNA8)
    scRNA9 <- merge(scRNA9,scRNA10)
    scRNA11 <- merge(scRNA11,scRNA12)
    scRNA13 <- merge(scRNA13,scRNA14)
    scRNA15 <- merge(scRNA15,scRNA16)
    scRNA17 <- merge(scRNA17,scRNA18)
    scRNA19 <- merge(scRNA19,scRNA20)
    scRNA21 <- merge(scRNA21,scRNA22)
    scRNA23 <- merge(scRNA23,scRNA24)
    
    scRNA1 <- merge(scRNA1,scRNA3)
    scRNA5 <- merge(scRNA5,scRNA7)
    scRNA9 <- merge(scRNA9,scRNA11)
    scRNA13 <- merge(scRNA13,scRNA15)
    scRNA17 <- merge(scRNA17,scRNA19)
    scRNA21 <- merge(scRNA21,scRNA23)
    
    scRNA1 <- merge(scRNA1,scRNA5)
    scRNA1 <- merge(scRNA1,scRNA9)
    scRNA1 <- merge(scRNA1,scRNA13)
    scRNA1 <- merge(scRNA1,scRNA17)
    scRNA03 <- merge(scRNA1,scRNA21)
    scRNA03 <- merge(scRNA03,scRNA25)
    table(scRNA03$orig.ident)
    saveRDS(scRNA03, "scRNA03.rds")
    scRNA01 <- readRDS("scRNA01.rds")
    scRNA02 <- readRDS("scRNA02.rds")
    
    scRNA <- merge(scRNA01,scRNA02)
    scRNA <- merge(scRNA,scRNA03)
  }
  {

    table(scRNA$orig.ident)
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=6000
    maxUMI=20000
    pctMT=50
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 100,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("brain2.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 35,height = 10)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `21` = "Endothelial",`24` = "Endothelial",
                          `22` = "Astrocytes",`23` = "Astrocytes",
                          `8` = "OPCs",`12` = "OPCs",
                          `0` = "Oligodendrocytes",
                          `1` = "Excitatory neurons",`3` = "Excitatory neurons",`4` = "Excitatory neurons",`5` = "Excitatory neurons",`9` = "Excitatory neurons",
                          `10` = "Excitatory neurons",`13` = "Excitatory neurons",`14` = "Excitatory neurons",`15` = "Excitatory neurons",`17` = "Excitatory neurons",
                          `18` = "Excitatory neurons",`19` = "Excitatory neurons",`20` = "Excitatory neurons",
                          `2` = "Inhibitory neurons",`6` = "Inhibitory neurons",`7` = "Inhibitory neurons",`11` = "Inhibitory neurons",`16` = "Inhibitory neurons"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else{orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    unique(as.character(UmapTsne[,5]))
    ##############################Cluster图
    value_temp <- c("Endothelial" = "#CC6699","Astrocytes" = "#CC33CC", "OPCs" = "#6699CC", "Excitatory neurons" = "#FFCC00", 
                    "Inhibitory neurons" = "#33CCCC","Oligodendrocytes" = "#FF3366")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    write.csv(UmapTsne,"/data03/HCB/GJJ/result/UmapTsne.csv")
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }

  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'old', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'youth', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-old
    if(!dir.exists(paste("./result/DEG/youth-old/"))){
      dir.create(paste("./result/DEG/youth-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'old', ident.2 = 'youth', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/brain/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
          
        }
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  ###表达模式
  {
    filea <- "/data03/HCB/aging/brain/result/DEG/"
    setwd(paste(filea,"mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    
    if(!dir.exists(paste(filea,"patten/",sep = ""))){
      dir.create(paste(filea,"patten/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/UP/",sep = ""))){
      dir.create(paste(filea,"patten/UP/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/DOWN/",sep = ""))){
      dir.create(paste(filea,"patten/DOWN/",sep = ""))
    }
    
    for (i in 1:dim(temp)[1]) {
      youth_mid <- read.table(paste(filea,"youth-mid/",temp[i,3],"_DEG_youth_mid.txt",sep = ""))
      mid_old <- read.table(paste(filea,"mid-old/",temp[i,3],"_DEG_mid_old.txt",sep = ""))
      youth_old <- read.table(paste(filea,"youth-old/",temp[i,3],"_DEG_youth_old.txt",sep = ""))
      #########UP
      youth_mid_old_UP_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="UP")],rownames(mid_old)[which(mid_old[,"change"]=="UP")])
      rep_youth_old_gene <- intersect(youth_mid_old_UP_gene,rownames(youth_old)[which(youth_old[,"change"]=="UP")])
      a <- length(youth_mid_old_UP_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        UP <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(UP) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(UP) <- c("youth_mid_old_UP")
        UP[1,1:a] <- c(youth_mid_old_UP_gene,rep(NA,a))[1:a]
        UP[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(UP,paste(filea,"patten/UP/",temp[i,3],"_UP.txt",sep = ""))
      }
      #########DOWN
      youth_mid_old_DOWN_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="DOWN")],rownames(mid_old)[which(mid_old[,"change"]=="DOWN")])
      rep_youth_old_gene <- intersect(youth_mid_old_DOWN_gene,rownames(youth_old)[which(youth_old[,"change"]=="DOWN")])
      a <- length(youth_mid_old_DOWN_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        DOWN <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(DOWN) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(DOWN) <- "youth_mid_old_DOWN"
        DOWN[1,1:a] <- c(youth_mid_old_DOWN_gene,rep(NA,a))[1:a]
        DOWN[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(DOWN,paste(filea,"patten/DOWN/",temp[i,3],"_DOWN.txt",sep = ""))
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/brain/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(youth_counts[j,]),mid_counts[j,],youth_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        youth_counts = youth@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,]),length(old_counts[j,]),youth_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/brain/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
          
        }
        #############youth_old
        if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/brain/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/brain/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
    {
      cd /data03/HCB/aging/brain/result/Scenic/youth_mid/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/brain/result/Scenic/youth_mid/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
    {
      cd /data03/HCB/aging/brain/result/Scenic/youth_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/brain/result/Scenic/youth_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("/data03/HCB/aging/hTFtarget/tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/brain/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/brain/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/brain/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    #############youth_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/brain/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/brain.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/brain/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/brain.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/brain/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/brain.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/brain.csv")
  }
  
}





#######################################################################################################肾kidney
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  ulimit::memory_limit(100000)
  
  {
    mid1 <- read.table("GSM4008620_Adult-Kidney3_dge.txt",row.names = 1,header = T)
    colnames(mid1) <- paste(colnames(mid1),"_mid1",sep = "")
    mid2 <- read.table("GSM4008621_Adult-Kidney4-1_dge.txt",row.names = 1,header = T)
    colnames(mid2) <- paste(colnames(mid2),"_mid2",sep = "")
    mid3 <- read.table("GSM4008622_Adult-Kidney4-2_dge.txt",row.names = 1,header = T)
    colnames(mid3) <- paste(colnames(mid3),"_mid3",sep = "")
    old <-read.table("GSM4008619_Adult-Kidney2_dge.txt",row.names = 1,header = T)
    colnames(old) <- paste(colnames(old),"_old",sep = "")
    
    mid1 <- na.omit(mid1)
    mid2 <- na.omit(mid2)
    mid3 <- na.omit(mid3)
    old <- na.omit(old)
    a <- intersect(rownames(mid1),rownames(mid2))
    a <- intersect(a,rownames(mid3))
    a <- intersect(a,rownames(old))
    mid1 <- mid1[a,]
    mid2 <- mid2[a,]
    mid3 <- mid3[a,]
    old <- old[a,]
    
    scRNA <- cbind(mid1,mid2)
    scRNA <- cbind(scRNA,mid3)
    scRNA <- cbind(scRNA,old)
    scRNA <- CreateSeuratObject(scRNA,project = "scRNA tutorial",min.cells = 10,min.features = 200,names.field = 2,names.delim = "_")
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    table(scRNA$orig.ident)
    
    saveRDS(scRNA, "scRNA.rds")
    #scRNA <- readRDS("scRNA.rds")
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=2000
    maxUMI=4000
    pctMT=50
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("kidneys.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `3` = "Proximal tubules", `8` = "Proximal tubules", `23` = "Proximal tubules", 
                          `5` = "Loop of Henle",`11` = "Loop of Henle",`12` = "Loop of Henle",`13` = "Loop of Henle",`21` = "Loop of Henle",
                          `7` = "Loop of Henle",`25` = "Loop of Henle",`27` = "Loop of Henle",
                          `15` = "Distal",`16` = "Distal",`17` = "Distal",
                          `22` = "Collecting_duct_A",
                          `0` = "Collecting_duct_B",`1` = "Collecting_duct_B",`14` = "Collecting_duct_B",
                          `28` = "Vascular(GE)",
                          `20` = "Vascular(DV)",
                          `2` = "Vascular(AV1)",`9` = "Vascular(AV1)",`26` = "Vascular(AV1)",`18` = "Vascular(AV1)",`24` = "Vascular(AV1)",`10` = "Vascular(AV1)",
                          `4` = "Vascular(AV2)",`6` = "Vascular(AV2)",`19` = "Vascular(AV2)"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else
      {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    
    ##############################Cluster图
    value_temp <- c("Proximal tubules" = "#CC6699","Loop of Henle" = "#CC33CC", "Distal" = "#6699CC", "Collecting_duct_A" = "#FFCC00",
                    "Collecting_duct_B" = "#33CCCC",
                    "Vascular(GE)" = "#FF3366","Vascular(DV)" = "#FF33FF", "Vascular(AV1)" = "#9933CC", "Vascular(AV2)" = "#663300")
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'old', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      
      
      if(i %in% c(20)){
        write.table(DEG,file=paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.txt",sep=""))
      }else{
        write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      }
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      
      if(i %in% c(20)){
        png(paste0("./result/DEG/mid-old/",strsplit(x=as.character(cluster[i]),split='[/]')[[1]][1],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }else{
        png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      }
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data03/HCB/aging/kidney/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    ulimit::memory_limit(100000)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data03/HCB/aging/CVDemo.cpp")
    
    filea <- "/data03/HCB/aging/kidney/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,]),length(old_counts[j,]),mid_counts[j,],old_counts[j,]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4000,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  
  ##转录因子
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data03/HCB/aging/kidney/"
        
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data03/HCB/aging/pyscenic/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data03/HCB/aging/pyscenic/utils/AvgN.R")
          source("/data03/HCB/aging/pyscenic/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
    }
    
    {
      cd /data03/HCB/aging/kidney/result/Scenic/mid_old/
        mkdir output
      bash "/data03/HCB/aging/test/s2_runPySCENIC.sh" avg20_rep
      cp "/data03/HCB/aging/test/s3_postSCENIC.py" /data03/HCB/aging/kidney/result/Scenic/mid_old/
        bash "/data03/HCB/aging/test/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data03/HCB/aging/kidney/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data03/HCB/aging/TRRUST2/TRRUST2.csv",header=T)
    
    filea <- "/data03/HCB/aging/kidney/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data03/HCB/aging/kidney/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/kidney/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/kidney.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data03/HCB/aging/kidney/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/kidneys.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data03/HCB/aging/kidney/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data03/HCB/aging/marker/kidneys.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    } 
    
    write.csv(res,"/data03/HCB/aging/cell_number/kidney.csv")
  }
  
}






############################################################################################################################H5ad
###肠道ileum
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)
  
  {
    Convert("/data/HCB/aging/ileum/Full_obj_raw_counts_nosoupx.h5ad", "h5seurat",overwrite = TRUE,assay = "RNA")
    scRNA1 <- LoadH5Seurat("/data/HCB/aging/ileum/Full_obj_raw_counts_nosoupx.h5seurat")
    scRNA1_counts<-scRNA1[["RNA"]]@counts
    
    youth_meta <- as.data.frame(scRNA1@meta.data[,c(3,2,1)])
    youth_meta <- youth_meta[which(youth_meta[,2]=="Healthy adult" | youth_meta[,2]=="Pediatric healthy"),]
    youth_meta[,1] <- as.character(youth_meta[,1])
    youth_meta1 <- youth_meta[which(youth_meta[,1]%in%c('4','6','9','10','12')),]
    youth_meta2 <- distinct(youth_meta1,Age,Sample.name,.keep_all = T)
    for (i in 1:length(rownames(youth_meta2))){
      meta_temp <- youth_meta1[which(youth_meta1[,3]==youth_meta2[i,3]),]
      temp <- scRNA1_counts[,rownames(meta_temp)]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","youth",i,sep = "")
      if(i==1){  
        scdata1 <- temp
      }else{
        scdata1 <- cbind(scdata1,temp)  
      } 
    }
    
    youth_meta1 <- youth_meta[which(youth_meta[,1]%in%c('25-30','45-50','20-25')),]
    youth_meta2 <- distinct(youth_meta1,Age,Sample.name,.keep_all = T)
    for (i in 1:length(rownames(youth_meta2))){
      meta_temp <- youth_meta1[which(youth_meta1[,3]==youth_meta2[i,3]),]
      temp <- scRNA1_counts[,rownames(meta_temp)]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","mid",i,sep = "")
      if(i==1){  
        scdata2 <- temp
      }else{
        scdata2 <- cbind(scdata2,temp)  
      } 
    }
    
    youth_meta1 <- youth_meta[which(youth_meta[,1]%in%c('60-65','65-70','70-75')),]
    youth_meta2 <- distinct(youth_meta1,Age,Sample.name,.keep_all = T)
    for (i in 1:length(rownames(youth_meta2))){
      meta_temp <- youth_meta1[which(youth_meta1[,3]==youth_meta2[i,3]),]
      temp <- scRNA1_counts[,rownames(meta_temp)]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","old",i,sep = "")
      if(i==1){  
        scdata3 <- temp
      }else{
        scdata3 <- cbind(scdata3,temp)  
      } 
    }
    
    setwd("/data/HCB/aging/ileum/")
    #########################################################################################################################数据处理
    experiment.data <- cbind(scdata1,scdata2)
    experiment.data <- cbind(experiment.data,scdata3)
    saveRDS(experiment.data,"experiment_data.rds")
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    
    table(scRNA$orig.ident)
    saveRDS(scRNA,"scRNA1.rds")
    scRNA <- readRDS('scRNA1.rds')
    
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=5000
    maxUMI=30000
    pctMT=50
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 0.7) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("ileum.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `13` = "Epithelial", `30` = "Epithelial", 
                          `1` = "B",`12` = "B",`35` = "B",
                          `9` = "Plasma",`19` = "Plasma",`32` = "Plasma",`39` = "Plasma",`48` = "Plasma",
                          `0` = "T",`3` = "T",`38` = "T",`42` = "T",`50` = "T",
                          `10` = "Glial",`37` = "Glial",
                          `6` = "Goblet",
                          `2` = "Monocytes",`4` = "Monocytes",`5` = "Monocytes",`7` = "Monocytes",`8` = "Monocytes",`11` = "Monocytes",
                          `14` = "Monocytes",`15` = "Monocytes",`16` = "Monocytes",`17` = "Monocytes",`18` = "Monocytes",`20` = "Monocytes",
                          `22` = "Monocytes",`23` = "Monocytes",`24` = "Monocytes",`25` = "Monocytes",`27` = "Monocytes",`28` = "Monocytes",
                          `29` = "Monocytes",`31` = "Monocytes",`33` = "Monocytes",`34` = "Monocytes",`36` = "Monocytes",`41` = "Monocytes",
                          `43` = "Monocytes",`44` = "Monocytes",`45` = "Monocytes",`46` = "Monocytes",`47` = "Monocytes",`49` = "Monocytes",
                          `52` = "Monocytes",
                          `21` = "Paneth",`40` = "Paneth",`51` = "Paneth",
                          `26` = "Pericytes"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else
      {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique( UmapTsne[,6])
    ##############################Cluster图
    value_temp <- c("Epithelial" = "#CC6699","B" = "#CC33CC", "Plasma" = "#6699CC", "T" = "#FFCC00",
                    "Glial" = "#33CCCC",
                    "Goblet" = "#FF3366","Monocytes" = "#FF33FF", "Paneth" = "#9933CC", "Pericytes" = "#663300")
 
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("youth" = "#009900","mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#009900","mid" = "#FFFFFF","old" = "#FFFFFF")
      png(paste0("./result/CellGroup1.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("youth" = "#FFFFFF","mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-mid
    if(!dir.exists(paste("./result/DEG/youth-mid/"))){
      dir.create(paste("./result/DEG/youth-mid/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'mid', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-mid/",cluster[i],"_DEG_youth_mid.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    #################youth-old
    if(!dir.exists(paste("./result/DEG/youth-old/"))){
      dir.create(paste("./result/DEG/youth-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'youth', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs( avg_log2FC)) + 2*sd(abs( avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.txt"))
      
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/youth-old/",cluster[i],"_DEG_youth_old.png"),width = 1500,height = 850)
      p <- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data/HCB/aging/ileum/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"DEG/GO/youth-mid/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))),orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-mid/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
          
        }
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"DEG/GO/youth-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID)>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/youth-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  ###表达模式
  {
    filea <- "/data/HCB/aging/ileum/result/DEG/"
    setwd(paste(filea,"mid-old/",sep = ""))
    filenames <- list.files()
    temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
    temp[,1] <- filenames
    for (i in 1:length(filenames)) {
      temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
      temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
    }
    temp <- temp[which(temp[,2]=="txt"),]
    
    if(!dir.exists(paste(filea,"patten/",sep = ""))){
      dir.create(paste(filea,"patten/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/UP/",sep = ""))){
      dir.create(paste(filea,"patten/UP/",sep = ""))
    }
    if(!dir.exists(paste(filea,"patten/DOWN/",sep = ""))){
      dir.create(paste(filea,"patten/DOWN/",sep = ""))
    }
    
    for (i in 1:dim(temp)[1]) {
      youth_mid <- read.table(paste(filea,"youth-mid/",temp[i,3],"_DEG_youth_mid.txt",sep = ""))
      mid_old <- read.table(paste(filea,"mid-old/",temp[i,3],"_DEG_mid_old.txt",sep = ""))
      youth_old <- read.table(paste(filea,"youth-old/",temp[i,3],"_DEG_youth_old.txt",sep = ""))
      #########UP
      youth_mid_old_UP_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="UP")],rownames(mid_old)[which(mid_old[,"change"]=="UP")])
      rep_youth_old_gene <- intersect(youth_mid_old_UP_gene,rownames(youth_old)[which(youth_old[,"change"]=="UP")])
      a <- length(youth_mid_old_UP_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        UP <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(UP) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(UP) <- c("youth_mid_old_UP")
        UP[1,1:a] <- c(youth_mid_old_UP_gene,rep(NA,a))[1:a]
        UP[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(UP,paste(filea,"patten/UP/",temp[i,3],"_UP.txt",sep = ""))
      }
      #########DOWN
      youth_mid_old_DOWN_gene <- intersect(rownames(youth_mid)[which(youth_mid[,"change"]=="DOWN")],rownames(mid_old)[which(mid_old[,"change"]=="DOWN")])
      rep_youth_old_gene <- intersect(youth_mid_old_DOWN_gene,rownames(youth_old)[which(youth_old[,"change"]=="DOWN")])
      a <- length(youth_mid_old_DOWN_gene)
      b <- length(rep_youth_old_gene)
      if((a+b)>0){
        DOWN <- as.data.frame(array(NA,dim = c(1,a+b)))
        colnames(DOWN) <- c(rep("gene",a),rep("rep_gene",b))
        rownames(DOWN) <- "youth_mid_old_DOWN"
        DOWN[1,1:a] <- c(youth_mid_old_DOWN_gene,rep(NA,a))[1:a]
        DOWN[1,(a+1):(a+b)] <- c(rep_youth_old_gene,rep(NA,a))[1:b]
        write.table(DOWN,paste(filea,"patten/DOWN/",temp[i,3],"_DOWN.txt",sep = ""))
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data/HCB/aging/CVDemo.cpp")
    
    filea <- "/data/HCB/aging/ileum/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    
    table(Idents(scRNA), scRNA$group)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        if(dim(mid)[2]>25000){colmid <- unique(floor(runif(25000,min=1,max = dim(mid)[2])))}else(colmid <- 1:(dim(mid)[2]))
        if(dim(old)[2]>25000){colold <- unique(floor(runif(25000,min=1,max = dim(old)[2])))}else(colold <- 1:(dim(old)[2]))
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,colmid]),length(old_counts[j,colold]),
                                       mid_counts[j,colmid],old_counts[j,colold]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-mid
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_mid/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        mid_counts = mid@assays$RNA@data
        youth_counts = youth@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        if(dim(mid)[2]>25000){colmid <- unique(floor(runif(25000,min=1,max = dim(mid)[2])))}else(colmid <- 1:(dim(mid)[2]))
        if(dim(youth)[2]>25000){colyouth <- unique(floor(runif(25000,min=1,max = dim(youth)[2])))}else(colyouth <- 1:(dim(youth)[2]))
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,colmid]),length(youth_counts[j,colyouth]),
                                       mid_counts[j,colmid],youth_counts[j,colyouth]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_mid/",cluster[i],"_youth_mid.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    #############youth-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/youth_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        youth <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "youth")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        youth_counts = youth@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        if(dim(youth)[2]>25000){colyouth <- unique(floor(runif(25000,min=1,max = dim(youth)[2])))}else(colyouth <- 1:(dim(youth)[2]))
        if(dim(old)[2]>25000){colold <- unique(floor(runif(25000,min=1,max = dim(old)[2])))}else(colold <- 1:(dim(old)[2]))
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(youth_counts[j,colyouth]),length(old_counts[j,colold]),
                                       youth_counts[j,colyouth],old_counts[j,colold]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/youth_old/",cluster[i],"_youth_old.png",sep = ""),width = 2500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
    
  }
  ######scenic
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        gene_overlap <- read.csv("/data/HCB/aging/database/gene_overlap.csv") 
        gene_overlap <- gene_overlap[,2]
        
        filea <- "/data/HCB/aging/ileum/"
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data/HCB/aging/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data/HCB/aging/utils/AvgN.R")
          source("/data/HCB/aging/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_mid
        if(!dir.exists(paste(filea,"result/Scenic/youth_mid/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_mid/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-mid/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-mid/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","mid"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data/HCB/aging/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data/HCB/aging/utils/AvgN.R")
          source("/data/HCB/aging/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_mid/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_mid/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_mid/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        #############youth_old
        if(!dir.exists(paste(filea,"result/Scenic/youth_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/youth_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/youth-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/youth-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("youth","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data/HCB/aging/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          source("/data/HCB/aging/utils/AvgN.R")
          source("/data/HCB/aging/utils/add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/youth_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/youth_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/youth_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
    }
    
    {
      cd /data/HCB/aging/ileum/result/Scenic/mid_old/
      bash "/data/HCB/aging/s2_runPySCENIC.sh" avg20_rep
      cp "/data/HCB/aging/s3_postSCENIC.py" /data/HCB/aging/ileum/result/Scenic/mid_old/
      bash "/data/HCB/aging/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        emb.tsne <- read.table("output/s3_avg20_rep.tsne.txt", sep = "\t", row.names = 1, header = T)
        emb.umap <- read.table("output/s3_avg20_rep.umap.txt", sep = "\t", row.names = 1, header = T)
        colnames(emb.tsne) <- paste0("tSNE_", 1:2)
        colnames(emb.umap) <- paste0("UMAP_", 1:2)
        cell.info <- readRDS("Cell_info.rds")
        cell.info <- cbind(cell.info, emb.tsne[rownames(cell.info), ])
        cell.info <- cbind(cell.info, emb.umap[rownames(cell.info), ])
        saveRDS(cell.info, "output/s4_cell.info.rds")
        
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data/HCB/aging/ileum/result/Scenic/youth_old/
        bash "/data/HCB/aging/s2_runPySCENIC.sh" avg20_rep
      cp "/data/HCB/aging/s3_postSCENIC.py" /data/HCB/aging/ileum/result/Scenic/youth_old/
        bash "/data/HCB/aging/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        emb.tsne <- read.table("output/s3_avg20_rep.tsne.txt", sep = "\t", row.names = 1, header = T)
        emb.umap <- read.table("output/s3_avg20_rep.umap.txt", sep = "\t", row.names = 1, header = T)
        colnames(emb.tsne) <- paste0("tSNE_", 1:2)
        colnames(emb.umap) <- paste0("UMAP_", 1:2)
        cell.info <- readRDS("Cell_info.rds")
        cell.info <- cbind(cell.info, emb.tsne[rownames(cell.info), ])
        cell.info <- cbind(cell.info, emb.umap[rownames(cell.info), ])
        saveRDS(cell.info, "output/s4_cell.info.rds")
        
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
    {
      cd /data/HCB/aging/ileum/result/Scenic/youth_mid/
        bash "/data/HCB/aging/s2_runPySCENIC.sh" avg20_rep
      cp "/data/HCB/aging/s3_postSCENIC.py" /data/HCB/aging/ileum/result/Scenic/youth_mid/
        bash "/data/HCB/aging/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        emb.tsne <- read.table("output/s3_avg20_rep.tsne.txt", sep = "\t", row.names = 1, header = T)
        emb.umap <- read.table("output/s3_avg20_rep.umap.txt", sep = "\t", row.names = 1, header = T)
        colnames(emb.tsne) <- paste0("tSNE_", 1:2)
        colnames(emb.umap) <- paste0("UMAP_", 1:2)
        cell.info <- readRDS("Cell_info.rds")
        cell.info <- cbind(cell.info, emb.tsne[rownames(cell.info), ])
        cell.info <- cbind(cell.info, emb.umap[rownames(cell.info), ])
        saveRDS(cell.info, "output/s4_cell.info.rds")
        
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("/data/HCB/aging/tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data/HCB/aging/ileum/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"hTFTarget/youth-mid/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-mid/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"hTFTarget/youth-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/youth-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data/HCB/aging/TRRUST2.csv",header=T)
    tf <- tf[which(tf[,1]%in%gene_overlap),]
    
    filea <- "/data/HCB/aging/ileum/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-mid
    if(!dir.exists(paste(filea,"TRRUST2/youth-mid/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-mid/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-mid/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-mid/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
    ##############youth-old
    if(!dir.exists(paste(filea,"TRRUST2/youth-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/youth-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/youth-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/youth-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data/HCB/aging/ileum/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    #############youth_mid
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/youth_mid/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/youth_mid/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/youth_mid/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data/HCB/aging/database/csgene_human.csv")
    CellAge <- read.csv("/data/HCB/aging/database/genage_human.csv")
    HCSGD <- read.csv("/data/HCB/aging/database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data/HCB/aging/database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/ileum/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
      ########youth-old
      {
        setwd(paste(filea,"result/DEG/youth-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
      ########youth-mid
      {
        setwd(paste(filea,"result/DEG/youth-mid",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
        }
        gene_temp <- unique(gene_temp)
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/ileum.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/ileum/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/ileum.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data/HCB/aging/ileum/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/ileum.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data/HCB/aging/cell_number/ileum.csv")
  }
  
}




###心脏heart
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)

  {
    Convert("global_raw.h5ad", "h5seurat",overwrite = TRUE,assay = "RNA")
    scRNA1 <- LoadH5Seurat("global_raw.h5seurat")
    load("raw_SeuratObject.RData")
    scRNA1 <- scRNA
    scRNA1_counts<-scRNA1[["RNA"]]@counts
    
    youth_meta <- as.data.frame(scRNA1@meta.data[,c(2,5)])
    youth_meta[,1] <- as.character(youth_meta[,1])
    unique(youth_meta[,1])
    "50-55" "40-45" "45-50" "55-60" "60-65" "70-75" "65-70"
    
    youth_meta1 <- youth_meta[which(youth_meta[,1]%in%c("50-55","40-45","45-50","55-60")),]
    youth_meta2 <- distinct(youth_meta1,age_group,donor,.keep_all = T)
    for (i in 1:length(rownames(youth_meta2))){
      meta_temp <- youth_meta1[which(youth_meta1[,2]==youth_meta2[i,2]),]
      temp <- scRNA1_counts[,rownames(meta_temp)]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","mid",i,sep = "")
      if(i==1){  
        scdata2 <- temp
      }else{
        scdata2 <- cbind(scdata2,temp)  
      } 
    }
    
    youth_meta1 <- youth_meta[which(youth_meta[,1]%in%c("60-65","70-75","65-70")),]
    youth_meta2 <- distinct(youth_meta1,age_group,donor,.keep_all = T)
    for (i in 1:length(rownames(youth_meta2))){
      meta_temp <- youth_meta1[which(youth_meta1[,2]==youth_meta2[i,2]),]
      temp <- scRNA1_counts[,rownames(meta_temp)]
      colnames(temp) <- paste(gsub("[_]","-",colnames(temp)),"_","old",i,sep = "")
      if(i==1){  
        scdata3 <- temp
      }else{
        scdata3 <- cbind(scdata3,temp)  
      } 
    }
    
    #########################################################################################################################数据处理
    experiment.data <- cbind(scdata2,scdata3)
    saveRDS(experiment.data,"experiment_data.rds")
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      experiment.data,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    table(scRNA$orig.ident)
    saveRDS(scRNA,"scRNA1.rds")
    scRNA <- readRDS('scRNA1.rds')
    
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 9, height = 8)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=4000
    maxUMI=10000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    saveRDS(scRNA,"scRNA2.rds")
    #scRNA <- readRDS('scRNA2.rds')
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    
    saveRDS(scRNA,"scRNA3.rds")
    #scRNA <- readRDS('scRNA3.rds')
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA,"scRNA4.rds")
    #scRNA <- readRDS("scRNA2.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA4.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1.5) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("heart.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `2` = "Fibroblasts", `8` = "Fibroblasts",`11` = "Fibroblasts",`26` = "Fibroblasts",`32` = "Fibroblasts",
                          `34` = "Fibroblasts",`41` = "Fibroblasts",`47` = "Fibroblasts",`52` = "Fibroblasts",`53` = "Fibroblasts",`55` = "Fibroblasts",
                          `4` = "Pericytes",`9` = "Pericytes",`16` = "Pericytes",`19` = "Pericytes",`23` = "Pericytes",
                          `33` = "Pericytes",`28` = "Pericytes",`42` = "Pericytes",`51` = "Pericytes",
                          `29` = "Adipocytes",
                          `22` = "Smooth muscle",`40` = "Smooth muscle",
                          `6` = "Endothelial",`7` = "Endothelial",`10` = "Endothelial",`14` = "Endothelial",`18` = "Endothelial",`20` = "Endothelial",
                          `24` = "Endothelial",`27` = "Endothelial",`35` = "Endothelial",`38` = "Endothelial",`49` = "Endothelial",`50` = "Endothelial",
                          `54` = "Endothelial",`61` = "Endothelial",`62` = "Endothelial",
                          `30` = "Neuronal",`58` = "Neuronal",
                          `5` = "Atrial cardiomyocytes",`44` = "Atrial cardiomyocytes",
                          `12` = "Myeloid",`15` = "Myeloid",`48` = "Myeloid",`43` = "Myeloid",`60` = "Myeloid",
                          `21` = "Lymphoid",`31` = "Lymphoid",`36` = "Lymphoid",`39` = "Lymphoid",`59` = "Lymphoid",
                          `0` = "Ventricular cardiomyocytes",`1` = "Ventricular cardiomyocytes",`3` = "Ventricular cardiomyocytes",
                          `13` = "Ventricular cardiomyocytes",`17` = "Ventricular cardiomyocytes",`25` = "Ventricular cardiomyocytes",
                          `37` = "Ventricular cardiomyocytes",`45` = "Ventricular cardiomyocytes",`46` = "Ventricular cardiomyocytes",
                          `56` = "Ventricular cardiomyocytes",`57` = "Ventricular cardiomyocytes"
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else
      {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    ##############################Cluster图
    value_temp <- c("Fibroblasts" = "#CC6699","Pericytes" = "#CC33CC", "Ventricular cardiomyocytes" = "#6699CC", "Adipocytes" = "#FFCC00",
                    "Smooth muscle" = "#33CCCC","Endothelial" = "#FF3366","Neuronal" = "#FF33FF", 
                    "Atrial cardiomyocytes" = "#9933CC", "Myeloid" = "#663300","Lymphoid" = "#99FF99"
                    )
    
    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    unique(UmapTsne[,"Group"])
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA <- readRDS("scRNA4.rds")
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      rm(scRNA)
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }
    
  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data/HCB/aging/heart/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data/HCB/aging/CVDemo.cpp")
    
    filea <- "/data/HCB/aging/heart/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        if(dim(mid)[2]>25000){colmid <- unique(floor(runif(25000,min=1,max = dim(mid)[2])))}else(colmid <- 1:(dim(mid)[2]))
        if(dim(old)[2]>25000){colold <- unique(floor(runif(25000,min=1,max = dim(old)[2])))}else(colold <- 1:(dim(old)[2]))
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,colmid]),length(old_counts[j,colold]),
                                       mid_counts[j,colmid],old_counts[j,colold]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4000,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
  }
  
  ######scenic
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data/HCB/aging/heart/"
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data/HCB/aging/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data/HCB/aging/utils//AvgN.R")
          source("/data/HCB/aging/utils//add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
    }
    {
      ###环境
      conda env list
      conda activate scenic_protocol 
      ## 安装其它包
      
      cd /data/HCB/aging/heart/result/Scenic/mid_old/
      bash "/data/HCB/aging/s2_runPySCENIC.sh" avg20_rep
      cp "/data/HCB/aging/s3_postSCENIC.py" /data/HCB/aging/heart/result/Scenic/mid_old/
      bash "/data/HCB/aging/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
      conda deactivate
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("/data/HCB/aging/tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data/HCB/aging/heart/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data/HCB/aging/TRRUST2.csv",header=T)
    tf <- tf[which(tf[,1]%in%gene_overlap),]
    
    filea <- "/data/HCB/aging/heart/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data/HCB/aging/heart/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }

    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/heart/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/heart.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/heart/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/heart.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.25,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data/HCB/aging/heart/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/heart.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data/HCB/aging/cell_number/heart.csv")
  }
  
}





###食道oesophagus
{
  library(ggplot2)
  library(cowplot)
  library(Matrix)
  library(dplyr)
  library(readr)
  library(Seurat)
  library(harmony)
  library(tidyverse)
  library(patchwork)
  library(patchwork)
  library(lemon)
  library(MAST)

  {
    scRNA <- readRDS('oesophagus_ts.rds')
    ID <- read.csv("E:/衰老/脾脏/ID.csv")
    scRNA_counts <- read.csv("E:/衰老/脾脏/scRNA_counts.csv",header=T,row.names=1)
    scRNA_counts <- cbind(scRNA_counts,array(NA,dim = c(length(rownames(scRNA_counts)),3)))
    
    ID <- ID[which(ID[,2]=="Esophagus"),]
    ID[which(ID[,3]=="296C"),4] <- "mid1"
    ID[which(ID[,3]=="328C"),4] <- "mid2"
    ID[which(ID[,3]=="356C"),4] <- "mid3"
    ID[which(ID[,3]=="325C"),4] <- "mid4"
    
    ID[which(ID[,3]=="362C"),4] <- "old1"
    ID[which(ID[,3]=="367C"),4] <- "old2"
    
    for (i in 1:length(rownames(scRNA_counts))) {
      scRNA_counts[i,2] <- strsplit(x=as.character(scRNA_counts[i,1]),split='-')[[1]][3]
      scRNA_counts[i,3] <- ID[which(ID[,1]==scRNA_counts[i,2]),4]
      scRNA_counts[i,4] <- paste(strsplit(x=as.character(scRNA_counts[i,1]),split='-')[[1]][1],scRNA_counts[i,3],sep = "_")
    }
    write.csv(scRNA_counts,"E:/衰老/脾脏/ID1.csv")
    ID <- read.csv("ID1.csv",header = T,row.names = 1)
    for (i in 1:length(rownames(ID))) {
      ID[i,4] <- paste(ID[i,1],ID[i,3],sep = "_")
    }
    length(colnames(scRNA)) == length(rownames(ID))
    colnames(scRNA1_counts) <- ID[,4]
    
    #创建一个文件夹用于写分析结果
    sam.name <- "result"
    if(!dir.exists(sam.name)){
      dir.create(sam.name)
    }
    #### 3. 创建Seurat分析对象 ####
    scRNA <- CreateSeuratObject(
      scRNA1_counts,
      project = "scRNA tutorial", 
      min.cells = 10,
      min.features = 200,
      names.field = 2,
      names.delim = "_")
    
    table(scRNA$orig.ident)
    
    #计算线粒体基因比例
    scRNA[["percent.mt"]] <- PercentageFeatureSet(scRNA, pattern = "^MT-") 
    #计算核糖体基因比例
    scRNA[["percent.rb"]] <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]")
    #计算红细胞基因比例
    HB.genes <- c("HBA1","HBA2","HBB","HBD","HBE1","HBG1","HBG2","HBM","HBQ1","HBZ")
    HB.genes <- CaseMatch(HB.genes, rownames(scRNA))
    scRNA[["percent.HB"]]<-PercentageFeatureSet(scRNA, features=HB.genes) 
    saveRDS(scRNA,"scRNA.rds")
    #scRNA <- readRDS('scRNA1.rds')
    #########################################################################################################################质量控制
    ### 绘制质控小提琴图
    # 设置可能用到的主题
    theme.set2 = theme(axis.title.x=element_blank())
    # 设置绘图元素
    plot.featrures = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.rb", "percent.HB")
    group = "orig.ident"
    # 质控前小提琴图
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)    
    dir.create("QC")
    ggsave("QC/vlnplot_before_qc.pdf", plot = violin, width = 20, height = 20)
    ###@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@暂停查看 设置质控标准
    minGene=500
    maxGene=4000
    maxUMI=20000
    pctMT=10
    pctHB=3
    ### 数据质控并绘制小提琴图
    scRNA <- subset(scRNA, subset = nCount_RNA < maxUMI & nFeature_RNA > minGene & nFeature_RNA < maxGene & percent.mt < pctMT & percent.HB < pctHB)
    plots = list()
    for(i in seq_along(plot.featrures)){
      plots[[i]] = VlnPlot(scRNA, group.by=group, pt.size = 0,
                           features = plot.featrures[i]) + theme.set2 + NoLegend()}
    violin <- wrap_plots(plots = plots, nrow=2)     
    ggsave("QC/vlnplot_after_qc.pdf", plot = violin, width = 10, height = 8)
    
    ########################################################################################################################### 降维聚类
    #### 6. 表达量标准化 #### 7. 均一化与PCA #####均一化（需要一点时间）#PCA计算
    scRNA <- NormalizeData(scRNA,normalization.method = "LogNormalize",scale.factor = 10000)
    #计算表达量变化显著的基因FindVariableFeatures
    scRNA <- FindVariableFeatures(scRNA,selection.method = "vst",nfeatures = 2000)
    scRNA <- ScaleData(object = scRNA,do.scale = FALSE,do.center = FALSE,vars.to.regress = c("percent.mt"))
    scRNA <- RunPCA(object = scRNA,features = VariableFeatures(scRNA),verbose = F)
    ### 整合方法单个样本间进行整合（推荐，效果更好）
    saveRDS(scRNA, "scRNA2.rds")
    #scRNA <- readRDS("scRNA2.rds")
    scRNA <- RunHarmony(scRNA, group.by.vars="orig.ident",max.iter.harmony = 30,plot_convergence=FALSE) 
    scRNA@reductions$harmony
    ##重新创建没有处理的经过降维等处理的数据 
    saveRDS(scRNA, "scRNA3.rds")
    #scRNA <- readRDS("scRNA3.rds")
    harmony_embeddings <- Embeddings(scRNA, 'harmony')
    
  }
  
  {
    #######################################################################################################聚类
    scRNA <- readRDS("scRNA3.rds")
    dim.use <- 1:50
    
    scRNA <- scRNA %>%
      RunUMAP(reduction = "harmony", dims = dim.use) %>%
      FindNeighbors(reduction = "harmony", dims = dim.use) %>%
      FindClusters(resolution = 1.5) %>%
      identity()
    #按照聚类分组展示细胞异同-------UMAP
    pdf(paste0("./result/CellCluster-UMPPlot_",max(dim.use),"umap.pdf"),width = 20,height = 20)
    DimPlot(object = scRNA,reduction = "umap", pt.size=1,label = T,label.size = 10)
    dev.off()
    write.table(scRNA@meta.data,file = paste0("./result/result_cells_details_ump_",max(dim.use),"umap.txt"))
    ####################查看marker基因相关性
    gene <- read.csv("oesophagus.csv")
    gene <- unique(gene[,3])
    gene_use <- gene[which(gene%in%rownames(scRNA))]
    gene_useless <- setdiff(gene,gene_use)
    cat("gene_use:",length(gene_use),"  gene_useless:",length(gene_useless))
    pdf(paste0("./result/subcluster-DotPlot.pdf"),width = 70,height = 20)
    DotPlot(object = scRNA,features = gene_use,cols = c("blue", "red"))
    dev.off()
    #################聚类命名
    scRNA <- RenameIdents(scRNA, `25` = "B CD27neg",
                          `20` = "Blood vessel",
                          `1` = "Epithelial dividing",`12` = "Epithelial dividing",`24` = "Epithelial dividing",
                          `0` = "Epithelial stratified",`3` = "Epithelial stratified",`7` = "Epithelial stratified",
                          `13` = "Epithelial stratified",`14` = "Epithelial stratified",`15` = "Epithelial stratified",
                          `16` = "Epithelial stratified",`17` = "Epithelial stratified",`30` = "Epithelial stratified",
                          `22` = "Epithelial suprabasal",
                          `2` = "Epithelial upper",`4` = "Epithelial upper",`5` = "Epithelial upper",
                          `6` = "Epithelial upper",`8` = "Epithelial upper",`9` = "Epithelial upper",
                          `10` = "Epithelial upper",`11` = "Epithelial upper",`18` = "Epithelial upper",
                          `21` = "Epithelial upper",`23` = "Epithelial upper",`27` = "Epithelial upper",
                          `29` = "Lymph vessel",
                          `31` = "Mast cell",
                          `26` = "Mono macro",
                          `28` = "Stroma",
                          `19` = "T CD4"
                          
    )
    
    scRNA <- scRNA %>% RunTSNE(reduction = "harmony", dims = dim.use, do.fast = TRUE)
    scRNA[["ident"]] <- as.character(scRNA@active.ident)
    orig_ident <- as.character(scRNA@meta.data[["orig.ident"]]) 
    class(orig_ident)
    for (i in 1:length(orig_ident)) {
      temp <- as.character(substring(orig_ident[i],1,3))
      if(temp=="you")
      {orig_ident[i]="youth"}
      else if(temp=="mid")
      {orig_ident[i]="mid"}
      else
      {orig_ident[i]="old"}
    }
    scRNA[["group"]] <- orig_ident
    saveRDS(scRNA, "scRNA4.rds")
    #scRNA <- readRDS("scRNA4.rds")
    #########作图
    umap <- scRNA@reductions$umap@cell.embeddings %>%
      as.data.frame()
    UmapTsne <- scRNA@reductions$tsne@cell.embeddings %>%
      as.data.frame() %>% cbind(umap,Cluster = scRNA@meta.data$ident)
    UmapTsne <- cbind(UmapTsne,Group = scRNA@meta.data$group)
    UmapTsne[1:5,]
    unique(UmapTsne[,6])
    
    ##############################Cluster图
    value_temp <- c("B CD27neg" = "#CC6699","Blood vessel" = "#CC33CC", "Epithelial dividing" = "#6699CC", "Epithelial stratified" = "#FFCC00",
                    "Epithelial suprabasal" = "#33CCCC","Epithelial upper" = "#FF3366","Lymph vessel" = "#FF33FF", "Mast cell" = "#9933CC", 
                    "Mono macro" = "#663300","Stroma" = "#99FF99","T CD4" = "#993366")

 

    # value_temp <-c("0" = "#CC6699","1" = "#CC33CC", "2" = "#6699CC", "3" = "#FFCC00", "4" = "#33CCCC",
    #                 "5" = "#FF3366","6" = "#FF33FF", "7" = "#9933CC", "8" = "#663300", "9" = "#99FF99",
    #                 "10" = "#993366","11" = "#CC99FF", "12" = "#666699", "13" = "#FF6600", "14" = "#009966",
    #                 "15" = "#CC0066","16" = "#9900CC", "17" = "#6699FF", "18" = "#33FF00", "19" = "#CCFF99",
    #                 "20" = "#FF9999","21" = "#CC99CC", "22" = "#66CCFF", "23" = "#FF3333", "24" = "#CCFF66",
    #                 "25" = "#FF99FF","26" = "#CC66CC", "27" = "#9999FF", "28" = "#CC6633", "29" = "#009900")
    
    png(paste0("./result/CellCluster.png"),width = 3000,height = 1500)
    umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    
    tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Cluster),size = 0.2, alpha = 1)+
      guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp)+theme_bw(base_size = 30)+
      theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
            panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
            ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
    grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
    dev.off()
    ##############################Group图
    {
      value_temp1 <- c("mid" = "#CC3300","old" = "#000066")
      png(paste0("./result/CellGroup.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#CC3300","old" = "#FFFFFF")
      png(paste0("./result/CellGroup2.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
      
      value_temp1 <- c("mid" = "#FFFFFF","old" = "#000066")
      png(paste0("./result/CellGroup3.png"),width = 3000,height = 1500)
      umap <- ggplot()+ geom_point(data=UmapTsne, aes(y = UMAP_2, x = UMAP_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      
      tsne <- ggplot()+ geom_point(data=UmapTsne, aes(y = tSNE_2, x = tSNE_1,color = Group),size = 0.2, alpha = 1)+
        guides(colour = guide_legend(override.aes = list(size=8)))+scale_color_manual(values=value_temp1)+theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.x = element_text(size = 40,  color = "black")
              ,axis.text.y = element_text(size = 40,  color = "black"),legend.position="bottom",legend.title= element_text(size=40),legend.text = element_text(size=40))
      grid_arrange_shared_legend(umap, tsne, ncol = 2, nrow = 1,position='bottom')
      dev.off()
    }
    
    
    
  }
  
  {
    scRNA <- readRDS("scRNA4.rds")
    cluster <-  unique(distinct(scRNA@meta.data[,c("ident","group")],ident,group,.keep_all = T)[,"ident"])
    unique(scRNA@meta.data[,"group"])
    if(!dir.exists(paste("./result/DEG/"))){
      dir.create(paste("./result/DEG/"))
    }
    #################mid-old
    if(!dir.exists(paste("./result/DEG/mid-old/"))){
      dir.create(paste("./result/DEG/mid-old/"))
    }
    for (i in 1:length(cluster)) {
      scRNA_temp <-subset(scRNA, idents = cluster[i])
      DEG <- FindMarkers(scRNA_temp, ident.1 = 'mid', ident.2 = 'old', group.by="group",test.use = "MAST",logfc.threshold=0)
      DEG = na.omit(DEG)#去除NA
      #画图
      logFC_cutoff <- with(DEG,mean(abs(avg_log2FC)) + 2*sd(abs(avg_log2FC)))#计算阈值
      DEG$change = as.factor(ifelse(DEG$p_val < 0.05 & abs(DEG$avg_log2FC) > logFC_cutoff,
                                    ifelse(DEG$avg_log2FC > logFC_cutoff ,'UP','DOWN'),'NOT'))
      write.table(DEG,file=paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.txt",sep=""))
      this_tile <- paste0('Cutoff logFC:',round(logFC_cutoff,3),
                          '    Up Gene:',nrow(DEG[DEG$change =='UP',]) ,
                          '    Down Gene:',nrow(DEG[DEG$change =='DOWN',]))
      png(paste0("./result/DEG/mid-old/",cluster[i],"_DEG_mid_old.png",sep=""),width = 1500,height = 850)
      p<- ggplot(data=DEG,aes(x=avg_log2FC, y=-log10(p_val),color=change)) +
        geom_point(alpha=0.4, size=4) +guides(colour = guide_legend(override.aes = list(size=8)))+
        xlab("log2 fold change") + ylab("-log10(P.value)") +
        ggtitle(this_tile) +
        scale_colour_manual(values = c('blue','black','red'))+
        theme_bw(base_size = 30)+
        theme(axis.title.x =element_text(size=40), axis.title.y=element_text(size=40),
              panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
              axis.text.x = element_text(size = 40,  color = "black"),
              axis.text.y = element_text(size = 40,  color = "black"),
              legend.title= element_text(size=40),
              legend.text = element_text(size=40),
              plot.title = element_text(hjust = 0.5)) ## corresponding to the levels(res$change)
      print(p)
      dev.off()
    }

  }
  
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    filea <- "/data/HCB/aging/oesophagus/result/"
    if(!dir.exists(paste(filea,"DEG/GO/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"DEG/GO/mid-old/",sep = ""))){
      dir.create(paste(filea,"DEG/GO/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']=="UP")]
        if(length(Up_ID )>5){
          transID = bitr(Up_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_UP.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_UP.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                  axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
        
        Down_ID <- rownames(ID)[which(ID[,'change']=="DOWN")]
        if(length(Down_ID)>5){
          transID = bitr(Down_ID,fromType="SYMBOL",toType=c("ENTREZID"),OrgDb="org.Hs.eg.db")
          eGo_ALL <- enrichGO(transID$ENTREZID,"org.Hs.eg.db",keyType="ENTREZID",ont="ALL")
          eGo_ALL<- setReadable(eGo_ALL, OrgDb=org.Hs.eg.db)
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_DOWN.csv",sep = ""),row.names=F)
            png(file= paste(filea,"DEG/GO/mid-old/",temp[i,3],"_eGO_ALL_Enrichment_DOWN.png",sep = ""),width = 600,height = 600)
            p <- dotplot(eGo_ALL,showCategory=min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + theme(axis.text.y = element_text(size = 15,color = "black"),
                                                                                                                                                                 axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
  }
  
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    library(ggpubr)
    library(Rcpp)
    sourceCpp(file="/data/HCB/aging/CVDemo.cpp")
    
    filea <- "/data/HCB/aging/oesophagus/"
    
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/",sep = ""))
    }
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
    cluster <- unique(scRNA$ident)
    #############mid-old
    if(!dir.exists(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/DEG/GeneCV/mid_old/",sep = ""))
    }
    {
      rowleng <- 2000
      gene_CV <- as.data.frame(array(NA,dim = c(rowleng,length(cluster))))
      rownames(gene_CV) <- VariableFeatures(scRNA)
      colnames(gene_CV) <- cluster
      for (i in 1:length(cluster)) {
        mid <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "mid")
        old <- subset(scRNA, idents = cluster[i], features= VariableFeatures(scRNA), subset = group == "old")
        mid_counts = mid@assays$RNA@data
        old_counts = old@assays$RNA@data
        cat(cluster[i],": Start!","\n")
        if(dim(mid)[2]>25000){colmid <- unique(floor(runif(25000,min=1,max = dim(mid)[2])))}else(colmid <- 1:(dim(mid)[2]))
        if(dim(old)[2]>25000){colold <- unique(floor(runif(25000,min=1,max = dim(old)[2])))}else(colold <- 1:(dim(old)[2]))
        for (j in 1:rowleng) {
          if(j==1){cat("|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|  100%","\n")}
          if((j %% 200) == 1){cat((j-1)/200+1)}
          if((j %% 40) == 0 & j<=1960){cat("-")}
          if(j == 2000){cat("|","\n")}
          gene_CV[j,i] <- GeneCvAble(c(length(mid_counts[j,colmid]),length(old_counts[j,colold]),
                                       mid_counts[j,colmid],old_counts[j,colold]))
        }
      }
      write.csv(gene_CV, paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.csv",sep = ""))
    }
    {
      fig <- as.data.frame(array(NA,dim = c(2000*length(cluster),2)))
      colnames(fig) <- c("exp","cluster")
      for (i in 1:length(cluster)) {
        fig[((i-1)*2000+1):(i*2000),1] <- gene_CV[,i]
        fig[((i-1)*2000+1):(i*2000),2] <- rep(cluster[i],2000)
      }
      fig <- na.omit(fig)
      png(file= paste(filea,"result/DEG/GeneCV/mid_old/",cluster[i],"_mid_old.png",sep = ""),width = 4500,height = 1500)
      p<-ggviolin(fig, x = "cluster", y = "exp",fill = "cluster",palette='npg',add = "boxplot",
                  add.params = list(fill="white",size=0.5))+
        theme_bw(base_size = 40)+ylab("Coefficient of Variation(CV)")+xlab("Cell Type")+
        theme(axis.title.x =element_text(size=45), axis.title.y=element_text(size=45),panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),axis.text.x = element_text(size = 45,  color = "black"),
              axis.text.y = element_text(size = 45,  color = "black"),legend.position = "none")
      print(p)
      dev.off()
    }
  }
  
  ######scenic
  {
    {
      ###########################环境！！！！！！！！！！！！！！！！
      cd /home/HCB/R/x86_64-pc-linux-gnu-library/4.1/hdf5-1.8.13/
        export PATH=$HOME/.local/bin/hdf5-1.8.13/bin:$PATH
        export LD_LIBRARY_PATH=$HOME/.local/bin/hdf5-1.8.13/lib:$LD_LIBRARY_PATH
        
        R
        ###R
        library(plyr)
        library(permute)
        library(SCopeLoomR)
        library(SCENIC)
        library(ggplot2)
        library(cowplot)
        library(Matrix)
        library(dplyr)
        library(readr)
        library(Seurat)
        library(harmony)
        library(tidyverse)
        library(patchwork)
        library(patchwork)
        library(lemon)
        library(MAST)
        
        
        filea <- "/data/HCB/aging/oesophagus/"
        if(!dir.exists(paste(filea,"result/Scenic/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/",sep = ""))
        }
        
        scRNA <- readRDS(paste(filea,"scRNA4.rds",sep = ""))
        
        #############mid_old
        if(!dir.exists(paste(filea,"result/Scenic/mid_old/",sep = ""))){
          dir.create(paste(filea,"result/Scenic/mid_old/",sep = ""))
        }
        {
          filenames <- list.files(paste(filea,"result/DEG/mid-old/",sep = ""))
          temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
          temp[,1] <- filenames
          for (i in 1:length(filenames)) {
            temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
            temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
          }
          temp <- temp[which(temp[,2]=="txt"),]
          for (i in 1:dim(temp)[1]) {
            if(i==1){
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp1 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
            }else{
              DEG <- read.table(paste(filea,"result/DEG/mid-old/",temp[i,1],sep = ""))
              temp2 <- rownames(DEG[which(DEG[,"change"]%in%c("UP","DOWN")),])
              temp1 <- c(temp1,temp2)
            }
          }
          DEG <- intersect(unique(temp1),gene_overlap)
          exp <- subset(scRNA,features= DEG, subset = group %in% c("mid","old"))
          
          Cell_info <- as.data.frame(array(NA,dim = c(dim(exp)[2],3)))
          colnames(Cell_info) <- c("ClusterID","Cell_Type","CellState")
          Cell_info[,1] <- as.character(exp@meta.data[,"seurat_clusters"])
          Cell_info[,2] <- as.character(exp@meta.data[,"ident"])
          Cell_info[,3] <- as.character(exp@meta.data[,"seurat_clusters"])
          rownames(Cell_info) <- as.character(rownames(exp@meta.data)) 
          data <- as.matrix(exp@assays$RNA@data)
          scenicOptions <- initializeScenic(
            org="hgnc", # 物种名 or hgnc, or dmel
            dbDir="/data/HCB/aging/utils/", # RcisTarget databases location
            dbs="hg38__refseq-r80__500bp_up_and_100bp_down_tss.mc9nr.feather", # file name of motif database
            datasetTitle="SCENIC on Human Cell Atlas", # choose a name for your analysis
            nCores=1
          )
          genesKept <- geneFiltering(
            exprMat=data, 
            scenicOptions=scenicOptions,
            minCountsPerGene = 1,
            minSamples = 20
          )
          data <- data[genesKept,]
          colnames(data) <- rownames(Cell_info)
          source("/data/HCB/aging/utils//AvgN.R")
          source("/data/HCB/aging/utils//add_cellAnnotation.R")
          avg20.rep <- AvgN(data, Cell_info, seed=1)
          saveLoom(avg20.rep,paste(filea,"result/Scenic/mid_old/avg20_rep.loom",sep = ""))
          saveRDS(Cell_info,paste(filea,"result/Scenic/mid_old/Cell_info.rds",sep = ""))
          loom <- build_loom(paste(filea,"result/Scenic/mid_old/s1_exprMat.loom",sep = ""), dgem=data)
          loom <- add_cellAnnotation(loom, Cell_info)
          close_loom(loom)
        }
        
    }
    {
      ###环境
      conda env list
      conda activate scenic_protocol 
      ## 安装其它包
      cd /data/HCB/aging/oesophagus/result/Scenic/mid_old/
      bash "/data/HCB/aging/s2_runPySCENIC.sh" avg20_rep
      cp "/data/HCB/aging/s3_postSCENIC.py" /data/HCB/aging/oesophagus/result/Scenic/mid_old/
        bash "/data/HCB/aging/s3_postSCENIC.sh"
      
      R
      {
        options(stringsAsFactors = FALSE)
        library(data.table)
        library(pbapply)
        library(philentropy)
        library(ggrepel)
        library(latex2exp)
        library(ggplot2)
        library(plyr)
        library(ggsci)
        cell.info <- readRDS("Cell_info.rds")
        rasMat <- fread("output/s3_avg20_rep.AUCell.txt", sep = "\t", header = T, data.table = F) # data.frame
        rownames(rasMat) <- rasMat$V1
        colnames(rasMat) <- sub("(+)", "", colnames(rasMat), fixed = T)
        rasMat <- rasMat[, -1]
        saveRDS(rasMat, "output/s5_avg20_rep.rasMat.rds")
        cell.types <- names(table(cell.info$Cell_Type))
        ctMat <- lapply(cell.types, function(i) {
          as.numeric(cell.info$Cell_Type == i)
        })
        ctMat <- do.call(cbind, ctMat)
        colnames(ctMat) <- cell.types
        rownames(ctMat) <- rownames(cell.info)
        rssMat <- pblapply(colnames(rasMat), function(i) {
          sapply(colnames(ctMat), function(j) {
            1 - JSD(rbind(rasMat[, i], ctMat[, j]), unit = 'log2', est.prob = "empirical")
          })
        })
        rssMat <- do.call(rbind, rssMat)
        rownames(rssMat) <- colnames(rasMat)
        colnames(rssMat) <- colnames(ctMat)
        write.table(rssMat,"./output/rssMat.txt")
        q()
      }
      
      conda deactivate
      
    }
  }
  
  ##hTFtarget
  {
    tf <- read.table("/data/HCB/aging/tf-target-infomation.txt",sep="\t",header=T)
    tf <- tf[,-3]
    
    filea <- "/data/HCB/aging/oesophagus/result/"
    if(!dir.exists(paste(filea,"hTFTarget/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"hTFTarget/mid-old/",sep = ""))){
      dir.create(paste(filea,"hTFTarget/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- intersect(rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))],gene_overlap)
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"hTFTarget/mid-old/",temp[i,3],"_hTFtargets.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ##TRRUST2
  {
    tf <- read.csv("/data/HCB/aging/TRRUST2.csv",header=T)
    tf <- tf[which(tf[,1]%in%gene_overlap),]
    filea <- "/data/HCB/aging/oesophagus/result/"
    if(!dir.exists(paste(filea,"TRRUST2/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/",sep = ""))
    }
    ##############mid-old
    if(!dir.exists(paste(filea,"TRRUST2/mid-old/",sep = ""))){
      dir.create(paste(filea,"TRRUST2/mid-old/",sep = ""))
    }
    {
      setwd(paste(filea,"DEG/mid-old/",sep = ""))
      filenames <- list.files()
      temp <- as.data.frame(array(NA,dim = c(length(filenames),3)))
      temp[,1] <- filenames
      for (i in 1:length(filenames)) {
        temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        temp[i,3] <-strsplit(x=temp[i,1],split='[_]')[[1]][1]
      }
      temp <- temp[which(temp[,2]=="txt"),]
      for (i in 1:length(rownames(temp))) {
        ID <- read.table(temp[i,1])
        Up_ID <- rownames(ID)[which(ID[,'change']%in% c("UP","DOWN"))]
        a <- tf[which(tf[,1]%in%Up_ID),]
        write.table(a,paste(filea,"TRRUST2/mid-old/",temp[i,3],"_TRRUST2.txt",sep = ""),row.names = F)
      }
    }
    
  }
  
  ####scenic富集分析
  {
    library(ggplot2)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    
    filea <- "/data/HCB/aging/oesophagus/"
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/",sep = ""))
    }
    #############mid_old
    if(!dir.exists(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))){
      dir.create(paste(filea,"result/Scenic_enrichment/mid_old/",sep = ""))
    }
    {
      tfs <- read.table(paste(filea,"result/Scenic/mid_old/output/s3_avg20_rep.regulons.txt",sep=""))
      for (i in 1:dim(tfs)[1]) {
        gene <- strsplit(x=as.character(tfs[i,3]),split=',')[[1]]
        if(length(gene)>5){
          eGo_ALL <- enrichGO(gene,"org.Hs.eg.db",keyType="SYMBOL",ont="ALL")
          if(length(rownames(as.data.frame(eGo_ALL@result)))>0){
            write.csv(as.data.frame(eGo_ALL@result), file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL.csv",sep = ""),row.names=F)
            png(file= paste(filea,"result/Scenic_enrichment/mid_old/_",tfs[i,1],"_eGO_ALL_Enrichment.png",sep = ""),width = 500,height = 500)
            p <- dotplot(eGo_ALL,showCategory= min(10,length(rownames(as.data.frame(eGo_ALL@result)))), orderBy="Description", font.size=8,x="p.adjust")  + 
              theme(axis.text.y = element_text(size = 15,color = "black"),axis.text.x = element_text(size = 15,color = "black"),axis.title.x =element_text(size=15))
            print(p)
            dev.off()
          }
        }
      }
    }
    
    
  }
  
  #####衰老数据库
  {
    CSGene <- read.csv("/data03/HCB/aging/aging-database/csgene_human.csv")
    CellAge <- read.csv("/data03/HCB/aging/aging-database/genage_human.csv")
    HCSGD <- read.csv("/data03/HCB/aging/aging-database/hg.csv")
    temp <- union(CSGene[,2],CellAge[,2])
    temp <- union(temp,HCSGD[,1])
    AgeData <- as.data.frame(array("No",dim=c(length(temp),4)))
    colnames(AgeData) <- c("Gene","CSGene","CellAge","HCSGD")
    AgeData[,1] <- temp
    for (i in 1:length(temp)) {
      if(AgeData[i,1]%in%CSGene[,2]){
        AgeData[i,2] = "Yes"
      }
      if(AgeData[i,1]%in%CellAge[,2]){
        AgeData[i,3] = "Yes"
      }
      if(AgeData[i,1]%in%HCSGD[,1]){
        AgeData[i,4] = "Yes"
      }
    }
    write.csv(AgeData,"/data03/HCB/aging/aging-database/AgeData.csv",row.names=F)
    
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/oesophagus/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    {
      ########mid-old
      {
        setwd(paste(filea,"result/DEG/mid-old",sep = ""))
        filenames <- list.files()
        temp <- as.data.frame(array(NA,dim = c(length(filenames),2)))
        temp[,1] <- filenames
        for (i in 1:length(filenames)) {
          temp[i,2] <-strsplit(x=temp[i,1],split='[.]')[[1]][2]
        }
        temp <- temp[which(temp[,2]=="txt"),]
        for (i in 1:dim(temp)[1]) {
          if(i==1){
            deg <- read.table(temp[i,1])
            gene_temp <- rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))]
          }
          deg <- read.table(temp[i,1])
          gene_temp <-  c(gene_temp,rownames(deg)[which(deg[,"change"]%in%c("UP","DOWN"))])
          gene_temp <- unique(gene_temp)
        }
      }
    }
    gene_temp <- intersect(gene_temp,AgeData[,1])
    result <- scRNA@meta.data[,c("group","ident")] 
    result <- cbind(result,scRNA@reductions$umap@cell.embeddings)  
    result <- cbind(result,t(scRNA@assays$RNA@data[gene_temp,]))  
    
    if(!dir.exists(paste(filea,"result/database_web/",sep = ""))){
      dir.create(paste(filea,"result/database_web/",sep = ""))
    }
    write.csv(result,paste(filea,"result/database_web/oesophagus.csv",sep = ""))
    
  }
  
  ########markerc差异表达
  {
    library(ggplot2)
    library(cowplot)
    library(Matrix)
    library(dplyr)
    library(readr)
    library(Seurat)
    library(harmony)
    library(tidyverse)
    library(patchwork)
    library(patchwork)
    library(lemon)
    library(MAST)
    
    filea <- "/data/HCB/aging/oesophagus/"
    scRNA <- readRDS(paste(filea,"scRNA4.rds",sep=""))
    
    if(!dir.exists(paste(filea,"result/makerDEG/",sep=""))){
      dir.create(paste(filea,"result/makerDEG/",sep=""))
    }
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/oesophagus.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    
    a <- FindAllMarkers(scRNA,test.use = "MAST",min.pct=0.1,only.pos = FALSE,logfc.threshold=0)
    gene <- cbind(gene,array(NA,dim=c(dim(gene)[1],5)))
    colnames(gene)[3:7] <- c('p_val','avg_log2FC','pct.1','pct.2','p_val_adj')
    for (i in 1:dim(gene)[1]) {
      temp <- a[which(a[,6]==gene[i,1]&a[,7]==gene[i,2]),c(1,2,3,4,5)]
      if(dim(temp)[1]==1){
        gene[i,3:7] <- temp[1:5]
      }
    }
    length(unique(gene[which(is.na(gene[,4])==FALSE),1]))==length(celltype)
    
    gene <- gene[which(is.na(gene[,4])==FALSE),]
    write.csv(gene,paste(filea,"result/makerDEG/markerDEG.csv",sep=""),row.names=F)
  }
  
  ###########统计细胞数量
  {
    fileb <- "/data/HCB/aging/oesophagus/"
    
    scRNA <- readRDS(paste(fileb,"scRNA4.rds",sep=""))
    
    celltype <- unique(scRNA@meta.data[,"ident"])
    gene <- read.csv("/data/HCB/aging/marker/oesophagus.csv")
    gene <- gene[,c(1,3)]
    colnames(gene) <- c("Cell Type","Marker Gene")
    gene[,1] %in%celltype
    celltype%in%gene[,1]
    res <- as.data.frame(array(NA,dim=c(length(celltype)+1,6)))
    rownames(res) <- c(celltype,"COUNT")
    colnames(res) <- c("cell_number","marker_number","youth","mid","old","supold")
    g <- unique(scRNA@meta.data[,"group"])
    for (i in 1:length(celltype)) {
      res[i,1] <- length(which(scRNA@meta.data[,"ident"]==celltype[i]))
      res[i,2] <- length(which(gene[,1]==celltype[i]))
      for(t in g){
        res[i,t] <- length(which(scRNA@meta.data[,"ident"]==celltype[i] & scRNA@meta.data[,"group"]==t))
      }
    }
    res <- res[,c("cell_number","marker_number",g)]
    for(i in colnames(res)){
      res[length(celltype)+1,i] <- sum(res[1:length(celltype),i])
    }
    
    write.csv(res,"/data/HCB/aging/cell_number/oesophagus.csv")
  }
  
}





####################deal
